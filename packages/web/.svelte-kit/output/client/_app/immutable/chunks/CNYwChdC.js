var xg=Object.defineProperty;var _d=e=>{throw TypeError(e)};var Mg=(e,t,n)=>t in e?xg(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var v=(e,t,n)=>Mg(e,typeof t!="symbol"?t+"":t,n),Wu=(e,t,n)=>t.has(e)||_d("Cannot "+n);var r=(e,t,n)=>(Wu(e,t,"read from private field"),n?n.call(e):t.get(e)),h=(e,t,n)=>t.has(e)?_d("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),d=(e,t,n,s)=>(Wu(e,t,"write to private field"),s?s.call(e,n):t.set(e,n),n),p=(e,t,n)=>(Wu(e,t,"access private method"),n);var yn=(e,t,n,s)=>({set _(i){d(e,t,i,n)},get _(){return r(e,t,s)}});import{aK as Ng,u as Yp,m as Zp,h as Rg,G as Hr,aL as Og,j as Lr,D as Tg,aa as Pg,f as em,a9 as Xc,aM as Hg,w as tm}from"./DXlRHvn5.js";import{v as Lg,c as nm,a as sm}from"./DqkJwZYL.js";import"./9xNfiEXT.js";import{I as im,b as rm}from"./BQ3ExOcy.js";import{l as om,s as am,a as Ar}from"./BdB0C_9E.js";function kx(e,t,n=t){var s=Ng();Lg(e,"input",i=>{var o=i?e.defaultValue:e.value;if(o=Xu(e)?Yu(o):o,n(o),s&&o!==(o=t())){var a=e.selectionStart,c=e.selectionEnd;e.value=o??"",c!==null&&(e.selectionStart=a,e.selectionEnd=Math.min(c,e.value.length))}}),(Rg&&e.defaultValue!==e.value||Yp(t)==null&&e.value)&&n(Xu(e)?Yu(e.value):e.value),Zp(()=>{var i=t();Xu(e)&&i===Yu(e.value)||e.type==="date"&&!i&&!e.value||i!==e.value&&(e.value=i??"")})}function Xu(e){var t=e.type;return t==="number"||t==="range"}function Yu(e){return e===""?null:+e}function Ag(e){Hr(e,e.v+1)}function Fg(e){let t=0,n=Tg(0),s;return()=>{Og()&&(Lr(n),Zp(()=>(t===0&&(s=Yp(()=>e(()=>Ag(n)))),t+=1,()=>{Pg().then(()=>{t-=1,t===0&&(s==null||s(),s=void 0)})})))}}function Ix(e,t){const n=om(t,["children","$$slots","$$events","$$legacy"]);im(e,am({name:"share-2"},()=>n,{iconNode:[["circle",{cx:"18",cy:"5",r:"3"}],["circle",{cx:"6",cy:"12",r:"3"}],["circle",{cx:"18",cy:"19",r:"3"}],["line",{x1:"8.59",x2:"15.42",y1:"13.51",y2:"17.49"}],["line",{x1:"15.41",x2:"8.59",y1:"6.51",y2:"10.49"}]],children:(i,o)=>{var a=nm(),c=em(a);rm(c,t,"default",{}),sm(i,a)},$$slots:{default:!0}}))}function Cx(e,t){const n=om(t,["children","$$slots","$$events","$$legacy"]);im(e,am({name:"x"},()=>n,{iconNode:[["path",{d:"M18 6 6 18"}],["path",{d:"m6 6 12 12"}]],children:(i,o)=>{var a=nm(),c=em(a);rm(c,t,"default",{}),sm(i,a)},$$slots:{default:!0}}))}const $g="https://zchat-zero.grbn.dev";var Vg=Object.prototype.hasOwnProperty,ls=Object.hasOwn||((e,t)=>Vg.call(e,t));function Pe(e,t){const n=e.length,s=t.length,i=Math.min(n,s);for(let o=0;o<i;){const a=e.codePointAt(o),c=t.codePointAt(o);if(a!==c){if(a<128&&c<128)return a-c;const u=Nd(a,xd),l=Nd(c,Md);return Gg(xd,u,Md,l)}o+=jg(a)}return n-s}function Gg(e,t,n,s){const i=Math.min(t,s);for(let o=0;o<i;o++){const a=e[o],c=n[o];if(a!==c)return a-c}return t-s}function jg(e){return e>65535?2:1}const cm=()=>Array.from({length:4},()=>0),xd=cm(),Md=cm();function Nd(e,t){if(e<128)return t[0]=e,1;let n,s;if(e<=2047)n=1,s=192;else if(e<=65535)n=2,s=224;else if(e<=1114111)n=3,s=240;else throw new Error("Invalid code point");t[0]=(e>>6*n)+s;let i=1;for(;n>0;n--){const o=e>>6*(n-1);t[i++]=128|o&63}return i}function Gl(e,t){return Pe(e,t)>0}function Zu(e,t){return Pe(e,t)<0}function eh(e,t){return Pe(e,t)<=0}function g(e,t="Assertion failed"){if(!e){const n=typeof t=="string"?t:t();throw new Error(n)}}function j(e){Nu(e,"string")}function He(e){Nu(e,"number")}function zg(e){Nu(e,"boolean")}function Nu(e,t){typeof e!==t&&jl(e,t)}function ee(e){e===null&&jl(e,"object"),Nu(e,"object")}function dn(e){Array.isArray(e)||jl(e,"array")}function Bg(e,t){let n="Invalid type: ";return e==null?n+=e:n+=`${typeof e} \`${e}\``,n+`, expected ${t}`}function jl(e,t){throw new Error(Bg(e,t))}function Kg(e){if(e===null)throw new Error("Expected non-null value")}function Ug(e,t="Expected undefined value"){if(e!==void 0)throw new Error(t)}function me(e){throw new Error("Unreachable")}function $(e,t){if(e==null)throw new Error(t??`Unexpected ${e} value`);return e}function zl(e,t){if(e=vh(e),t=vh(t),e===t)return 0;if(e===null)return-1;if(t===null)return 1;if(typeof e=="boolean")return zg(t),e?1:-1;if(typeof e=="number")return He(t),e-t;if(typeof e=="string")return j(t),Pe(e,t);throw new Error(`Unsupported type: ${e}`)}function vh(e){return e??null}function qg(e,t){return(n,s)=>{for(const i of e){const o=i[0],a=zl(n[o],s[o]);if(a!==0)return i[1]==="asc"?a:-a}return 0}}function um(e,t){return e==null||t==null?!1:e===t}function Ru(e){for(const t of Object.values(e.relationships))for(const n of t())Ru(n)}function ks(e,t,n,s,i){if(n.isHidden)switch(t.type){case"add":case"remove":for(const[c,u]of Object.entries(t.node.relationships)){const l=$(n.relationships[c]);for(const m of u())ks(e,{type:t.type,node:m},l,c,i)}return;case"edit":return;case"child":{const c=$(n.relationships[t.child.relationshipName]);ks(e,t.child.change,c,s,i);return}default:me()}const{singular:o,relationships:a}=i;switch(t.type){case"add":{const c={...t.node.row};if(o)Ug(e[s],"single output already exists"),e[s]=c;else{const u=th(e,s),{pos:l,found:m}=ws(u,c,n.compareRows);g(!m,"node already exists"),u.splice(l,0,c)}for(const[u,l]of Object.entries(t.node.relationships)){const m=$(n.relationships[u]),y=a[u];if(y===void 0)continue;const w=y.singular?void 0:[];c[u]=w;for(const b of l())ks(c,{type:"add",node:b},m,u,y)}break}case"remove":{if(o)ee(e[s]),e[s]=void 0;else{const c=th(e,s),{pos:u,found:l}=ws(c,t.node.row,n.compareRows);g(l,"node does not exist"),c.splice(u,1)}Ru(t.node);break}case"child":{let c;if(o)ee(e[s]),c=e[s];else{const m=th(e,s),{pos:y,found:w}=ws(m,t.node.row,n.compareRows);g(w,"node does not exist"),c=m[y]}const u=$(n.relationships[t.child.relationshipName]),l=i.relationships[t.child.relationshipName];l!==void 0&&ks(c,t.child.change,u,t.child.relationshipName,l);break}case"edit":{if(o)ee(e[s]),e[s]={...e[s],...t.node.row};else{const c=e[s];if(dn(c),n.compareRows(t.oldNode.row,t.node.row)===0){const{pos:u,found:l}=ws(c,t.oldNode.row,n.compareRows);g(l,"node does not exists"),c[u]=Rd(t.node.row,c[u],n.relationships)}else{const{pos:u,found:l}=ws(c,t.oldNode.row,n.compareRows);g(l,"node does not exists");const m=c[u];c.splice(u,1);{const{pos:y,found:w}=ws(c,t.node.row,n.compareRows);g(!w,"node already exists"),c.splice(y,0,Rd(t.node.row,m,n.relationships))}}}break}default:me()}}function ws(e,t,n){let s=0,i=e.length-1;for(;s<=i;){const o=s+i>>>1,a=n(e[o],t);if(a<0)s=o+1;else if(a>0)i=o-1;else return{pos:o,found:!0}}return{pos:s,found:!1}}function Rd(e,t,n){const s={...e};for(const i in n)g(!(i in e),"Relationship already exists"),s[i]=t[i];return s}function th(e,t){const n=e[t];return dn(n),n}var hm=Object.defineProperty,Qg=Object.getOwnPropertyDescriptor,Jg=Object.getOwnPropertyNames,Wg=Object.prototype.hasOwnProperty,Xg=(e,t)=>{for(var n in t)hm(e,n,{get:t[n],enumerable:!0})},Yg=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Jg(t))!Wg.call(e,i)&&i!==n&&hm(e,i,{get:()=>t[i],enumerable:!(s=Qg(t,i))||s.enumerable});return e},Zg=(e,t,n)=>(Yg(e,t,"default"),n);function A(){let e,t;return{promise:new Promise((s,i)=>{e=s,t=i}),resolve:e,reject:t}}function Is(e,t){return e?{ok:!1,code:"join",left:e,right:t}:t}function Ds(e,t){return{ok:!1,code:"prepend",key:e,tree:t}}function eS(e,t){const n=e.code;switch(n){case"invalid_type":return{code:n,path:t,expected:e.expected};case"invalid_literal":return{code:n,path:t,expected:e.expected};case"missing_value":return{code:n,path:t};case"invalid_length":return{code:n,path:t,minLength:e.minLength,maxLength:e.maxLength};case"unrecognized_keys":return{code:n,path:t,keys:e.keys};case"invalid_union":return{code:n,path:t,tree:e.tree};default:return{code:n,path:t,error:e.error}}}function Bl(e,t=[],n=[]){for(;;)if(e.code==="join")Bl(e.left,t.slice(),n),e=e.right;else if(e.code==="prepend")t.push(e.key),e=e.tree;else return e.code==="custom_error"&&typeof e.error=="object"&&e.error.path!==void 0&&t.push(...e.error.path),n.push(eS(e,t)),n}function nh(e,t){return e.length===0?"nothing":e.length===1?e[0]:`${e.slice(0,-1).join(", ")} ${t} ${e[e.length-1]}`}function Od(e){return typeof e=="bigint"?`${e}n`:JSON.stringify(e)}function lm(e){let t=0;for(;;)if(e.code==="join")t+=lm(e.left),e=e.right;else if(e.code==="prepend")e=e.tree;else return t+1}function dm(e){let t="",n=0;for(;;)if(e.code==="join")n+=lm(e.right),e=e.left;else if(e.code==="prepend")t+="."+e.key,e=e.tree;else break;let s="validation failed";if(e.code==="invalid_type")s=`expected ${nh(e.expected,"or")}`;else if(e.code==="invalid_literal")s=`expected ${nh(e.expected.map(Od),"or")}`;else if(e.code==="missing_value")s="missing value";else if(e.code==="unrecognized_keys"){const o=e.keys;s=`unrecognized ${o.length===1?"key":"keys"} ${nh(o.map(Od),"and")}`}else if(e.code==="invalid_length"){const o=e.minLength,a=e.maxLength;s="expected an array with ",o>0?a===o?s+=`${o}`:a!==void 0?s+=`between ${o} and ${a}`:s+=`at least ${o}`:s+=`at most ${a}`,s+=" item(s)"}else if(e.code==="custom_error"){const o=e.error;typeof o=="string"?s=o:o!==void 0&&(o.message!==void 0&&(s=o.message),o.path!==void 0&&(t+="."+o.path.join(".")))}let i=`${e.code} at .${t.slice(1)} (${s})`;return n===1?i+=" (+ 1 other issue)":n>1&&(i+=` (+ ${n} other issues)`),i}class Ou extends Error{constructor(t){super(dm(t)),this.issueTree=t,Object.setPrototypeOf(this,new.target.prototype),this.name=new.target.name,this._issues=void 0}get issues(){return this._issues===void 0&&(this._issues=Bl(this.issueTree)),this._issues}}class fm{constructor(t){this.issueTree=t,this.ok=!1,this._issues=void 0,this._message=void 0}get issues(){return this._issues===void 0&&(this._issues=Bl(this.issueTree)),this._issues}get message(){return this._message===void 0&&(this._message=dm(this.issueTree)),this._message}throw(){throw new Ou(this.issueTree)}}function ec(e){return{ok:!0,value:e}}function tS(e){return new fm({ok:!1,code:"custom_error",error:e})}function pm(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const Fr=1,$r=2,Vr=4;let mm=class{optional(t){const n=new sS(this);return t?new Tt(n,s=>s===void 0?{ok:!0,value:t()}:void 0):n}default(t){const n=ec(t);return new Tt(this.optional(),s=>s===void 0?n:void 0)}assert(t,n){const s={ok:!1,code:"custom_error",error:n};return new Tt(this,(i,o)=>t(i,o)?void 0:s)}map(t){return new Tt(this,(n,s)=>({ok:!0,value:t(n,s)}))}chain(t){return new Tt(this,(n,s)=>{const i=t(n,s);return i.ok?i:i.issueTree})}};class ye extends mm{nullable(){return new nS(this)}toTerminals(t){t(this)}try(t,n){let s=Fr;(n==null?void 0:n.mode)==="passthrough"?s=0:(n==null?void 0:n.mode)==="strip"&&(s=$r);const i=this.func(t,s);return i===void 0?{ok:!0,value:t}:i.ok?{ok:!0,value:i.value}:new fm(i)}parse(t,n){let s=Fr;(n==null?void 0:n.mode)==="passthrough"?s=0:(n==null?void 0:n.mode)==="strip"&&(s=$r);const i=this.func(t,s);if(i===void 0)return t;if(i.ok)return i.value;throw new Ou(i)}}class nS extends ye{constructor(t){super(),this.type=t,this.name="nullable"}func(t,n){return t===null?void 0:this.type.func(t,n)}toTerminals(t){t(Sm),this.type.toTerminals(t)}nullable(){return this}}class sS extends mm{constructor(t){super(),this.type=t,this.name="optional"}func(t,n){return t===void 0||n&Vr?void 0:this.type.func(t,n)}toTerminals(t){t(this),t(gm),this.type.toTerminals(t)}optional(t){return t?new Tt(this,n=>n===void 0?{ok:!0,value:t()}:void 0):this}}function ym(e,t){if(typeof e!="number"){const n=t>>5;for(let s=e.length;s<=n;s++)e.push(0);return e[n]|=1<<t%32,e}else return t<32?e|1<<t:ym([e,0],t)}function vr(e,t){return typeof e=="number"?t<32?e>>>t&1:0:e[t>>5]>>>t%32&1}class ft extends ye{constructor(t,n,s){super(),this.shape=t,this.restType=n,this.checks=s,this.name="object",this._invalidType={ok:!1,code:"invalid_type",expected:["object"]}}check(t,n){var s;const i={ok:!1,code:"custom_error",error:n};return new ft(this.shape,this.restType,[...(s=this.checks)!==null&&s!==void 0?s:[],{func:t,issue:i}])}func(t,n){if(!pm(t))return this._invalidType;let s=this._func;return s===void 0&&(s=iS(this.shape,this.restType,this.checks),this._func=s),s(t,n)}rest(t){return new ft(this.shape,t)}extend(t){return new ft(Object.assign(Object.assign({},this.shape),t),this.restType)}pick(...t){const n={};return t.forEach(s=>{n[s]=this.shape[s]}),new ft(n,void 0)}omit(...t){const n=Object.assign({},this.shape);return t.forEach(s=>{delete n[s]}),new ft(n,this.restType)}partial(){var t;const n={};Object.keys(this.shape).forEach(i=>{n[i]=this.shape[i].optional()});const s=(t=this.restType)===null||t===void 0?void 0:t.optional();return new ft(n,s)}}function iS(e,t,n){const s=[],i=[];for(const w in e){let b=!1;e[w].toTerminals(C=>{b||(b=C.name==="optional")}),b?i.push(w):s.push(w)}const o=[...s,...i],a=o.length;if(a===0&&(t==null?void 0:t.name)==="unknown")return function(w,b){if(n!==void 0){for(let C=0;C<n.length;C++)if(!n[C].func(w))return n[C].issue}};const c=o.map(w=>e[w]),u=s.length,l=Object.create(null);o.forEach((w,b)=>{l[w]=~b});const m=s.map(w=>Ds(w,{ok:!1,code:"missing_value"}));function y(w,b,C){b==="__proto__"?Object.defineProperty(w,b,{value:C,writable:!0,enumerable:!0,configurable:!0}):w[b]=C}return function(w,b){let C=!1,k=w,S,I,D=0,N=0;if(b&Fr||b&$r||t!==void 0)for(const x in w){const T=w[x],E=~l[x];let O;if(E>=0)N++,D=ym(D,E),O=c[E].func(T,b);else if(t!==void 0)O=t.func(T,b);else{if(b&Fr)I===void 0?I=[x]:I.push(x);else if(b&$r&&S===void 0&&!C){k={},C=!0;for(let H=0;H<a;H++)if(vr(D,H)){const P=o[H];y(k,P,w[P])}}continue}if(O===void 0)C&&S===void 0&&y(k,x,T);else if(!O.ok)S=Is(S,Ds(x,O));else if(S===void 0){if(!C)if(k={},C=!0,t===void 0){for(let H=0;H<a;H++)if(H!==E&&vr(D,H)){const P=o[H];y(k,P,w[P])}}else for(const H in w)y(k,H,w[H]);y(k,x,O.value)}}if(N<a)for(let x=0;x<a;x++){if(vr(D,x))continue;const T=o[x],E=w[T];let O=b&-5;if(E===void 0&&!(T in w)){if(x<u){S=Is(S,m[x]);continue}O|=Vr}const H=c[x].func(E,O);if(H===void 0)C&&S===void 0&&!(O&Vr)&&y(k,T,E);else if(!H.ok)S=Is(S,Ds(T,H));else if(S===void 0){if(!C)if(k={},C=!0,t===void 0){for(let P=0;P<a;P++)if(P<x||vr(D,P)){const xe=o[P];y(k,xe,w[xe])}}else{for(const P in w)y(k,P,w[P]);for(let P=0;P<x;P++)if(!vr(D,P)){const xe=o[P];y(k,xe,w[xe])}}y(k,T,H.value)}}if(I!==void 0&&(S=Is(S,{ok:!1,code:"unrecognized_keys",keys:I})),S===void 0&&n!==void 0){for(let x=0;x<n.length;x++)if(!n[x].func(k))return n[x].issue}return S===void 0&&C?{ok:!0,value:k}:S}}class Es extends ye{constructor(t,n,s){super(),this.prefix=t,this.rest=n,this.suffix=s,this.name="array",this.restType=n??vm(),this.minLength=this.prefix.length+this.suffix.length,this.maxLength=n?void 0:this.minLength,this.invalidType={ok:!1,code:"invalid_type",expected:["array"]},this.invalidLength={ok:!1,code:"invalid_length",minLength:this.minLength,maxLength:this.maxLength}}func(t,n){var s;if(!Array.isArray(t))return this.invalidType;const i=t.length,o=this.minLength,a=(s=this.maxLength)!==null&&s!==void 0?s:1/0;if(i<o||i>a)return this.invalidLength;const c=this.prefix.length,u=t.length-this.suffix.length;let l,m=t;for(let y=0;y<t.length;y++){const b=(y<c?this.prefix[y]:y>=u?this.suffix[y-u]:this.restType).func(t[y],n);b!==void 0&&(b.ok?(m===t&&(m=t.slice()),m[y]=b.value):l=Is(l,Ds(y,b)))}return l||(t===m?void 0:{ok:!0,value:m})}concat(t){if(this.rest){if(t.rest)throw new TypeError("can not concatenate two variadic types");return new Es(this.prefix,this.rest,[...this.suffix,...t.prefix,...t.suffix])}else return t.rest?new Es([...this.prefix,...this.suffix,...t.prefix],t.rest,t.suffix):new Es([...this.prefix,...this.suffix,...t.prefix,...t.suffix],t.rest,t.suffix)}}function Yc(e){const t=typeof e;return t!=="object"?t:e===null?"null":Array.isArray(e)?"array":t}function gr(e){return Array.from(new Set(e))}function rS(e){const t=new Map;e.forEach(s=>{for(const i in s)t.set(i,(t.get(i)||0)+1)});const n=[];return t.forEach((s,i)=>{s===e.length&&n.push(i)}),n}function wm(e){const t=new Map,n=new Map,s=new Map,i=[],o=[],a=[];e.forEach(({root:u,terminal:l})=>{var m;if(t.set(u,(m=t.get(u))!==null&&m!==void 0?m:t.size),l.name!=="never")if(l.name==="optional")o.push(u);else if(l.name==="unknown")i.push(u);else if(l.name==="literal"){const y=n.get(l.value)||[];y.push(u),n.set(l.value,y),a.push(Yc(l.value))}else{const y=s.get(l.name)||[];y.push(u),s.set(l.name,y),a.push(l.name)}}),n.forEach((u,l)=>{const m=s.get(Yc(l));m&&(m.push(...u),n.delete(l))});const c=(u,l)=>{var m,y;return((m=t.get(u))!==null&&m!==void 0?m:0)-((y=t.get(l))!==null&&y!==void 0?y:0)};return s.forEach((u,l)=>s.set(l,gr(u.concat(i).sort(c)))),n.forEach((u,l)=>n.set(l,gr(u.concat(i)).sort(c))),{types:s,literals:n,unknowns:gr(i).sort(c),optionals:gr(o).sort(c),expectedTypes:gr(a)}}function oS(e,t){const n=[];for(const{root:w,terminal:b}of e)b.shape[t].toTerminals(C=>n.push({root:w,terminal:C}));const{types:s,literals:i,optionals:o,unknowns:a,expectedTypes:c}=wm(n);if(a.length>0||o.length>1)return;for(const w of i.values())if(w.length>1)return;for(const w of s.values())if(w.length>1)return;const u=Ds(t,{ok:!1,code:"missing_value"}),l=Ds(t,s.size===0?{ok:!1,code:"invalid_literal",expected:Array.from(i.keys())}:{ok:!1,code:"invalid_type",expected:c}),m=i.size>0?new Map:void 0;for(const[w,b]of i)m.set(w,b[0]);const y=s.size>0?{}:void 0;for(const[w,b]of s)y[w]=b[0];return function(w,b){var C;const k=w,S=k[t];if(S===void 0&&!(t in k))return o.length>0?o[0].func(k,b):u;const I=(C=y==null?void 0:y[Yc(S)])!==null&&C!==void 0?C:m==null?void 0:m.get(S);return I?I.func(k,b):l}}function aS(e){if(e.some(({terminal:s})=>s.name==="unknown"))return;const t=e.filter(s=>s.terminal.name==="object");if(t.length<2)return;const n=t.map(({terminal:s})=>s.shape);for(const s of rS(n)){const i=oS(t,s);if(i)return i}}function cS(e){const{expectedTypes:t,literals:n,types:s,unknowns:i,optionals:o}=wm(e),a=s.size===0&&i.length===0?{ok:!1,code:"invalid_literal",expected:Array.from(n.keys())}:{ok:!1,code:"invalid_type",expected:t},c=n.size>0?n:void 0,u=s.size>0?{}:void 0;for(const[l,m]of s)u[l]=m;return function(l,m){var y,w;let b;if(m&Vr?b=o:b=(w=(y=u==null?void 0:u[Yc(l)])!==null&&y!==void 0?y:c==null?void 0:c.get(l))!==null&&w!==void 0?w:i,!b)return a;let C=0,k=a;for(let S=0;S<b.length;S++){const I=b[S].func(l,m);if(I===void 0||I.ok)return I;k=C>0?Is(k,I):I,C++}return C>1?{ok:!1,code:"invalid_union",tree:k}:k}}class uS extends ye{constructor(t){super(),this.options=t,this.name="union"}toTerminals(t){this.options.forEach(n=>n.toTerminals(t))}func(t,n){let s=this._func;if(s===void 0){const i=[];this.options.forEach(c=>c.toTerminals(u=>{i.push({root:c,terminal:u})}));const o=cS(i),a=aS(i);a?s=function(c,u){return pm(c)?a(c,u):o(c,u)}:s=o,this._func=s}return s(t,n)}}const hS=Object.freeze({mode:"strict"}),lS=Object.freeze({mode:"strip"}),dS=Object.freeze({mode:"passthrough"});class Tt extends ye{constructor(t,n){super(),this.transformed=t,this.transform=n,this.name="transform",this.undef=ec(void 0),this.transformChain=void 0,this.transformRoot=void 0}func(t,n){let s=this.transformChain;if(!s){s=[];let c=this;for(;c instanceof Tt;)s.push(c.transform),c=c.transformed;s.reverse(),this.transformChain=s,this.transformRoot=c}let i=this.transformRoot.func(t,n);if(i!==void 0&&!i.ok)return i;let o;i!==void 0?o=i.value:n&Vr?(o=void 0,i=this.undef):o=t;const a=n&Fr?hS:n&$r?lS:dS;for(let c=0;c<s.length;c++){const u=s[c](o,a);if(u!==void 0){if(!u.ok)return u;o=u.value,i=u}}return i}toTerminals(t){this.transformed.toTerminals(t)}}class fS extends ye{constructor(t){super(),this.definer=t,this.name="lazy",this.recursing=!1}func(t,n){return this.type||(this.type=this.definer()),this.type.func(t,n)}toTerminals(t){if(!this.recursing)try{this.recursing=!0,this.type||(this.type=this.definer()),this.type.toTerminals(t)}finally{this.recursing=!1}}}class pS extends ye{constructor(){super(...arguments),this.name="never",this.issue={ok:!1,code:"invalid_type",expected:[]}}func(t,n){return this.issue}}const mS=new pS;function vm(){return mS}class yS extends ye{constructor(){super(...arguments),this.name="unknown"}func(t,n){}}const wS=new yS;function Kl(){return wS}class vS extends ye{constructor(){super(...arguments),this.name="undefined",this.issue={ok:!1,code:"invalid_type",expected:["undefined"]}}func(t,n){return t===void 0?void 0:this.issue}}const gm=new vS;function gS(){return gm}class SS extends ye{constructor(){super(...arguments),this.name="null",this.issue={ok:!1,code:"invalid_type",expected:["null"]}}func(t,n){return t===null?void 0:this.issue}}const Sm=new SS;function bS(){return Sm}class kS extends ye{constructor(){super(...arguments),this.name="number",this.issue={ok:!1,code:"invalid_type",expected:["number"]}}func(t,n){return typeof t=="number"?void 0:this.issue}}const IS=new kS;function CS(){return IS}class DS extends ye{constructor(){super(...arguments),this.name="bigint",this.issue={ok:!1,code:"invalid_type",expected:["bigint"]}}func(t,n){return typeof t=="bigint"?void 0:this.issue}}const ES=new DS;function _S(){return ES}class xS extends ye{constructor(){super(...arguments),this.name="string",this.issue={ok:!1,code:"invalid_type",expected:["string"]}}func(t,n){return typeof t=="string"?void 0:this.issue}}const MS=new xS;function bm(){return MS}class NS extends ye{constructor(){super(...arguments),this.name="boolean",this.issue={ok:!1,code:"invalid_type",expected:["boolean"]}}func(t,n){return typeof t=="boolean"?void 0:this.issue}}const RS=new NS;function OS(){return RS}class TS extends ye{constructor(t){super(),this.value=t,this.name="literal",this.issue={ok:!1,code:"invalid_literal",expected:[t]}}func(t,n){return t===this.value?void 0:this.issue}}function PS(e){return new TS(e)}function Ul(e){return new ft(e,void 0)}function km(e){return new ft({},e??Kl())}function Im(e){return new Es([],e??Kl(),[])}function HS(e){return new Es(e,void 0,[])}function LS(...e){return new uS(e)}function AS(e){return new fS(e)}const FS=Object.freeze(Object.defineProperty({__proto__:null,ValitaError:Ou,array:Im,bigint:_S,boolean:OS,err:tS,lazy:AS,literal:PS,never:vm,null:bS,number:CS,object:Ul,ok:ec,record:km,string:bm,tuple:HS,undefined:gS,union:LS,unknown:Kl},Symbol.toStringTag,{value:"Module"}));class Cm{constructor(t){this._sinks=t}log(t,n,...s){for(const i of this._sinks)i.log(t,n,...s)}async flush(){await Promise.all(this._sinks.map(t=>{var n;return(n=t.flush)==null?void 0:n.call(t)}))}}class $S{constructor(t,n="info",s){this.debug=void 0,this.info=void 0,this.warn=void 0,this.error=void 0;const i=o=>(...a)=>t.log(o,s,...a);switch(n){case"debug":this.debug=i("debug");case"info":this.info=i("info");case"warn":this.warn=i("warn");case"error":this.error=i("error")}this.flush=()=>{var o;return((o=t.flush)==null?void 0:o.call(t))??Promise.resolve()}}}const cn={log(e,t,...n){console[e](...VS(t),...n.map(GS))}};class Tu extends $S{constructor(t="info",n,s=cn){super(s,t,n),this._level=t,this._logSink=s,this._context=n}withContext(t,n){const s={...this._context,[t]:n};return new Tu(this._level,s,this._logSink)}}function VS(e){const t=[];for(const[n,s]of Object.entries(e??{})){const i=s===void 0?n:`${n}=${s}`;t.push(i)}return t}function GS(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":case"symbol":case"bigint":return e;case"object":if(e===null)return null;break}return JSON.stringify(e,jS)}function jS(e,t){return t instanceof Error?{name:t.name,message:t.message,stack:t.stack,..."cause"in t?{cause:t.cause}:null}:t}class tc{constructor(){v(this,"_lockP",null)}async lock(){const t=this._lockP,{promise:n,resolve:s}=A();return this._lockP=n,await t,s}withLock(t){return gh(this.lock(),t)}}class Dm{constructor(){v(this,"_lock",new tc);v(this,"_writeP",null);v(this,"_readP",[])}read(){return this._lock.withLock(async()=>{await this._writeP;const{promise:t,resolve:n}=A();return this._readP.push(t),n})}withRead(t){return gh(this.read(),t)}async write(){return await this._lock.withLock(async()=>{await this._writeP,await Promise.all(this._readP);const{promise:t,resolve:n}=A();return this._writeP=t,this._readP=[],n})}withWrite(t){return gh(this.write(),t)}}async function gh(e,t){const n=await e;try{return await t()}finally{n()}}const vs=2654435761,gs=2246822519,lc=3266489917,Td=668265263,Pd=374761393;let zS;function BS(e,t=0){const n=typeof e=="string"?(zS??(zS=new TextEncoder)).encode(e):e,s=n;let i=t+Pd&4294967295,o=0;if(s.length>=16){const c=[t+vs+gs&4294967295,t+gs&4294967295,t+0&4294967295,t-vs&4294967295],u=n,l=u.length-16;let m=0;for(o=0;(o&4294967280)<=l;o+=4){const y=o,w=u[y+0]+(u[y+1]<<8),b=u[y+2]+(u[y+3]<<8),C=w*gs+(b*gs<<16);let k=c[m]+C&4294967295;k=k<<13|k>>>19;const S=k&65535,I=k>>>16;c[m]=S*vs+(I*vs<<16)&4294967295,m=m+1&3}i=(c[0]<<1|c[0]>>>31)+(c[1]<<7|c[1]>>>25)+(c[2]<<12|c[2]>>>20)+(c[3]<<18|c[3]>>>14)&4294967295}i=i+n.length&4294967295;const a=n.length-4;for(;o<=a;o+=4){const c=o,u=s[c+0]+(s[c+1]<<8),l=s[c+2]+(s[c+3]<<8),m=u*lc+(l*lc<<16);i=i+m&4294967295,i=i<<17|i>>>15,i=(i&65535)*Td+((i>>>16)*Td<<16)&4294967295}for(;o<s.length;++o){const c=s[o];i=i+c*Pd,i=i<<11|i>>>21,i=(i&65535)*vs+((i>>>16)*vs<<16)&4294967295}return i=i^i>>>15,i=((i&65535)*gs&4294967295)+((i>>>16)*gs<<16),i=i^i>>>13,i=((i&65535)*lc&4294967295)+((i>>>16)*lc<<16),i=i^i>>>16,i<0?i+4294967296:i}async function Em(e,t,n,s){const i={headers:{"Content-type":"application/json",Authorization:t,"X-Replicache-RequestID":n},body:JSON.stringify(s),method:"POST"},o=new Request(e,i),a=await fetch(o),c=a.status;return c!==200?[void 0,{httpStatusCode:c,errorMessage:await a.text()}]:[a,{httpStatusCode:c,errorMessage:""}]}function ds(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;switch(typeof e){case"boolean":case"number":case"string":return!1}if(e=e,Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!ds(e[i],t[i]))return!1;return!0}if(e===null||t===null||Array.isArray(t))return!1;e=e,t=t;let n=0;for(const i in e)if(ls(e,i)){if(!ds(e[i],t[i]))return!1;n++}let s=0;for(const i in t)ls(t,i)&&s++;return n===s}function KS(e){}function _m(e){ee(e),US(e)}function US(e){for(const t in e)ls(e,t)&&e[t]}function xm(e,t){return e===t?0:e<t?-1:1}function ql(e,t){if(e===t)return 0;if(e===null)return-1;if(t===null)return 1;const n=Hd(e),s=Hd(t);return typeof n=="string"||typeof s=="string"?xm(String(n),String(s)):n-s}function Hd(e){return typeof e=="string"||typeof e=="number"?e:e.order}function Mm(e){if(!(e===null||typeof e=="string"||typeof e=="number")&&(_m(e),!(typeof e.order=="string"||typeof e.order=="number")))throw new Error("Invalid cookie")}function Nm(e,t){return typeof e=="object"&&e!==null&&e.error===t}function qS(e){return typeof e.error=="string"}function _s(e){return Nm(e,"ClientStateNotFound")}function xs(e){if(!Nm(e,"VersionNotSupported"))return!1;const{versionType:t}=e;switch(t){case void 0:case"pull":case"push":case"schema":return!0}return!1}function QS(e){g(xs(e))}function Rm(e){ee(e),He(e.httpStatusCode),j(e.errorMessage)}function JS(e){dn(e);for(const t of e)WS(t)}function WS(e){switch(ee(e),e.op){case"put":j(e.key),e.value;break;case"update":if(j(e.key),e.merge!==void 0&&_m(e.merge),e.constrain!==void 0){dn(e.constrain);for(const t of e.constrain)j(t)}break;case"del":j(e.key);break;case"clear":break;default:throw new Error(`unknown patch op \`${e.op}\`, expected one of \`put\`, \`del\`, \`clear\``)}}function XS(e){async function t(n,s){const[i,o]=await Em(e.pullURL,e.auth,s,n);return i?{response:await i.json(),httpRequestInfo:o}:{httpRequestInfo:o}}return Om.add(t),t}var Om=new WeakSet;function YS(e){return Om.has(e)}function ZS(e){if(ee(e),_s(e)||xs(e))return;const t=e;t.cookie!==void 0&&Mm(t.cookie),eb(t.lastMutationIDChanges),JS(t.patch)}function eb(e){ee(e);for(const[t,n]of Object.entries(e))j(t),He(n)}function tb(e){ee(e),Rm(e.httpRequestInfo),e.response!==void 0&&ZS(e.response)}function Dt(e){return globalThis[e]}function nb(e){var t;return(t=globalThis[e])==null?void 0:t.bind(globalThis)}function Ql(e){const t=Dt(e);if(t===void 0)throw new Error(`Unsupported JavaScript environment: Could not find ${e}.`);return t}var sb=Promise.resolve(!0),ib=Promise.resolve(!1);Promise.resolve(void 0);var ie=Promise.resolve();new Promise(()=>{});function Tm(e){if(e!==void 0)return e}var Or=Symbol(),Pt,qf,Pm=(qf=class{constructor(e){v(this,"_pending",new Map);h(this,Pt);d(this,Pt,e)}has(e){switch(this._pending.get(e)){case void 0:return r(this,Pt).has(e);case Or:return ib;default:return sb}}async get(e){const t=this._pending.get(e);switch(t){case Or:return;case void 0:{const n=await r(this,Pt).get(e);return Tm(n)}default:return t}}put(e,t){return this._pending.set(e,t),ie}del(e){return this._pending.set(e,Or),ie}release(){r(this,Pt).release()}get closed(){return r(this,Pt).closed}},Pt=new WeakMap,qf),rb={durability:"relaxed"},Pu="chunks",Ht,Ms,Ns,qr,Sh,Qf,Zc=(Qf=class{constructor(e){h(this,qr);h(this,Ht);h(this,Ms,!1);h(this,Ns,!1);d(this,Ht,ub(e))}read(){return p(this,qr,Sh).call(this,cb)}write(){return p(this,qr,Sh).call(this,ab)}async close(){r(this,Ns)||(await r(this,Ht)).close(),d(this,Ms,!0)}get closed(){return r(this,Ms)}},Ht=new WeakMap,Ms=new WeakMap,Ns=new WeakMap,qr=new WeakSet,Sh=async function(e){const t=async s=>{const{promise:i,resolve:o,reject:a}=A(),c=indexedDB.open(s);c.onupgradeneeded=()=>{const l=c.transaction;Kg(l),l.abort(),d(this,Ns,!0),a(new Ld(`Replicache IndexedDB not found: ${s}`))},c.onsuccess=()=>o(c.result),c.onerror=()=>a(c.error);const u=await i;return u.onversionchange=()=>u.close(),u},n=await r(this,Ht);try{return e(n)}catch(s){if(!r(this,Ms)&&s instanceof DOMException){if(s.name==="InvalidStateError"){d(this,Ht,t(n.name));const i=await r(this,Ht);return e(i)}else if(s.name==="NotFoundError")throw d(this,Ns,!0),Ql("indexedDB").deleteDatabase(n.name),new Ld(`Replicache IndexedDB ${n.name} missing object store. Deleting db.`)}throw s}},Qf),Rs,Qr,Jf,Hm=(Jf=class{constructor(e){h(this,Rs);h(this,Qr,!1);d(this,Rs,e)}has(e){return new Promise((t,n)=>{const s=bh(r(this,Rs)).count(e);s.onsuccess=()=>t(s.result>0),s.onerror=()=>n(s.error)})}get(e){return new Promise((t,n)=>{const s=bh(r(this,Rs)).get(e);s.onsuccess=()=>t(Tm(s.result)),s.onerror=()=>n(s.error)})}release(){d(this,Qr,!0)}get closed(){return r(this,Qr)}},Rs=new WeakMap,Qr=new WeakMap,Jf),Jr,Wr,Wf,ob=(Wf=class extends Pm{constructor(t){super(new Hm(t));h(this,Jr);h(this,Wr,!1);d(this,Jr,t)}commit(){return this._pending.size===0?ie:new Promise((t,n)=>{const s=r(this,Jr),i=bh(s);for(const[o,a]of this._pending)a===Or?i.delete(o):i.put(a,o);s.oncomplete=()=>t(),s.onerror=()=>n(s.error)})}release(){d(this,Wr,!0)}get closed(){return r(this,Wr)}},Jr=new WeakMap,Wr=new WeakMap,Wf);function ab(e){const t=e.transaction(Pu,"readwrite",rb);return new ob(t)}function cb(e){const t=e.transaction(Pu,"readonly");return new Hm(t)}function bh(e){return e.objectStore(Pu)}function ub(e){const t=Ql("indexedDB");return new Promise((n,s)=>{const i=t.open(e);i.onupgradeneeded=()=>{i.result.createObjectStore(Pu)},i.onsuccess=()=>{const o=i.result;o.onversionchange=()=>o.close(),n(o)},i.onerror=()=>s(i.error)})}var Ld=class extends Error{constructor(){super(...arguments);v(this,"name","IDBNotFoundError")}},hr=class extends Error{constructor(){super(...arguments);v(this,"name","AbortError")}},hb=Promise.resolve();new Promise(()=>{});function un(e,t){const n=()=>new hr("Aborted");return t!=null&&t.aborted?Promise.reject(n()):e===0?hb:new Promise((s,i)=>{let o;t&&(o=()=>{clearTimeout(a),i(n())},t.addEventListener("abort",o,{once:!0}));const a=setTimeout(()=>{s(),t==null||t.removeEventListener("abort",o)},e)})}function lb(e,t){const{promise:n,resolve:s}=A();return[new Promise(o=>{const a=()=>{clearTimeout(c),s()},c=setTimeout(()=>{o(),t.removeEventListener("abort",a)},e);t.addEventListener("abort",a,{once:!0})}),n]}function Hu(e,t,n,s,i){db(e,t,n,s,i)}async function db(e,t,n,s,i){var o,a,c,u,l;if(!i.aborted){for(s=s.withContext("bgIntervalProcess",e),(o=s.debug)==null||o.call(s,"Starting");!i.aborted;){try{await un(n(),i)}catch(m){if(!(m instanceof hr))throw m}if(!i.aborted){(a=s.debug)==null||a.call(s,"Running");try{await t()}catch(m){i.aborted?(c=s.debug)==null||c.call(s,"Error running most likely due to close.",m):(u=s.error)==null||u.call(s,"Error running.",m)}}}(l=s.debug)==null||l.call(s,"Stopping")}}function kh(){const e=Math.floor(Math.random()*4294967295),t=Math.floor(Math.random()*4294967295);return BigInt(e)<<32n|BigInt(t)}var f={};Xg(f,{assert:()=>nc,deepPartial:()=>Lm,instanceOfAbstractType:()=>vb,is:()=>pb,parse:()=>Et,readonly:()=>yb,readonlyArray:()=>_e,readonlyObject:()=>W,readonlyRecord:()=>sc,test:()=>Lu,testOptional:()=>mb});Zg(f,FS);function Ih(e){switch(typeof e){case"string":case"number":case"boolean":return JSON.stringify(e);case"undefined":return"undefined";case"bigint":return e.toString()+"n";default:return e===null?"null":Array.isArray(e)?"array":typeof e}}function sh(e,t){if(!(t!=null&&t.length))return Ih(e);let n=e;for(const s of t)n=n[s];return Ih(n)}function ih(e,t,n=s=>String(s)){if(t.length===1)return n(t[0]);const s=`${n(t[t.length-2])} ${e} ${n(t[t.length-1])}`;return t.length===2?s:`${t.slice(0,-2).map(n).join(", ")}, ${s}`}function Jl(e,t,n,s){var c;const i=e.issues[0],{path:o}=i,a=o!=null&&o.length?` at ${o.join(".")}`:"";switch(i.code){case"invalid_type":return`Expected ${ih("or",i.expected)}${a}. Got ${sh(t,o)}`;case"missing_value":{const u=o&&o.length>1?` at ${o.slice(0,-1).join(".")}`:"";return(c=i.path)!=null&&c.length?`Missing property ${i.path.at(-1)}${u}`:`TODO Unknown missing property${u}`}case"invalid_literal":return`Expected literal value ${ih("or",i.expected,Ih)}${a} Got ${sh(t,o)}`;case"invalid_length":return`Expected array with length ${i.minLength===i.maxLength?i.minLength:`between ${i.minLength} and ${i.maxLength}`}${a}. Got array with length ${t.length}`;case"unrecognized_keys":return i.keys.length===1?`Unexpected property ${i.keys[0]}${a}`:`Unexpected properties ${ih("and",i.keys)}${a}`;case"invalid_union":return n.name==="union"?fb(t,n,s??"strict"):`Invalid union value${a}`;case"custom_error":{const{error:u}=i;return`${u?typeof u=="string"?u:u.message??"unknown":"unknown"}${a}. Got ${sh(t,o)}`}}}function fb(e,t,n){const s=[];for(const i of t.options){const o=i.try(e,{mode:n});o.ok||s.push({type:i,err:o})}if(s.length&&(s.sort(Ad),s.length===1||Ad(s[0],s[1])<0))return Jl(s[0].err,e,s[0].type,n);try{return`Invalid union value: ${JSON.stringify(e)}`}catch{return"Invalid union value"}}function Ad(e,t){const n=e.err.issues[0].path,s=t.err.issues[0].path;if(n.length!==s.length)return s.length-n.length;for(let i=0;i<n.length;i++){if(s[i]>n[i])return-1;if(s[i]<n[i])return 1}return 0}function Et(e,t,n){const s=Lu(e,t,n);if(!s.ok)throw new TypeError(s.error);return s.value}function pb(e,t,n){return Lu(e,t,n).ok}function nc(e,t,n){Et(e,t,n)}function Lu(e,t,n){const s=t.try(e,n?{mode:n}:void 0);return s.ok?s:{ok:!1,error:Jl(s,e,t,n)}}function mb(e,t,n){let s=1;n==="passthrough"?s=0:n==="strip"&&(s=2);const i=t.func(e,s);if(i===void 0)return{ok:!0,value:e};if(i.ok)return i;const o=new Ou(i);return{ok:!1,error:Jl(o,e,t,n)}}function yb(e){return e}function W(e){return Ul(e)}function _e(e){return Im(e)}function sc(e){return km(e)}var wb=Object.getPrototypeOf(Object.getPrototypeOf(bm().optional())).constructor;function vb(e){return e instanceof wb}function Lm(e){const t={};for(const[n,s]of Object.entries(e.shape))s.name==="object"?t[n]=Lm(s).optional():t[n]=s.optional();return Ul(t)}var gb=22,Sb=/^[0-9a-v-]+$/,bb="0".repeat(gb),Ee=bb,ut=kb();function Fd(e,t){return e.toString(32).slice(-t).padStart(t,"0")}function kb(){let e="",t=0;return()=>{e||(e=Fd(kh(),12));const n=Fd(t++,10);return e+n}}function Ib(e){return typeof e=="string"&&Sb.test(e)}function lr(e){nc(e,dr)}var dr=f.string().assert(Ib,"Invalid hash");function Au(e){if(Array.isArray(e)){e.sort();for(let n=1;n<e.length;n++)g(e[n-1]!==e[n],"Refs must not have duplicates");return e}const t=[...e];return t.sort(),t}var Am=class{constructor(e,t,n){v(this,"hash");v(this,"data");v(this,"meta");g(!n.includes(e),"Chunk cannot reference itself"),this.hash=e,this.data=t,this.meta=n}};function Fm(e){if(!Array.isArray(e))throw new Error("Refs must be an array");if(e.length>0){j(e[0]);for(let t=1;t<e.length;t++)j(e[t])}}function $m(e,t,n){const s=n();return new Am(s,e,t)}function Vm(e,t,n){return new Cb(e,t,n).compute()}var Xr,Yr,Os,Lt,bn,pt,Ts,Ps,ke,kc,Ch,Dh,Gm,Xf,Cb=(Xf=class{constructor(e,t,n){h(this,ke);h(this,Xr);h(this,Yr);h(this,Os);h(this,Lt);h(this,bn);h(this,pt);h(this,Ts);h(this,Ps);const s=[],i=[];for(const o of e)o.old!==o.new&&(o.old&&i.push(o.old),o.new&&s.push(o.new));d(this,Xr,s),d(this,Yr,i),d(this,Os,t),d(this,Lt,n),d(this,pt,new Map),d(this,Ts,new Map),d(this,Ps,n.areRefsCounted!==void 0),d(this,bn,r(this,Ps)?new Set:null)}async compute(){for(const e of r(this,Xr))await p(this,ke,kc).call(this,e,1);if(await Promise.all(Array.from(r(this,Os).values(),e=>p(this,ke,Dh).call(this,e))),r(this,Ps)){g(r(this,Lt).areRefsCounted),g(r(this,bn));let e;do{e=!1;for(const t of r(this,Os).values())if(!r(this,Lt).areRefsCounted(t)&&!r(this,bn).has(t)&&r(this,pt).get(t)!==0){await p(this,ke,Ch).call(this,t,1),e=!0;break}}while(e)}for(const e of r(this,Yr))await p(this,ke,kc).call(this,e,-1);return r(this,pt)}},Xr=new WeakMap,Yr=new WeakMap,Os=new WeakMap,Lt=new WeakMap,bn=new WeakMap,pt=new WeakMap,Ts=new WeakMap,Ps=new WeakMap,ke=new WeakSet,kc=async function(e,t){await p(this,ke,Dh).call(this,e),p(this,ke,Gm).call(this,e,t)&&await p(this,ke,Ch).call(this,e,t)},Ch=async function(e,t){var s;if(e===Ee)return;const n=await r(this,Lt).getRefs(e);if(n!==void 0){(s=r(this,bn))==null||s.add(e);const i=n.map(o=>p(this,ke,kc).call(this,o,t));await Promise.all(i)}},Dh=function(e){let t=r(this,Ts).get(e);return t===void 0&&(t=(async()=>{const n=await r(this,Lt).getRefCount(e)||0;return r(this,pt).set(e,n),n})(),r(this,Ts).set(e,t)),t},Gm=function(e,t){const n=r(this,pt).get(e);return He(n),r(this,pt).set(e,n+t),n===0&&t===1||n===1&&t===-1},Xf);function eu(e){return`c/${e}/d`}function Ic(e){return`c/${e}/m`}function rh(e){return`c/${e}/r`}function jm(e){return`h/${e}`}var zm=class extends Error{constructor(t){super(`Chunk not found ${t}`);v(this,"name","ChunkNotFoundError");v(this,"hash");this.hash=t}};async function Bm(e,t){const n=await e.getChunk(t);if(n)return n;throw new zm(t)}async function Wl(e,t){const n=await t.getHead(e);return g(n,`Missing head ${e}`),n}var kn,Zr,Hs,Yf,Km=(Yf=class{constructor(e,t,n){h(this,kn);h(this,Zr);h(this,Hs);d(this,kn,e),d(this,Zr,t),d(this,Hs,n)}async read(){return new Um(await r(this,kn).read(),r(this,Hs))}async write(){return new Db(await r(this,kn).write(),r(this,Zr),r(this,Hs))}close(){return r(this,kn).close()}},kn=new WeakMap,Zr=new WeakMap,Hs=new WeakMap,Yf),Um=class{constructor(e,t){v(this,"_tx");v(this,"assertValidHash");this._tx=e,this.assertValidHash=t}hasChunk(e){return this._tx.has(eu(e))}async getChunk(e){const t=await this._tx.get(eu(e));if(t===void 0)return;const n=await this._tx.get(Ic(e));let s;return n!==void 0?(Fm(n),s=n):s=[],new Am(e,t,s)}mustGetChunk(e){return Bm(this,e)}async getHead(e){const t=await this._tx.get(jm(e));if(t!==void 0)return lr(t),t}release(){this._tx.release()}get closed(){return this._tx.closed}},eo,Ls,As,Nt,Eh,qm,Qm,Zf,Db=(Zf=class extends Um{constructor(t,n,s){super(t,s);h(this,Nt);h(this,eo);h(this,Ls,new Set);h(this,As,new Map);v(this,"createChunk",(t,n)=>$m(t,n,r(this,eo)));d(this,eo,n)}get kvWrite(){return this._tx}async putChunk(t){const{hash:n,data:s,meta:i}=t;this.assertValidHash(n);const o=eu(n),a=this._tx.put(o,s);let c;if(i.length>0){for(const u of i)this.assertValidHash(u);c=this._tx.put(Ic(n),i)}r(this,Ls).add(n),await a,await c}setHead(t,n){return p(this,Nt,Eh).call(this,t,n)}removeHead(t){return p(this,Nt,Eh).call(this,t,void 0)}async commit(){const t=await Vm(r(this,As).values(),r(this,Ls),this);await p(this,Nt,qm).call(this,t),await this._tx.commit()}async getRefCount(t){const n=await this._tx.get(rh(t));if(n!==void 0){if(He(n),n<0||n>65535||n!==(n|0))throw new Error(`Invalid ref count ${n}. We expect the value to be a Uint16`);return n}}async getRefs(t){const n=await this._tx.get(Ic(t));return n===void 0?[]:(Fm(n),n)}release(){this._tx.release()}},eo=new WeakMap,Ls=new WeakMap,As=new WeakMap,Nt=new WeakSet,Eh=async function(t,n){const s=await this.getHead(t),i=jm(t);let o;n===void 0?o=this._tx.del(i):o=this._tx.put(i,n);const a=r(this,As).get(t);a===void 0?r(this,As).set(t,{new:n,old:s}):a.new=n,await o},qm=async function(t){const n=[];for(const[s,i]of t)if(i===0)n.push(p(this,Nt,Qm).call(this,s));else{const o=rh(s);n.push(this._tx.put(o,i))}await Promise.all(n)},Qm=async function(t){await Promise.all([this._tx.del(eu(t)),this._tx.del(Ic(t)),this._tx.del(rh(t))]),r(this,Ls).delete(t)},Zf),Jm="deleted-clients",Eb=W({clientIDs:_e(f.string()),clientGroupIDs:_e(f.string())}),_b=_e(f.string());async function Wm(e,t,n){const s={clientIDs:tu(t),clientGroupIDs:tu(n)},i=s,o=e.createChunk(i,[]);return await e.putChunk(o),await e.setHead(Jm,o.hash),s}async function Gr(e){const t=await e.getHead(Jm);if(t===void 0)return{clientIDs:[],clientGroupIDs:[]};const n=await e.mustGetChunk(t),s=Lu(n.data,_b);return s.ok?{clientIDs:s.value,clientGroupIDs:[]}:Et(n.data,Eb)}async function Xm(e,t,n){const{clientIDs:s,clientGroupIDs:i}=await Gr(e);return Wm(e,[...s,...t],[...i,...n])}async function xb(e,t,n){const{clientIDs:s,clientGroupIDs:i}=await Gr(e),o=s.filter(c=>!t.includes(c)),a=i.filter(c=>!n.includes(c));return Wm(e,o,a)}function tu(e){return[...new Set(e)].sort()}var nu=5,Mb=6,jr=7,Se=jr;function Ym(e="info",t=[cn],n){const s=t.length===1?t[0]:new Cm(t);return new Tu(e,n,s)}var ae=typeof navigator<"u"?navigator:void 0,Fs,to,no,ep,Zm=(ep=class{constructor(e,t){h(this,Fs);h(this,to);h(this,no,!1);d(this,Fs,e),d(this,to,t)}release(){r(this,to).call(this),d(this,no,!0)}get closed(){return r(this,no)}has(e){return Promise.resolve(r(this,Fs).has(e))}get(e){return Promise.resolve(r(this,Fs).get(e))}},Fs=new WeakMap,to=new WeakMap,no=new WeakMap,ep),$s,tp,Nb=(tp=class extends Pm{constructor(t,n){super(new Zm(t,n));h(this,$s);d(this,$s,t)}commit(){return this._pending.forEach((t,n)=>{t===Or?r(this,$s).delete(n):r(this,$s).set(n,t)}),this._pending.clear(),this.release(),ie}},$s=new WeakMap,tp),_h=new Map;function ey(e){return _h.delete(e),ie}var Vs,Gs,so,np,ty=(np=class{constructor(e){h(this,Vs);h(this,Gs);h(this,so,!1);const t=_h.get(e);let n,s;t?{lock:n,map:s}=t:(n=new Dm,s=new Map,_h.set(e,{lock:n,map:s})),d(this,Gs,n),d(this,Vs,s)}async read(){const e=await r(this,Gs).read();return new Zm(r(this,Vs),e)}async write(){const e=await r(this,Gs).write();return new Nb(r(this,Vs),e)}close(){return d(this,so,!0),ie}get closed(){return r(this,so)}},Vs=new WeakMap,Gs=new WeakMap,so=new WeakMap,np),io,ro,Qe,oo,xh,sp,Rb=(sp=class{constructor(e,t){h(this,oo);h(this,io);h(this,ro);h(this,Qe);d(this,io,e),d(this,ro,t),d(this,Qe,new Zc(t))}read(){return p(this,oo,xh).call(this,e=>e.read())}write(){return p(this,oo,xh).call(this,e=>e.write())}close(){return r(this,Qe).close()}get closed(){return r(this,Qe).closed}},io=new WeakMap,ro=new WeakMap,Qe=new WeakMap,oo=new WeakSet,xh=async function(e){var t,n;try{return await e(r(this,Qe))}catch(s){if(ny(s))return r(this,Qe)instanceof Zc&&((n=(t=r(this,io)).info)==null||n.call(t,"Switching to MemStore because of Firefox private browsing error"),d(this,Qe,new ty(r(this,ro)))),e(r(this,Qe));throw s}},sp);function ny(e){return Xl()&&e instanceof DOMException&&e.name==="InvalidStateError"&&e.message==="A mutation operation was attempted on a database that did not allow mutations."}function Xl(){return(ae==null?void 0:ae.userAgent.includes("Firefox"))??!1}function Ob(e,t){return Xl()?new Rb(e,t):new Zc(t)}function Tb(e){if(!Xl())return $d(e);try{return $d(e)}catch(t){if(ny(t))return ey(e)}return ie}function $d(e){return new Promise((t,n)=>{const s=indexedDB.deleteDatabase(e);s.onsuccess=()=>t(),s.onerror=()=>n(s.error)})}function sy(e,t,n){return e?new Pb(e,t,n):new Ab}var js,ao,co,zs,vu,pn,Mh,Nh,ip,Pb=(ip=class{constructor(e,t,n){h(this,pn);h(this,js);h(this,ao);h(this,co,0);v(this,"visibilityState");h(this,zs,new Set);h(this,vu,()=>{r(this,js).visibilityState==="visible"?(clearTimeout(r(this,co)),p(this,pn,Mh).call(this,"visible")):d(this,co,setTimeout(()=>{p(this,pn,Mh).call(this,"hidden")},r(this,ao)))});d(this,js,e),d(this,ao,t),this.visibilityState=e.visibilityState,r(this,js).addEventListener("visibilitychange",r(this,vu),{signal:n})}waitForVisible(){return p(this,pn,Nh).call(this,"visible")}waitForHidden(){return p(this,pn,Nh).call(this,"hidden")}},js=new WeakMap,ao=new WeakMap,co=new WeakMap,zs=new WeakMap,vu=new WeakMap,pn=new WeakSet,Mh=function(e){if(e!==this.visibilityState){this.visibilityState=e;for(const t of r(this,zs)){const{resolve:n,state:s}=t;s===e&&(n(),r(this,zs).delete(t))}}},Nh=function(e){if(this.visibilityState===e)return Promise.resolve();const{promise:t,resolve:n}=A();return r(this,zs).add({resolve:n,state:e}),t},ip),Hb=Promise.resolve(),Lb=new Promise(()=>{}),Ab=class{constructor(){v(this,"visibilityState","visible")}waitForVisible(){return Hb}waitForHidden(){return Lb}},iy=class{constructor(e,t){v(this,"rep");v(this,"invokeSend");v(this,"maxConnections",1);this.rep=e,this.invokeSend=t}get maxDelayMs(){return this.rep.requestOptions.maxDelayMs}get minDelayMs(){return this.rep.requestOptions.minDelayMs}},Fb=class extends iy{constructor(){super(...arguments);v(this,"debounceDelay",0)}get watchdogTimer(){return this.rep.pullInterval}},$b=class extends iy{constructor(){super(...arguments);v(this,"watchdogTimer",null)}get debounceDelay(){return this.rep.pushDelay}},Vb=30,Gb=6e4,In,Bs,Cn,uo,Ae,Ks,Us,ho,Dn,fr,ry,oy,rp,Vd=(rp=class{constructor(e,t,n){h(this,fr);h(this,In,A());h(this,Bs,A());h(this,Cn,A());h(this,uo);h(this,Ae,!1);h(this,Ks,0);h(this,Us);h(this,ho);h(this,Dn);d(this,Us,e),d(this,uo,t),d(this,ho,n),this.run()}close(){d(this,Ae,!0),r(this,Ks)>0&&r(this,Cn).resolve({error:Gd()})}async send(e){var n,s,i;if(r(this,Ae))return{error:Gd()};yn(this,Ks)._++,(s=(n=r(this,Us)).debug)==null||s.call(n,"send",e),e?r(this,Bs).resolve():await((i=r(this,ho))==null?void 0:i.waitForVisible()),r(this,In).resolve();const t=await r(this,Cn).promise;return yn(this,Ks)._--,t}async run(){const e=[];let t=A(),n,s=0;const i=r(this,uo),{debug:o}=r(this,Us);let a=0;o==null||o("Starting connection loop");const c=u=>Promise.race([r(this,Bs).promise,un(u)]);for(;!r(this,Ae);){o==null||o(oh(e)?"Last request failed. Trying again":"Waiting for a send");const u=[r(this,In).promise],l=i.watchdogTimer;if(l!==null&&u.push(un(l)),await Promise.race(u),r(this,Ae)||(o==null||o("Waiting for debounce"),await c(i.debounceDelay),r(this,Ae)))break;if(o==null||o("debounced"),d(this,In,A()),s>=i.maxConnections){if(o==null||o("Too many request in flight. Waiting until one finishes..."),await p(this,fr,oy).call(this),r(this,Ae))break;o==null||o("...finished")}s>0||oh(e)?(a=zb(a,i,e),o==null||o(oh(e)?"Last connection errored. Sleeping for":"More than one outstanding connection ("+s+"). Sleeping for",a,"ms")):a=0;const m=Math.min(i.maxDelayMs,Math.max(i.minDelayMs,a));if(n!==void 0){const y=Date.now()-n;if(m>y&&(await Promise.race([c(m-y),t.promise]),r(this,Ae)))break}s++,(async()=>{const y=Date.now();let w,b;try{n=y,o==null||o("Sending request"),d(this,Bs,A()),w=await i.invokeSend(),o==null||o("Send returned",w)}catch(k){o==null||o("Send failed",k),b=k,w=!1}if(r(this,Ae)){o==null||o("Closed after invokeSend");return}o==null||o("Request done",{duration:Date.now()-y,ok:w}),e.push({duration:Date.now()-y,ok:w}),Kb(e)&&(t.resolve(),t=A()),s--,p(this,fr,ry).call(this);const C=r(this,Cn);d(this,Cn,A()),b?C.resolve({error:b}):C.resolve(void 0),w||r(this,In).resolve()})()}}},In=new WeakMap,Bs=new WeakMap,Cn=new WeakMap,uo=new WeakMap,Ae=new WeakMap,Ks=new WeakMap,Us=new WeakMap,ho=new WeakMap,Dn=new WeakMap,fr=new WeakSet,ry=function(){if(r(this,Dn)){const e=r(this,Dn);d(this,Dn,void 0),e()}},oy=function(){const{promise:e,resolve:t}=A();return d(this,Dn,t),e},rp),jb=9;function Gd(){return new Error("Closed")}function zb(e,t,n){const{length:s}=n;if(s===0)return e;const{ok:i}=n[n.length-1],{maxConnections:o,minDelayMs:a}=t;if(!i)return e===0?a:e*2;if(s>1){const u=n[n.length-2];for(;n.length>jb;)n.shift();if(i&&!u.ok)return a}return Bb(n.filter(({ok:u})=>u).map(({duration:u})=>u))/o|0}function Bb(e){e.sort();const{length:t}=e,n=t>>1;return t%2===1?e[n]:(e[n-1]+e[n])/2}function oh(e){return e.length>0&&!e[e.length-1].ok}function Kb(e){return e.length>1&&!e[e.length-2].ok&&e[e.length-1].ok}function*Rh(...e){for(const t of e)yield*t}function*Ub(e,t){let n=0;for(const s of e)t(s,n++)&&(yield s)}function*qb(e,t){let n=0;for(const s of e)yield t(s,n++)}var Qb=class Oh{constructor(t){v(this,"iter");this.iter=t}[Symbol.iterator](){return this.iter[Symbol.iterator]()}map(t){return new Oh(qb(this.iter,t))}filter(t){return new Oh(Ub(this.iter,t))}};function Jb(e){return new Qb(e)}function*Wb(e,t,n=!1){var i;const s=e.map(o=>o[Symbol.iterator]());try{const o=s.map(c=>c.next());let a;for(;o.some(c=>!c.done);){const c=o.reduce((u,l,m)=>l.done?u:u===void 0||t(l.value,u[0])<0?[l.value,m]:u,void 0);g(c!==void 0,"min is undefined"),o[c[1]]=s[c[1]].next(),!(a!==void 0&&n&&t(a,c[0])===0)&&(a=c[0],yield c[0])}}finally{for(const o of s)(i=o.return)==null||i.call(o)}}var qe=1,Cs=4,Xb=5,Yb=8;function os(e){switch(typeof e){case"string":return qe+Cs+e.length;case"number":return Zb(e)?e<=-1073741824||e>=2**30-1?qe+Xb:qe+Cs:qe+Yb;case"boolean":return qe;case"object":if(e===null)return qe;if(Array.isArray(e)){let t=2*qe+Cs;for(const n of e)t+=os(n);return t}{const t=e;let n=2*qe+Cs;for(const s in t)if(ls(t,s)){const i=t[s];i!==void 0&&(n+=os(s)+os(i))}return n}}throw new Error(`Invalid value. type: ${typeof e}, value: ${e}`)}function Zb(e){return e===(e|0)}var e0=2*qe+Cs+qe+Cs;function ay(e,t){return e0+os(e)+os(t)}var lo,fo,qs,po,Qs,op,t0=(op=class{constructor(e,t,n,s,i=os){h(this,lo,new Dm);h(this,fo,new Map);h(this,qs);h(this,po);h(this,Qs);v(this,"_memOnlyChunks",new Map);v(this,"_sourceChunksCache");v(this,"_refCounts",new Map);v(this,"_refs",new Map);this._sourceChunksCache=new s0(t,i,this._refCounts,this._refs),d(this,qs,e),d(this,po,n),d(this,Qs,s)}async read(){const e=await r(this,lo).read();return new cy(r(this,fo),this._memOnlyChunks,this._sourceChunksCache,r(this,qs),e,r(this,Qs))}async write(){const e=await r(this,lo).write();return new n0(r(this,fo),this._memOnlyChunks,this._sourceChunksCache,r(this,qs),this._refCounts,this._refs,e,r(this,po),r(this,Qs))}close(){return ie}isCached(e){return this._sourceChunksCache.getWithoutUpdatingLRU(e)!==void 0}withSuspendedSourceCacheEvictsAndDeletes(e){return this._sourceChunksCache.withSuspendedEvictsAndDeletes(e)}},lo=new WeakMap,fo=new WeakMap,qs=new WeakMap,po=new WeakMap,Qs=new WeakMap,op),En,mo,Js,ap,cy=(ap=class{constructor(e,t,n,s,i,o){v(this,"_heads");v(this,"_memOnlyChunks");v(this,"_sourceChunksCache");v(this,"_sourceStore");h(this,En);h(this,mo);h(this,Js,!1);v(this,"assertValidHash");this._heads=e,this._memOnlyChunks=t,this._sourceChunksCache=n,this._sourceStore=s,d(this,mo,i),this.assertValidHash=o}isMemOnlyChunkHash(e){return this._memOnlyChunks.has(e)}async hasChunk(e){return await this.getChunk(e)!==void 0}async getChunk(e){const t=this._memOnlyChunks.get(e);if(t!==void 0)return t;let n=this._sourceChunksCache.get(e);return n===void 0&&(n=await(await this._getSourceRead()).getChunk(e),n!==void 0&&this._sourceChunksCache.put(n)),n}mustGetChunk(e){return Bm(this,e)}getHead(e){return Promise.resolve(this._heads.get(e))}release(){var e;r(this,Js)||(r(this,mo).call(this),(e=r(this,En))==null||e.then(t=>t.release()).catch(t=>{}),d(this,Js,!0))}get closed(){return r(this,Js)}_getSourceRead(){return r(this,En)||d(this,En,this._sourceStore.read()),r(this,En)}},En=new WeakMap,mo=new WeakMap,Js=new WeakMap,ap),_n,At,yo,wo,vo,Th,cp,n0=(cp=class extends cy{constructor(t,n,s,i,o,a,c,u,l){super(t,n,s,i,c,l);h(this,vo);h(this,_n);h(this,At);h(this,yo);v(this,"_pendingHeadChanges",new Map);v(this,"_pendingMemOnlyChunks",new Map);v(this,"_pendingCachedChunks",new Map);h(this,wo,new Set);v(this,"createChunk",(t,n)=>{const s=$m(t,n,r(this,yo));return r(this,wo).add(s.hash),s});d(this,_n,o),d(this,At,a),d(this,yo,u)}putChunk(t,n){const{hash:s,meta:i}=t;if(this.assertValidHash(s),i.length>0)for(const o of i)this.assertValidHash(o);return r(this,wo).has(s)||this.isMemOnlyChunkHash(s)?this._pendingMemOnlyChunks.set(s,t):this._pendingCachedChunks.set(s,{chunk:t,size:n??-1}),ie}async setHead(t,n){await p(this,vo,Th).call(this,t,n)}async removeHead(t){await p(this,vo,Th).call(this,t,void 0)}isMemOnlyChunkHash(t){return this._pendingMemOnlyChunks.has(t)||super.isMemOnlyChunkHash(t)}async getChunk(t){const n=this._pendingMemOnlyChunks.get(t);if(n!==void 0)return n;const s=this._memOnlyChunks.get(t);if(s!==void 0)return s;const i=this._pendingCachedChunks.get(t);if(i!==void 0)return i.chunk;let o=this._sourceChunksCache.get(t);return o===void 0&&(o=await(await this._getSourceRead()).getChunk(t),o!==void 0&&this._pendingCachedChunks.set(o.hash,{chunk:o,size:-1})),o}getHead(t){const n=this._pendingHeadChanges.get(t);return n?Promise.resolve(n.new):super.getHead(t)}async commit(){const t=new Set(Rh(this._pendingMemOnlyChunks.keys(),this._pendingCachedChunks.keys())),n=await Vm(this._pendingHeadChanges.values(),t,this);for(const[s,i]of n)if(this.isMemOnlyChunkHash(s)){if(i===0)r(this,_n).delete(s),this._memOnlyChunks.delete(s),r(this,At).delete(s);else{r(this,_n).set(s,i);const o=this._pendingMemOnlyChunks.get(s);o&&(r(this,At).set(s,o.meta),this._memOnlyChunks.set(s,o))}n.delete(s)}this._sourceChunksCache.updateForCommit(this._pendingCachedChunks,n);for(const[s,i]of this._pendingHeadChanges)i.new?this._heads.set(s,i.new):this._heads.delete(s);this._pendingMemOnlyChunks.clear(),this._pendingCachedChunks.clear(),this._pendingHeadChanges.clear(),this.release()}getRefCount(t){return r(this,_n).get(t)}getRefs(t){const n=this._pendingMemOnlyChunks.get(t);if(n)return n.meta;const s=this._memOnlyChunks.get(t);if(s)return s.meta;const i=this._pendingCachedChunks.get(t);return i!==void 0?i.chunk.meta:r(this,At).get(t)}areRefsCounted(t){return r(this,At).has(t)}chunksPersisted(t){const n=[];for(const s of t){const i=this._memOnlyChunks.get(s);i&&(this._memOnlyChunks.delete(s),n.push(i))}this._sourceChunksCache.persisted(n)}},_n=new WeakMap,At=new WeakMap,yo=new WeakMap,wo=new WeakMap,vo=new WeakSet,Th=async function(t,n){const s=await this.getHead(t),i=this._pendingHeadChanges.get(t);i===void 0?this._pendingHeadChanges.set(t,{new:n,old:s}):i.new=n},cp),Ws,go,Fe,Ft,xn,Mn,So,oe,Ir,Cc,uy,Ph,up,s0=(up=class{constructor(e,t,n,s){h(this,oe);h(this,Ws);h(this,go);h(this,Fe);h(this,Ft);h(this,xn,0);h(this,Mn,!1);h(this,So,[]);v(this,"cacheEntries",new Map);d(this,Ws,e),d(this,go,t),d(this,Fe,n),d(this,Ft,s)}get(e){const t=this.cacheEntries.get(e);return t&&(this.cacheEntries.delete(e),this.cacheEntries.set(e,t)),t==null?void 0:t.chunk}getWithoutUpdatingLRU(e){var t;return(t=this.cacheEntries.get(e))==null?void 0:t.chunk}put(e){const{hash:t}=e,n=this.cacheEntries.get(t);if(n){this.cacheEntries.delete(t),this.cacheEntries.set(t,n);return}const s=r(this,Fe).get(t);if(!(s===void 0||s<1)&&p(this,oe,Cc).call(this,e)){if(!r(this,Ft).has(t)){for(const i of e.meta)r(this,Fe).set(i,(r(this,Fe).get(i)||0)+1);r(this,Ft).set(t,e.meta)}p(this,oe,Ir).call(this)}}updateForCommit(e,t){for(const[n,s]of t)if(s===0)r(this,Mn)?(r(this,Fe).set(n,0),r(this,So).push(n)):p(this,oe,Ph).call(this,n);else{r(this,Fe).set(n,s);const i=e.get(n);if(i){const{chunk:o,size:a}=i,c=this.cacheEntries.get(n);c?(this.cacheEntries.delete(n),this.cacheEntries.set(n,c)):(p(this,oe,Cc).call(this,o,a!==-1?a:void 0),r(this,Ft).set(n,o.meta))}}p(this,oe,Ir).call(this)}persisted(e){for(const t of e)p(this,oe,Cc).call(this,t);p(this,oe,Ir).call(this)}async withSuspendedEvictsAndDeletes(e){d(this,Mn,!0);try{return await e()}finally{d(this,Mn,!1);for(const t of r(this,So))r(this,Fe).get(t)===0&&p(this,oe,Ph).call(this,t);p(this,oe,Ir).call(this)}}},Ws=new WeakMap,go=new WeakMap,Fe=new WeakMap,Ft=new WeakMap,xn=new WeakMap,Mn=new WeakMap,So=new WeakMap,oe=new WeakSet,Ir=function(){if(!r(this,Mn))for(const e of this.cacheEntries.values()){if(r(this,xn)<=r(this,Ws))break;p(this,oe,uy).call(this,e)}},Cc=function(e,t){const n=t??r(this,go).call(this,e);return n>r(this,Ws)?!1:(d(this,xn,r(this,xn)+n),this.cacheEntries.set(e.hash,{chunk:e,size:n}),!0)},uy=function(e){const{hash:t}=e.chunk;d(this,xn,r(this,xn)-e.size),this.cacheEntries.delete(t)},Ph=function(e){r(this,Fe).delete(e),r(this,Ft).delete(e);const t=this.cacheEntries.get(e);t&&(d(this,xn,r(this,xn)-t.size),this.cacheEntries.delete(e))},up),pr=4,mr=5,fe="main";function ic(e){return Fu(e.meta)}function i0(e){return ic(e)}function Yl(e){return c0(e.meta)}var hy=class{constructor(e){v(this,"chunk");this.chunk=e}get meta(){return this.chunk.data.meta}get valueHash(){return this.chunk.data.valueHash}getMutationID(e,t){return Zl(e,t,this.meta)}async getNextMutationID(e,t){return await this.getMutationID(e,t)+1}get indexes(){return this.chunk.data.indexes}};async function Zl(e,t,n){switch(n.type){case mr:return n.lastMutationIDs[e]??0;case pr:{if(n.clientID===e)return n.mutationID;const{basisHash:s}=n,i=await J(s,t);return Zl(e,t,i.meta)}default:me()}}async function ly(e,t){return(await my(e,t)).filter(s=>i0(s))}async function dy(e,t){return(await my(e,t)).filter(s=>ic(s))}async function fy(e,t,n){const s=[],i=new Map(Object.entries(t));for(;!Yl(e)&&i.size>0;){if(ic(e)){const{meta:a}=e,c=i.get(a.clientID);c!==void 0&&(a.mutationID<=c?i.delete(a.clientID):s.push(e))}const{basisHash:o}=e.meta;if(o===null)throw new Error(`Commit ${e.chunk.hash} has no basis`);e=await J(o,n)}return s}async function r0(e,t){const n=await t.getHead(e);return g(n,`Missing head ${e}`),xt(n,t)}async function py(e,t){return(await xt(e,t)).chunk.hash}async function xt(e,t){const n=await J(e,t);return Tr(n,t)}async function Tr(e,t){for(;!Yl(e);){const{meta:n}=e;if(Fu(n))e=await J(n.baseSnapshotHash,t);else{const{basisHash:s}=n;if(s===null)throw new Error(`Commit ${e.chunk.hash} has no basis`);e=await J(s,t)}}return e}function jd(e,t){const n=e.meta;return[n.lastMutationIDs[t]??0,n.cookieJSON]}function Hh(e,t){return ql(e.meta.cookieJSON,t.meta.cookieJSON)}async function my(e,t){let n=await J(e,t);const s=[];for(;!Yl(n);){const{meta:i}=n,{basisHash:o}=i;if(o===null)throw new Error(`Commit ${n.chunk.hash} has no basis`);s.push(n),n=await J(o,t)}return s.push(n),s}async function J(e,t){const n=await t.mustGetChunk(e);return f0(n)}async function ed(e,t){const n=await Wl(e,t);return J(n,t)}function o0(e){if(j(e.clientID),He(e.mutationID),j(e.mutatorName),!e.mutatorName)throw new Error("Missing mutator name");e.mutatorArgsJSON,e.originalHash!==null&&lr(e.originalHash),He(e.timestamp)}function Fu(e){return e.type===pr}function td(e){e.basisHash!==null&&lr(e.basisHash),e.cookieJSON,a0(e.lastMutationIDs)}function a0(e){ee(e);for(const t of Object.values(e))He(t)}function as(e){td(e.meta)}function c0(e){return e.type===mr}function u0(e,t){return e.jsonPointer===t.jsonPointer&&(e.allowEmpty??!1)===(t.allowEmpty??!1)&&e.keyPrefix===t.keyPrefix}function h0(e,t){return{name:e,keyPrefix:t.prefix??"",jsonPointer:t.jsonPointer,allowEmpty:t.allowEmpty??!1}}function l0(e,t,n,s,i,o,a,c,u,l,m){return wy(e,gy({type:pr,basisHash:t,baseSnapshotHash:n,mutationID:s,mutatorName:i,mutatorArgsJSON:o,originalHash:a,timestamp:l,clientID:m},c,u))}function d0(e,t,n,s,i,o){return wy(e,yy(t,n,s,i,o))}function yy(e,t,n,s,i){return gy({type:mr,basisHash:e,lastMutationIDs:t,cookieJSON:n},s,i)}function f0(e){return p0(e),new hy(e)}function wy(e,t){return new hy(e(t,vy(t)))}function vy(e){const t=new Set;t.add(e.valueHash);const{meta:n}=e;switch(n.type){case pr:n.basisHash&&t.add(n.basisHash);break;case mr:break;default:me()}for(const s of e.indexes)t.add(s.valueHash);return Au(t)}function gy(e,t,n){return{meta:e,valueHash:t,indexes:n}}function p0(e){const{data:t}=e,n=new Set;for(const s of t.indexes){const{name:i}=s.definition;if(n.has(i))throw new Error(`Duplicate index ${i}`);n.add(i)}}function Sy(e,t){let n=0;for(;n<e;){const s=n+(e-n>>1),i=t(s);if(i===0)return s;i>0?n=s+1:e=s}return n}var by=0,ky=1;function Iy(e,t,n){return[e,n>=jr?t:t.map(s=>s.slice(0,2))]}async function su(e,t,n,s){const i=await n.getNode(t);if(s!==n.rootHash)return su(e,n.rootHash,n,n.rootHash);if(ru(i))return i;const{entries:o}=i;let a=fn(e,o);a===o.length&&a--;const c=o[a];return su(e,c[1],n,s)}function fn(e,t){return Sy(t.length,n=>Pe(e,t[n][0]))}function iu(e,t,n){return e!==t.length&&t[e][0]===n}function zd(e,t,n){if(t>=jr)return e;dn(e),g(e.length>=2);const[s,i]=e;He(s),dn(i);const o=s>0?j:KS;if(t>=jr){for(const c of i)m0(c,o);return e}const a=i.map(c=>y0(c,o,n));return[s,a]}function m0(e,t){dn(e),g(e.length>=3),j(e[0]),t(e[1]),He(e[2])}function y0(e,t,n){dn(e),g(e.length>=2),j(e[0]),t(e[1]);const s=n(e[0],e[1]);return[e[0],e[1],s]}var Nn,hp,Cy=(hp=class{constructor(e,t,n){v(this,"entries");v(this,"hash");v(this,"isMutable");h(this,Nn,-1);this.entries=e,this.hash=t,this.isMutable=n}maxKey(){return this.entries[this.entries.length-1][0]}getChildNodeSize(e){if(r(this,Nn)!==-1)return r(this,Nn);let t=e.chunkHeaderSize;for(const n of this.entries)t+=n[2];return d(this,Nn,t)}_updateNode(e){d(this,Nn,-1),e.updateNode(this)}},Nn=new WeakMap,hp);function Bd(e,t){return Iy(e.level,e.entries,t)}var bo,Lh,lp,$u=(lp=class extends Cy{constructor(){super(...arguments);h(this,bo);v(this,"level",0)}set(t,n,s,i){let o;const a=fn(t,this.entries);return iu(a,this.entries,t)?o=1:o=0,Promise.resolve(p(this,bo,Lh).call(this,i,a,o,[t,n,s]))}del(t,n){const s=fn(t,this.entries);return iu(s,this.entries,t)?Promise.resolve(p(this,bo,Lh).call(this,n,s,1)):Promise.resolve(this)}async*keys(t){for(const n of this.entries)yield n[0]}async*entriesIter(t){for(const n of this.entries)yield n}},bo=new WeakSet,Lh=function(t,n,s,...i){if(this.isMutable)return this.entries.splice(n,s,...i),this._updateNode(t),this;const o=Dc(this.entries,n,s,...i);return t.newDataNodeImpl(o)},lp);function Dc(e,t,n,...s){const i=e.slice(0,t);for(let o=0;o<s.length;o++)i.push(s[o]);for(let o=t+n;o<e.length;o++)i.push(e[o]);return i}var mn,Ah,Fh,us,Dy=(us=class extends Cy{constructor(n,s,i,o){super(n,s,o);h(this,mn);v(this,"level");this.level=i}async set(n,s,i,o){let a=fn(n,this.entries);a===this.entries.length&&a--;const c=this.entries[a][1],l=await(await o.getNode(c)).set(n,s,i,o),m=l.getChildNodeSize(o);if(m>o.maxSize||m<o.minSize)return p(this,mn,Ah).call(this,o,a,l);const y=Ec(l,o.getEntrySize);return p(this,mn,Fh).call(this,o,a,y)}async del(n,s){const i=fn(n,this.entries);if(i===this.entries.length)return this;const o=this.entries[i][1],a=await s.getNode(o),c=a.hash,u=await a.del(n,s);if(u.hash===c)return this;if(u.entries.length===0){const l=Dc(this.entries,i,1);return s.newInternalNodeImpl(l,this.level)}if(i===0&&this.entries.length===1)return u;if(u.getChildNodeSize(s)>s.minSize){const l=Ec(u,s.getEntrySize);return p(this,mn,Fh).call(this,s,i,l)}return p(this,mn,Ah).call(this,s,i,u)}async*keys(n){for(const s of this.entries)yield*(await n.getNode(s[1])).keys(n)}async*entriesIter(n){for(const s of this.entries)yield*(await n.getNode(s[1])).entriesIter(n)}getChildren(n,s,i){const o=[];for(let a=n;a<s&&a<this.entries.length;a++)o.push(i.getNode(this.entries[a][1]));return Promise.all(o)}async getCompositeChildren(n,s,i){const{level:o}=this;if(s===0)return new us([],ut(),o-1,!0);const a=await this.getChildren(n,n+s,i);if(o>1){const u=[];for(const l of a)u.push(...l.entries);return new us(u,ut(),o-1,!0)}g(o===1);const c=[];for(const u of a)c.push(...u.entries);return new $u(c,ut(),!0)}},mn=new WeakSet,Ah=async function(n,s,i){const o=this.level-1,a=this.entries;let c,u,l;if(s>0){const b=a[s-1][1],C=await n.getNode(b);c=Rh(C.entries,i.entries),u=s-1,l=2}else if(s<a.length-1){const b=a[s+1][1],C=await n.getNode(b);c=Rh(i.entries,C.entries),u=s,l=2}else c=i.entries,u=s,l=1;const m=_y(c,b=>b[2],n.minSize-n.chunkHeaderSize,n.maxSize-n.chunkHeaderSize),y=[];for(const b of m){const C=n.newNodeImpl(b,o),k=Ec(C,n.getEntrySize);y.push(k)}if(this.isMutable)return this.entries.splice(u,l,...y),this._updateNode(n),this;const w=Dc(a,u,l,...y);return n.newInternalNodeImpl(w,this.level)},Fh=function(n,s,i){if(this.isMutable)return this.entries.splice(s,1,i),this._updateNode(n),this;const o=Dc(this.entries,s,1,i);return n.newInternalNodeImpl(o,this.level)},us);function Ey(e,t,n,s){return n===0?new $u(e,t,s):new Dy(e,t,n,s)}function ru(e){return e.level===0}function _y(e,t,n,s){const i=[],o=[];let a=0,c=[];for(const u of e){const l=t(u);l>=s?(c.length>0&&(i.push(c),o.push(a)),i.push([u]),o.push(l),a=0,c=[]):a+l>=n?(c.push(u),i.push(c),o.push(a+l),a=0,c=[]):(a+=l,c.push(u))}return a>0&&(o.length>0&&a+o[o.length-1]<=s?i[i.length-1].push(...c):i.push(c)),i}var xy=Iy(0,[],Se),w0=new $u([],Ee,!1);function Ec(e,t){const n=e.maxKey(),s=e.hash,i=t(n,s);return[n,s,i]}var Kd=-1,v0=0,_c=1,xc=2,$h=3,dc=0,Ud=1;function*g0(e,t){let n=0,s=0,i;function o(c,u){c[$h]===Kd&&(c[$h]=u)}function a(){return[n,0,0,Kd]}for(;n<e.length&&s<t.length;)e[n][dc]===t[s][dc]?(ds(e[n][Ud],t[s][Ud])?i&&(o(i,0),yield i,i=void 0):(i||(i=a()),i[xc]++,i[_c]++,o(i,s)),n++,s++):e[n][dc]<t[s][dc]?(i||(i=a()),i[_c]++,n++):(i||(i=a()),i[xc]++,o(i,s),s++);s<t.length&&(i||(i=a()),i[xc]+=t.length-s,o(i,s)),n<e.length&&(i||(i=a()),i[_c]+=e.length-n),i&&(o(i,0),yield i)}var S0=11,Mt=class{constructor(e,t,n=Ee,s=ay,i=S0){v(this,"_cache",new Map);v(this,"_dagRead");v(this,"_formatVersion");v(this,"rootHash");v(this,"getEntrySize");v(this,"chunkHeaderSize");this._dagRead=e,this._formatVersion=t,this.rootHash=n,this.getEntrySize=s,this.chunkHeaderSize=i}async getNode(e){if(e===Ee)return w0;const t=this._cache.get(e);if(t)return t;const n=await this._dagRead.mustGetChunk(e),s=zd(n.data,this._formatVersion,this.getEntrySize),i=Ey(s[ky],e,s[by],!1);return this._cache.set(e,i),i}async get(e){const t=await su(e,this.rootHash,this,this.rootHash),n=fn(e,t.entries);if(iu(n,t.entries,e))return t.entries[n][1]}async has(e){const t=await su(e,this.rootHash,this,this.rootHash),n=fn(e,t.entries);return iu(n,t.entries,e)}async isEmpty(){const{rootHash:e}=this,t=await this.getNode(this.rootHash);return this.rootHash!==e?this.isEmpty():t.entries.length===0}scan(e){return Vh(this.rootHash,()=>this.rootHash,this.rootHash,e,async t=>{const n=await this.getNode(t);if(n)return[n.level,n.isMutable?n.entries.slice():n.entries];const s=await this._dagRead.mustGetChunk(t);return zd(s.data,this._formatVersion,this.getEntrySize)})}async*keys(){yield*(await this.getNode(this.rootHash)).keys(this)}async*entries(){yield*(await this.getNode(this.rootHash)).entriesIter(this)}[Symbol.asyncIterator](){return this.entries()}async*diff(e){const[t,n]=await Promise.all([this.getNode(this.rootHash),e.getNode(e.rootHash)]);yield*Mc(n,t,e,this)}};async function*Mc(e,t,n,s){if(e.level>t.level){const o=await e.getCompositeChildren(0,e.entries.length,n);yield*Mc(o,t,n,s);return}if(t.level>e.level){const o=await t.getCompositeChildren(0,t.entries.length,s);yield*Mc(e,o,n,s);return}if(ru(e)&&ru(t)){yield*b0(e.entries,t.entries);return}const i=g0(e.entries,t.entries);for(const o of i){const[a,c]=await Promise.all([e.getCompositeChildren(o[v0],o[_c],n),t.getCompositeChildren(o[$h],o[xc],s)]);yield*Mc(a,c,n,s)}}function*b0(e,t){const n=e.length,s=t.length;let i=0,o=0;for(;i<n&&o<s;){const a=e[i][0],c=t[o][0];a===c?(ds(e[i][1],t[o][1])||(yield{op:"change",key:a,oldValue:e[i][1],newValue:t[o][1]}),i++,o++):a<c?(yield{op:"del",key:a,oldValue:e[i][1]},i++):(yield{op:"add",key:c,newValue:t[o][1]},o++)}for(;i<n;i++)yield{op:"del",key:e[i][0],oldValue:e[i][1]};for(;o<s;o++)yield{op:"add",key:t[o][0],newValue:t[o][1]}}async function*Vh(e,t,n,s,i){if(n===Ee)return;const o=await i(n),a=o[ky];let c=0;if(s&&(c=fn(s,a)),o[by]>0)for(;c<a.length;c++)yield*Vh(e,t,a[c][1],s,i),s="";else for(;c<a.length;c++){const u=t();if(e!==u){yield*Vh(u,t,u,a[c][0],i);return}yield a[c]}}async function ou(e,t){const n=[],s=t==="add"?i=>({op:"add",key:i[0],newValue:i[1]}):i=>({op:"del",key:i[0],oldValue:i[1]});for await(const i of e.entries())n.push(s(i));return n}var nd=0,My=1,Ny=class{constructor(e,t){v(this,"meta");v(this,"map");this.meta=e,this.map=t}},k0=class extends Ny{flush(){return this.map.flush()}clear(){return this.map.clear()}};async function Gh(e,t,n,s,i,o,a){var c;try{for(const u of I0(s,i,o,a))switch(n){case nd:await t.put(u,i);break;case My:await t.del(u);break}}catch(u){(c=e.info)==null||c.call(e,"Not indexing value",i,":",u)}}function I0(e,t,n,s){const i=C0(t,n);if(i===void 0){if(s)return[];throw new Error(`No value at path: ${n}`)}const o=Array.isArray(i)?i:[i],a=[];for(const c of o)if(typeof c=="string")a.push(Ry([c,e]));else throw new Error("Unsupported target type");return a}var jh="\0",zh="\0";function Ry(e){const t=e[0],n=e[1];if(t.includes("\0"))throw new Error("Secondary key cannot contain null byte");return jh+t+zh+n}function qd(e,t){const n=Ry([e,t||""]);return t===void 0?n.slice(0,n.length-1):n}function Vu(e){if(e[0]!==jh)throw new Error("Invalid version");const t=jh.length,n=zh.length,s=e.indexOf(zh,t);if(s===-1)throw new Error("Invalid formatting");const i=e.slice(t,s),o=e.slice(s+n);return[i,o]}function C0(e,t){function n(o){if(!(o.startsWith("+")||o.startsWith("0")&&o.length!==1))return parseInt(o,10)}if(t==="")return e;if(!t.startsWith("/"))throw new Error(`Invalid JSON pointer: ${t}`);const s=t.split("/").slice(1).map(o=>o.replace(/~1/g,"/").replace(/~0/g,"~"));let i=e;for(const o of s){let a;if(Array.isArray(i)){const c=n(o);if(c===void 0)return;a=i[c]}else{if(i===null)return;typeof i=="object"&&(i=i,a=i[o])}if(a===void 0)return;i=a}return i}var Xs,dp,Oy=(dp=class{constructor(e,t,n){h(this,Xs);v(this,"map");v(this,"indexes");d(this,Xs,e),this.map=t,this.indexes=n}has(e){return this.map.has(e)}get(e){return this.map.get(e)}isEmpty(){return this.map.isEmpty()}getMapForIndex(e){const t=this.indexes.get(e);if(t===void 0)throw new Error(`Unknown index name: ${e}`);return t.map}get closed(){return r(this,Xs).closed}close(){r(this,Xs).release()}},Xs=new WeakMap,dp);function D0(e,t){return E0(fe,e,t)}async function E0(e,t,n){const s=await ed(e,t);return Ty(s,t,n)}async function _0(e,t,n){const s=await J(e,t);return Ty(s,t,n)}function Ty(e,t,n){const s=au(e,t,n),i=new Mt(t,n,e.valueHash);return new Oy(t,i,s)}function au(e,t,n){const s=new Map;for(const i of e.indexes)s.set(i.definition.name,new Ny(i,new Mt(t,n,i.valueHash)));return s}async function Py(e){const t=[];for await(const n of e)t.push(n);return t}function Hy(e){return e.indexName!==void 0}function Bh(e){return typeof e=="string"?[e]:e}function x0(e){if(!e)return{};let t,n,s,i;return e.start&&({key:t,exclusive:n}=e.start,e.indexName?typeof t=="string"?i=t:(i=t[0],s=t[1]):s=t),{prefix:e.prefix,startSecondaryKey:i,startKey:s,startExclusive:n,limit:e.limit,indexName:e.indexName}}var Ly=class extends Error{constructor(){super("Transaction is closed")}};function zr(e){if(e.closed)throw new Ly}function Ay(e){return e.closed?Promise.reject(new Ly):void 0}var ko,Io,Co,Do,Ys,Nc,fp,M0=(fp=class{constructor(e,t,n,s){h(this,Ys);h(this,ko);h(this,Io);h(this,Co);h(this,Do);d(this,ko,e),d(this,Io,t),d(this,Co,n),d(this,Do,s)}[Symbol.asyncIterator](){return this.values()}values(){return new ah(p(this,Ys,Nc).call(this,e=>e[1]))}keys(){return new ah(p(this,Ys,Nc).call(this,e=>e[0]))}entries(){return new ah(p(this,Ys,Nc).call(this,e=>[e[0],e[1]]))}toArray(){return this.values().toArray()}},ko=new WeakMap,Io=new WeakMap,Co=new WeakMap,Do=new WeakMap,Ys=new WeakSet,Nc=function(e){return N0(e,r(this,ko),r(this,Io),r(this,Co),r(this,Do))},fp),Rn,pp,ah=(pp=class{constructor(e){h(this,Rn);d(this,Rn,e)}next(){return r(this,Rn).next()}[Symbol.asyncIterator](){return r(this,Rn)[Symbol.asyncIterator]()}toArray(){return Py(r(this,Rn))}},Rn=new WeakMap,pp);async function*N0(e,t,n,s,i){var l;zr(s);let{limit:o=1/0}=n;const{prefix:a=""}=n;let c=(l=n.start)==null?void 0:l.exclusive;const u=Hy(n);for await(const m of t){const y=m[0];if(!(u?y[0]:y).startsWith(a))return;if(c){if(c=!0,u){if(R0(y,n.start.key))continue}else if(O0(y,n.start.key))continue}if(yield e(m),--o===0){u||i(y);return}}}function R0(e,t){const[n,s]=Bh(t),[i,o]=Bh(e);return i!==n?!1:s===void 0?!0:o===s}function O0(e,t){return e===t}function T0(e){const{prefix:t,start:n}=e;let s="";if(t!==void 0&&(s=qd(t,void 0)),!n)return s;const{key:i}=n,[o,a]=Bh(i),c=qd(o,a);return Gl(c,s)?c:s}var P0=0,Fy=class{constructor(e,t,n,s="openReadTransaction"){v(this,"clientID");v(this,"dbtx");v(this,"_lc");v(this,"location");v(this,"environment");this.clientID=e,this.dbtx=t,this._lc=n.withContext(s).withContext("txid",P0++),this.environment="client",this.location="client"}get(e){return Ay(this.dbtx)||this.dbtx.get(e)}async has(e){return zr(this.dbtx),this.dbtx.has(e)}async isEmpty(){return zr(this.dbtx),this.dbtx.isEmpty()}scan(e){return $y(e,this.dbtx,H0)}};function H0(e){}function $y(e,t,n){const s=A0(t,e);return $0(s,e??{},t,n)}var Zs,ei,$e,mp,L0=(mp=class{constructor(e){h(this,Zs,new Set);h(this,ei,[]);h(this,$e);d(this,$e,e)}get environment(){return r(this,$e).location}get location(){return r(this,$e).location}get clientID(){return r(this,$e).clientID}isEmpty(){return r(this,ei).push({options:{}}),r(this,$e).isEmpty()}get(e){return r(this,Zs).add(e),r(this,$e).get(e)}has(e){return r(this,Zs).add(e),r(this,$e).has(e)}scan(e){const t={options:x0(e),inclusiveLimitKey:void 0};return r(this,ei).push(t),$y(e,r(this,$e).dbtx,n=>{t.inclusiveLimitKey=n})}get keys(){return r(this,Zs)}get scans(){return r(this,ei)}},Zs=new WeakMap,ei=new WeakMap,$e=new WeakMap,mp),Vy=class extends Fy{constructor(t,n,s,i,o,a="openWriteTransaction"){super(t,i,o,a);v(this,"reason");v(this,"mutationID");this.mutationID=n,this.reason=s}put(t,n){return this.set(t,n)}async set(t,n){zr(this.dbtx),await this.dbtx.put(this._lc,t,n)}del(t){return Ay(this.dbtx)??this.dbtx.del(this._lc,t)}};function A0(e,t){return t&&Hy(t)?V0(e,t):e.map.scan(F0(t))}function F0(e){if(!e)return"";const{prefix:t="",start:n}=e;return n&&Gl(n.key,t)?n.key:t}function $0(e,t,n,s){return new M0(e,t,n,s)}async function*V0(e,t){const n=e.getMapForIndex(t.indexName);for await(const s of n.scan(T0(t)))yield[Vu(s[0]),s[1]]}function Br(e,t){return Py(t.diff(e))}var On,$t,Tn,Cr,yp,Gu=(yp=class extends Mt{constructor(t,n,s=Ee,i=8*1024,o=16*1024,a=ay,c){super(t,n,s,a,c);h(this,Tn);h(this,On,new tc);h(this,$t,new Map);v(this,"minSize");v(this,"maxSize");this.minSize=i,this.maxSize=o}updateNode(t){g(t.isMutable),r(this,$t).delete(t.hash),t.hash=ut(),p(this,Tn,Cr).call(this,t)}newInternalNodeImpl(t,n){const s=new Dy(t,ut(),n,!0);return p(this,Tn,Cr).call(this,s),s}newDataNodeImpl(t){const n=new $u(t,ut(),!0);return p(this,Tn,Cr).call(this,n),n}newNodeImpl(t,n){const s=Ey(t,ut(),n,!0);return p(this,Tn,Cr).call(this,s),s}put(t,n){return r(this,On).withLock(async()=>{const s=await this.getNode(this.rootHash),i=this.getEntrySize(t,n),o=await s.set(t,n,i,this);if(o.getChildNodeSize(this)>this.maxSize){const a=this.chunkHeaderSize,c=_y(o.entries,y=>y[2],this.minSize-a,this.maxSize-a),{level:u}=o,l=c.map(y=>{const w=this.newNodeImpl(y,u);return Ec(w,this.getEntrySize)}),m=this.newInternalNodeImpl(l,u+1);this.rootHash=m.hash;return}this.rootHash=o.hash})}del(t){return r(this,On).withLock(async()=>{const s=await(await this.getNode(this.rootHash)).del(t,this),i=this.rootHash!==s.hash;return i&&(s.level>0&&s.entries.length===1?this.rootHash=s.entries[0][1]:this.rootHash=s.hash),i})}clear(){return r(this,On).withLock(()=>{r(this,$t).clear(),this.rootHash=Ee})}flush(){return r(this,On).withLock(async()=>{const t=this._dagRead;if(this.rootHash===Ee){const i=t.createChunk(xy,[]);return await t.putChunk(i),i.hash}const n=[],s=Gy(this.rootHash,n,t.createChunk,r(this,$t),this._formatVersion);return await Promise.all(n.map(i=>t.putChunk(i))),r(this,$t).clear(),this.rootHash=s,s})}},On=new WeakMap,$t=new WeakMap,Tn=new WeakSet,Cr=function(t){g(t.isMutable),r(this,$t).set(t.hash,t),this._cache.set(t.hash,t)},yp);function Gy(e,t,n,s,i){const o=s.get(e);if(o===void 0)return e;if(ru(o)){const l=n(Bd(o,i),[]);return t.push(l),l.hash}const a=[],{entries:c}=o;for(let l=0;l<c.length;l++){const m=c[l],y=m[1],w=Gy(y,t,n,s,i);w!==y&&(c[l]=[m[0],w,m[2]]),a.push(w)}const u=n(Bd(o,i),Au(a));return t.push(u),u.hash}function Qd(e){let t;return()=>(t===void 0&&(t=e()),t)}var sd=class extends Map{set(e,t){return t.length===0?this:super.set(e,t)}};async function G0(e,t,n,s,i){const o=new sd;if(!s.shouldComputeDiffs())return o;const a=new Mt(n,i,e.valueHash),c=new Mt(n,i,t.valueHash),u=await Br(a,c);return o.set("",u),await jy(e,t,n,o,s,i),o}async function jy(e,t,n,s,i,o){const a=au(e,n,o),c=au(t,n,o);for(const[u,l]of a){if(!i.shouldComputeDiffsForIndex(u))continue;const m=c.get(u);if(m!==void 0){g(m!==l);const y=await Br(l.map,m.map);c.delete(u),s.set(u,y)}else{const y=await ou(l.map,"del");s.set(u,y)}}for(const[u,l]of c){if(!i.shouldComputeDiffsForIndex(u))continue;const m=await ou(l.map,"add");s.set(u,m)}}var ne,Vt,ti,ni,Gt,gu,By,wp,zy=(wp=class extends Oy{constructor(t,n,s,i,o,a,c){super(t,n,o);h(this,gu);h(this,ne);h(this,Vt);h(this,ti);h(this,ni);h(this,Gt);d(this,ne,t),d(this,Vt,s),d(this,ti,i),d(this,ni,a),d(this,Gt,c),g(s===void 0?i.basisHash===Ee:i.basisHash===s.chunk.hash)}async put(t,n,s){const i=Qd(()=>this.map.get(n));await Jd(t,this.indexes,n,i,s),await this.map.put(n,s)}getMutationID(){return Zl(r(this,ni),r(this,ne),r(this,ti))}async del(t,n){const s=Qd(()=>this.map.get(n));return s!==void 0&&await Jd(t,this.indexes,n,s,void 0),this.map.del(n)}async clear(){await this.map.clear();const t=[];for(const n of this.indexes.values())t.push(n.clear());await Promise.all(t)}async putCommit(){const t=await this.map.flush(),n=[];for(const o of this.indexes.values()){const a=await o.flush(),c={definition:o.meta.definition,valueHash:a};n.push(c)}let s;const i=r(this,ti);switch(i.type){case pr:{g(r(this,Gt)>=nu);const{basisHash:o,mutationID:a,mutatorName:c,mutatorArgsJSON:u,originalHash:l,timestamp:m}=i;s=l0(r(this,ne).createChunk,o,await py(o,r(this,ne)),a,c,u,l,t,n,m,r(this,ni));break}case mr:{g(r(this,Gt)>nu);const{basisHash:o,lastMutationIDs:a,cookieJSON:c}=i;s=d0(r(this,ne).createChunk,o,a,c,t,n);break}}return await r(this,ne).putChunk(s.chunk),s}async commit(t){const s=(await this.putCommit()).chunk.hash;return await r(this,ne).setHead(t,s),await r(this,ne).commit(),s}async commitWithDiffs(t,n){const s=this.putCommit(),i=await p(this,gu,By).call(this,n),o=(await s).chunk.hash;return await r(this,ne).setHead(t,o),await r(this,ne).commit(),i}close(){r(this,ne).release()}},ne=new WeakMap,Vt=new WeakMap,ti=new WeakMap,ni=new WeakMap,Gt=new WeakMap,gu=new WeakSet,By=async function(t){const n=new sd;if(!t.shouldComputeDiffs())return n;let s=[];if(r(this,Vt)){const o=new Mt(r(this,ne),r(this,Gt),r(this,Vt).valueHash);s=await Br(o,this.map)}n.set("",s);let i;r(this,Vt)?i=au(r(this,Vt),r(this,ne),r(this,Gt)):i=new Map;for(const[o,a]of this.indexes){if(!t.shouldComputeDiffsForIndex(o))continue;const c=i.get(o);g(a!==c);const u=await(c?Br(c.map,a.map):ou(a.map,"add"));n.set(o,u)}for(const[o,a]of i)if(!this.indexes.has(o)&&t.shouldComputeDiffsForIndex(o)){const c=await ou(a.map,"del");n.set(o,c)}return n},wp);async function Ky(e,t,n,s,i,o,a,c){const u=await J(e,i),l=new Gu(i,c,u.valueHash),m=await u.getNextMutationID(a,i),y=Uy(u,i,c);return g(c>=nu),new zy(i,l,u,{type:pr,basisHash:e,baseSnapshotHash:await py(e,i),mutatorName:t,mutatorArgsJSON:n,mutationID:m,originalHash:s,timestamp:o,clientID:a},y,a,c)}async function j0(e,t,n,s,i,o){const a=await J(e,s),c=new Gu(s,o,a.valueHash);return new zy(s,c,a,{basisHash:e,type:mr,lastMutationIDs:t,cookieJSON:n},Uy(a,s,o),i,o)}async function Jd(e,t,n,s,i){const o=[];for(const a of t.values()){const{keyPrefix:c}=a.meta.definition;if(!c||n.startsWith(c)){const u=await s();u!==void 0&&o.push(Gh(e,a.map,My,n,u,a.meta.definition.jsonPointer,a.meta.definition.allowEmpty??!1)),i!==void 0&&o.push(Gh(e,a.map,nd,n,i,a.meta.definition.jsonPointer,a.meta.definition.allowEmpty??!1))}}await Promise.all(o)}function Uy(e,t,n){const s=new Map;for(const i of e.indexes)s.set(i.definition.name,new k0(i,new Gu(t,n,i.valueHash)));return s}async function z0(e,t,n,s,i,o,a){const c=new Gu(t,a);for await(const u of n.scan(s)){const l=u[0];if(!l.startsWith(s))break;await Gh(e,c,nd,l,u[1],i,o)}return c}async function qy(e,t,n,s,i,o,a){var S;const c=e.meta,u=c.mutatorName;Fu(c)&&g(c.clientID===o,"mutationClientID must match clientID of LocalMeta");const l=s[u];l||(S=i.error)==null||S.call(i,`Cannot rebase unknown mutator ${u}`);const m=l||(async()=>{}),y=c.mutatorArgsJSON,b=await(await J(n,t)).getNextMutationID(o,t);if(b!==c.mutationID)throw new Error(`Inconsistent mutation ID: original: ${c.mutationID}, next: ${b} - mutationClientID: ${o} mutatorName: ${u}`);o0(c);const C=await Ky(n,u,y,e.chunk.hash,t,c.timestamp,o,a),k=new Vy(o,await C.getMutationID(),"rebase",C,i);return await m(k,y),C}async function Qy(e,t,n,s,i,o,a){return(await qy(e,t,n,s,i,o,a)).putCommit()}async function B0(e,t,n,s,i,o,a,c){return(await qy(e,t,n,i,o,a,c)).commit(s)}function K0(e){async function t(n,s){const[i,o]=await Em(e.pushURL,e.auth,s,n);if(!i)return{httpRequestInfo:o};const a={httpRequestInfo:o};let c;try{c=await i.json()}catch{return a}return(_s(c)||xs(c))&&(a.response=c),a}return Jy.add(t),t}var Jy=new WeakSet;function U0(e){return Jy.has(e)}var q0=W({prefix:f.string().optional(),jsonPointer:f.string(),allowEmpty:f.boolean().optional()}),Q0=sc(q0);function J0(e,t){return e.jsonPointer===t.jsonPointer&&(e.allowEmpty??!1)===(t.allowEmpty??!1)&&(e.prefix??"")===(t.prefix??"")}function Wy(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const[n,s]of Object.entries(e)){const i=t[n];if(!i||!J0(s,i))return!1}return!0}var W0=W({headHash:dr,mutatorNames:_e(f.string()),indexes:Q0,mutationIDs:sc(f.number()),lastServerAckdMutationIDs:f.record(f.number()),disabled:f.boolean()}),Xy="client-groups";function X0(e){nc(e,W0)}function Y0(e){ee(e);const t=new Map;for(const[n,s]of Object.entries(e))s!==void 0&&(X0(s),t.set(n,s));return t}function Z0(e,t){const n={};for(const[s,i]of e.entries())t.assertValidHash(i.headHash),n[s]={...i,mutatorNames:[...i.mutatorNames.values()]};return n}async function ek(e,t){const n=await t.getChunk(e);return Y0(n==null?void 0:n.data)}async function yr(e){const t=await e.getHead(Xy);return t?ek(t,e):new Map}async function tk(e,t){const n=await yr(t);for(const[s,i]of e){const o=n.get(s);Yy(i,o)}return Zy(e,t)}async function id(e,t,n){const s=await yr(n),i=s.get(e);Yy(t,i);const o=new Map(s);return o.set(e,t),Zy(o,n)}function Yy(e,t){const n=new Set(e.mutatorNames);g(n.size===e.mutatorNames.length,"A client group's mutatorNames must be a set."),t!==void 0&&(g(Wy(t.indexes,e.indexes),"A client group's index definitions must never change."),g(ew(n,t.mutatorNames),"A client group's mutatorNames must never change."))}async function Zy(e,t){const n=Z0(e,t),s=new Set;for(const o of e.values())s.add(o.headHash);const i=t.createChunk(n,Au(s));return await t.putChunk(i),await t.setHead(Xy,i.hash),e}function ew(e,t){if(t.length!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;return!0}async function ju(e,t){return(await yr(t)).get(e)}function tw(e){for(const[t,n]of Object.entries(e.mutationIDs)){const s=e.lastServerAckdMutationIDs[t];if(s===void 0&&n!==0||s<n)return!0}return!1}async function nk(e,t){const n=await ju(e,t);if(!n)return;const s={...n,disabled:!0};await id(e,s,t)}function cu(e){return e instanceof Error?e:new Error(String(e))}function pe(e,t){return rd(e.read(),t)}function uu(e,t){return rd(e.write(),t)}function Z(e,t){return rd(e.write(),async n=>{const s=await t(n);return await n.commit(),s})}async function rd(e,t){const n=await e;try{return await t(n)}finally{n.release()}}var od=0,sk=1,nw=2;async function ik(e,t,n){const s=[];function i(o,a,c){a===void 0?s.push({op:"add",key:o,newValue:c}):s.push({op:"change",key:o,oldValue:a,newValue:c})}for(const o of n)switch(o.op){case"put":{const a=await t.get(o.key),c=o.value;i(o.key,a,c),await t.put(e,o.key,c);break}case"update":{const a=await t.get(o.key),c=[],u=m=>{for(const[y,w]of Object.entries(m))(!o.constrain||o.constrain.length===0||o.constrain.indexOf(y)>-1)&&c.push([y,w])};a!==void 0&&(ee(a),u(a)),o.merge&&u(o.merge);const l=Object.fromEntries(c);i(o.key,a,l),await t.put(e,o.key,l);break}case"del":{const a=await t.get(o.key);if(a===void 0)continue;await t.del(e,o.key),s.push({op:"del",key:o.key,oldValue:a});break}case"clear":await t.clear(),s.push({op:"clear"});break}return s}var sw=class extends Error{constructor(t){super("Failed to pull");v(this,"name","PullError");v(this,"causedBy");this.causedBy=t}},hu="sync",rk=1;async function ok(e,t,n,s,i,o,a,c,u,l=!0){const m=await pe(a,async k=>{const S=await k.getHead(fe);if(!S)throw new Error("Internal no main head found");const D=(await xt(S,k)).meta;return td(D),D.cookieJSON}),y={profileID:e,clientGroupID:n,cookie:m,pullVersion:rk,schemaVersion:s},{response:w,httpRequestInfo:b}=await ak(u,i,y,o);if(!w)return{httpRequestInfo:b,syncHead:Ee};if(!l||qS(w))return{httpRequestInfo:b,pullResponse:w,syncHead:Ee};const C=await iw(u,a,m,w,t,c);return{httpRequestInfo:b,pullResponse:w,syncHead:C.type===od?C.syncHead:Ee}}async function ak(e,t,n,s){var a,c;(a=e.debug)==null||a.call(e,"Starting pull...");const i=Date.now();let o;try{o=await t(n,s),(c=e.debug)==null||c.call(e,`...Pull ${o.response?"complete":"failed"} in `,Date.now()-i,"ms")}catch(u){throw new sw(cu(u))}try{return tb(o),o}catch(u){throw new ld("Invalid puller result",cu(u))}}function Wd(e,t,n){return`Received ${e} ${t} is < than last snapshot ${e} ${n}; ignoring client view`}function iw(e,t,n,s,i,o){return uu(t,async a=>{var k,S,I;const c=a,u=await c.getHead(fe);if(u===void 0)throw new Error("Main head disappeared");const l=await xt(u,c),m=l.meta;td(m);const y=m.cookieJSON;if(!ds(n,y))return(k=e.debug)==null||k.call(e,"handlePullResponse: cookie mismatch, response is not applicable"),{type:nw};for(const[D,N]of Object.entries(s.lastMutationIDChanges)){const x=m.lastMutationIDs[D];if(x!==void 0&&N<x)throw new Error(Wd(`${D} lastMutationID`,String(N),String(x)))}const w=s.cookie;if(ql(w,y)<0)throw new Error(Wd("cookie",JSON.stringify(w),JSON.stringify(y)));if(ds(w,y))return s.patch.length>0&&((S=e.error)==null||S.call(e,`handlePullResponse: cookie ${JSON.stringify(y)} did not change, but patch is not empty`)),Object.keys(s.lastMutationIDChanges).length>0&&((I=e.error)==null||I.call(e,`handlePullResponse: cookie ${JSON.stringify(y)} did not change, but lastMutationIDChanges is not empty`)),{type:sk};const b=await j0(l.chunk.hash,{...m.lastMutationIDs,...s.lastMutationIDChanges},w,a,i,o),C=await ik(e,b,s.patch);return{type:od,syncHead:await b.commit(hu),diffs:C}})}function ck(e,t,n,s,i,o){return uu(e,async a=>{var N;const c=a,u=await c.getHead(hu);if(u===void 0)throw new Error("Missing sync head");if(u!==n)throw(N=t.error)==null||N.call(t,"maybeEndPull, Wrong sync head. Expecting:",n,"got:",u),new Error("Wrong sync head");const l=await xt(u,c),m=await c.getHead(fe);if(m===void 0)throw new Error("Missing main head");const y=await xt(m,c),{meta:w}=l,b=w.basisHash;if(l===null)throw new Error("Sync snapshot with no basis");if(b!==y.chunk.hash)throw new Error("Overlapping syncs");const C=await J(u,c),k=[],S=await ly(m,c);for(const x of S){let T=s;g(ic(x)),T=x.meta.clientID,await x.getMutationID(T,c)>await C.getMutationID(T,c)&&k.push(x)}k.reverse();const I=new sd;if(k.length>0)return{syncHead:u,replayMutations:k,diffs:I};const D=await J(m,c);if(i.shouldComputeDiffs()){const x=new Mt(c,o,D.valueHash),T=new Mt(c,o,C.valueHash),E=await Br(x,T);I.set("",E),await jy(D,C,c,I,i,o)}if(await Promise.all([a.setHead(fe,u),a.removeHead(hu)]),await a.commit(),t.debug){const[x,T]=jd(y,s),[E,O]=jd(l,s);t.debug("Successfully pulled new snapshot with lastMutationID:",E,"(prev:",x,"), cookie: ",O,"(prev:",T,"), sync head hash:",u,", main head hash:",m,", valueHash:",C.valueHash,"(prev:",y.valueHash)}return{syncHead:u,replayMutations:[],diffs:I}})}var ad=f.unknown().chain(e=>ec(e)),uk=f.unknown().chain(e=>ec(e));function hk(e){ee(e),Rm(e.httpRequestInfo),e.response!==void 0&&lk(e.response)}function lk(e){_s(e)||QS(e)}var rw=class extends Error{constructor(t){super("Failed to push");v(this,"name","PushError");v(this,"causedBy");this.causedBy=t}},cd=f.string(),dk=f.string(),Kh=1,fk=W({id:f.number(),name:f.string(),args:ad,timestamp:f.number(),clientID:dk});f.object({pushVersion:f.literal(1),schemaVersion:f.string(),profileID:f.string(),clientGroupID:cd,mutations:f.array(fk)});function pk(e){return{id:e.mutationID,name:e.mutatorName,args:e.mutatorArgsJSON,timestamp:e.timestamp,clientID:e.clientID}}async function mk(e,t,n,s,i,o,a,c,u){var C,k;const l=await pe(t,async S=>{const I=await S.getHead(fe);if(!I)throw new Error("Internal no main head");return ly(I,S)});if(l.length===0)return;l.reverse(),g(u===Kh);const m=[];for(const S of l)if(ic(S))m.push(pk(S.meta));else throw new Error("Internal non local pending commit");g(i);const y={profileID:s,clientGroupID:i,mutations:m,pushVersion:Kh,schemaVersion:c};(C=n.debug)==null||C.call(n,"Starting push...");const w=Date.now(),b=await yk(a,y,e);return(k=n.debug)==null||k.call(n,"...Push complete in ",Date.now()-w,"ms"),b}async function yk(e,t,n){let s;try{s=await e(t,n)}catch(i){throw new rw(cu(i))}try{return hk(s),s}catch(i){throw new ld("Invalid pusher result",cu(i))}}var wk=class{constructor(e){v(this,"name");v(this,"onmessage",null);v(this,"onmessageerror",null);this.name=e}addEventListener(){}removeEventListener(){}dispatchEvent(){return!1}close(){}postMessage(){}},Uh=typeof BroadcastChannel>"u"?wk:BroadcastChannel;function vk(e){return`replicache-new-client-group:${e}`}function gk(e){return`replicache-new-client-group-v1:${e}`}function Sk(e){return typeof e=="object"&&typeof e.clientGroupID=="string"&&typeof e.idbName=="string"}function bk(e,t,n,s,i,o,a){if(n.aborted)return;const c=new Uh(gk(e));if(i){c.postMessage({clientGroupID:s,idbName:t});const u=new Uh(vk(e));u.postMessage([s]),u.close()}c.onmessage=async u=>{const{data:l}=u;if(Sk(l)){const{clientGroupID:m,idbName:y}=l;if(m!==s)if(y===t)await pe(a,async b=>await ju(m,b)!==void 0)&&o();else{o();return}}},n.addEventListener("abort",()=>c.close(),{once:!0})}function kk(e){return`replicache-on-persist:${e}`}function Ik(e){ee(e),j(e.clientGroupID),j(e.clientID)}function Ck(e,t,n){if(t.aborted)return()=>{};const s=new Uh(kk(e));return s.onmessage=i=>{const{data:o}=i;Ik(o),n({clientGroupID:o.clientGroupID,clientID:o.clientID})},t.addEventListener("abort",()=>s.close(),{once:!0}),i=>{t.aborted||(s.postMessage(i),n(i))}}async function Dk(e){const t=await Wl(fe,e);return(await dy(t,e)).map(s=>({id:s.meta.mutationID,name:s.meta.mutatorName,args:s.meta.mutatorArgsJSON,clientID:s.meta.clientID})).reverse()}function ud(){const t=kh(),n=kh();return(t<<64n|n).toString(32).slice(-18).padStart(18,"0")}var Ek=W({heartbeatTimestampMs:f.number(),headHash:dr,tempRefreshHash:dr.nullable(),clientGroupID:cd}),ow=W({heartbeatTimestampMs:f.number(),refreshHashes:_e(dr),persistHash:dr.nullable(),clientGroupID:cd});function aw(e){return e.refreshHashes!==void 0}var cw="clients",_k=f.union(Ek,ow);function xk(e){nc(e,_k)}function uw(e){nc(e,ow)}function Mk(e){ee(e);const t=new Map;for(const n in e)if(ls(e,n)){const s=e[n];s!==void 0&&(xk(s),t.set(n,s))}return t}function Nk(e,t){for(const n of e.values())aw(n)?(n.refreshHashes.forEach(t.assertValidHash),n.persistHash&&t.assertValidHash(n.persistHash)):(t.assertValidHash(n.headHash),n.tempRefreshHash&&t.assertValidHash(n.tempRefreshHash));return Object.fromEntries(e)}async function ys(e){const t=await e.getHead(cw);return Rk(t,e)}async function Rk(e,t){if(!e)return new Map;const n=await t.getChunk(e);return Mk(n==null?void 0:n.data)}var hn=class extends Error{constructor(t){super(`Client state not found, id: ${t}`);v(this,"name","ClientStateNotFoundError");v(this,"id");this.id=t}};async function Ok(e,t){if(!await hw(e,t))throw new hn(e)}async function hw(e,t){return!!await hd(e,t)}async function hd(e,t){return(await ys(t)).get(e)}async function qh(e,t){const n=await hd(e,t);if(!n)throw new hn(e);return n}function Tk(e,t,n,s,i,o,a){return Z(n,async c=>{async function u(S,I,D,N){const x=yy(S,{},I,D,N),T=c.createChunk(x,vy(x)),E=ud(),O={heartbeatTimestampMs:Date.now(),refreshHashes:[T.hash],persistHash:null,clientGroupID:E},H=new Map(l).set(e,O),P={headHash:T.hash,mutatorNames:s,indexes:i,mutationIDs:{},lastServerAckdMutationIDs:{},disabled:!1};return await Promise.all([c.putChunk(T),Kr(H,c),id(E,P,c)]),[O,T.hash,H,!0]}const l=await ys(c),m=await Hk(c,s,i);if(m.type===fw){const{clientGroupID:S,headHash:I}=m,D={clientGroupID:S,refreshHashes:[I],heartbeatTimestampMs:Date.now(),persistHash:null},N=new Map(l).set(e,D);return await Kr(N,c),[D,I,N,!1]}if(!a||m.type===lw){const S=c.createChunk(xy,[]);await c.putChunk(S);const I=[];for(const[D,N]of Object.entries(i)){const x=h0(D,N);I.push({definition:x,valueHash:S.hash})}return u(null,null,S.hash,I)}g(m.type===dw);const{snapshot:y}=m,w=[],{valueHash:b,indexes:C}=y,k=new Mt(c,o,b);for(const[S,I]of Object.entries(i)){const{prefix:D="",jsonPointer:N,allowEmpty:x=!1}=I,T={name:S,keyPrefix:D,jsonPointer:N,allowEmpty:x},E=Pk(C,T);if(E)w.push({definition:T,valueHash:E.valueHash});else{const O=await z0(t,c,k,D,N,x,o);w.push({definition:T,valueHash:await O.flush()})}}return u(y.meta.basisHash,y.meta.cookieJSON,y.valueHash,w)})}function Pk(e,t){return e.find(n=>u0(n.definition,t))}var lw=0,dw=1,fw=2;async function Hk(e,t,n){let s,i;const o=new Set(t),a=await yr(e);for(const[c,u]of a){if(!u.disabled&&ew(o,u.mutatorNames)&&Wy(n,u.indexes))return{type:fw,clientGroupID:c,headHash:u.headHash};const l=await xt(u.headHash,e);as(l);const{cookieJSON:m}=l.meta;(s===void 0||ql(m,s)>0)&&(s=m,i=l)}return i?{type:dw,snapshot:i}:{type:lw}}function Lk(e){const t=new Set;for(const n of e.values())if(aw(n)){for(const s of n.refreshHashes)t.add(s);n.persistHash&&t.add(n.persistHash)}else t.add(n.headHash),n.tempRefreshHash&&t.add(n.tempRefreshHash);return Au(t)}async function Ak(e,t){const n=await pw(e,t);if(n)return ju(n,t)}async function pw(e,t){const n=await hd(e,t);return n==null?void 0:n.clientGroupID}async function Qh(e,t,n){const s=await ys(n),i=new Map(s).set(e,t);return Kr(i,n)}async function Kr(e,t){const n=Nk(e,t),s=t.createChunk(n,Lk(e));return await t.putChunk(s),await t.setHead(cw,s.hash),s.hash}var Fk=24*60*60*1e3,mw=5*60*1e3,Xd;function $k(e,t,n,s,i,o,a){Hu("ClientGC",()=>(Xd=Vk(e,t,n,i),Xd),()=>s,o,a)}function Vk(e,t,n,s){return Z(t,async i=>{const o=Date.now(),a=await ys(i),c=[],u=new Map;for(const[y,w]of a)y===e||o-w.heartbeatTimestampMs<=n?u.set(y,w):c.push(y);if(u.size===a.size)return a;await Kr(u,i);const{clientIDs:l,clientGroupIDs:m}=await Xm(i,c,[]);return s(l,m),u})}var Gk=5*60*1e3,Yd;function jk(e,t,n,s,i){Hu("ClientGroupGC",()=>(Yd=zk(e,t,n),Yd),()=>Gk,s,i)}function zk(e,t,n){return Z(e,async s=>{const i=await ys(s),o=new Set;for(const u of i.values())o.add(u.clientGroupID);const a=new Map,c=new Set;for(const[u,l]of await yr(s))o.has(u)||t&&tw(l)?a.set(u,l):c.add(u);return await tk(a,s),n([],[...c].sort()),a})}var yw=60*1e3,Zd;function Bk(e,t,n,s,i,o){Hu("Heartbeat",async()=>{Zd=Kk(e,t);try{return await Zd}catch(a){if(a instanceof hn){n();return}throw a}},()=>s,i,o)}function Kk(e,t){return Z(t,async n=>{const s=await ys(n),i=s.get(e);if(!i)throw new hn(e);const o={...i,heartbeatTimestampMs:Date.now()},a=new Map(s).set(e,o);return await Kr(a,n),a})}var Uk=0,qk="replicache-dbs-v"+Uk,Qk="";function Jk(){return Qk+qk}var Rc="dbs",ef="profileId";function Wk(e){ee(e);for(const[t,n]of Object.entries(e))j(t),Xk(n),g(t===n.name)}function Xk(e){ee(e),j(e.name),j(e.replicacheName),He(e.replicacheFormatVersion),j(e.schemaVersion),e.lastOpenedTimestampMS!==void 0&&He(e.lastOpenedTimestampMS)}var Je,Eo,Jh,vp,ww=(vp=class{constructor(e){h(this,Eo);h(this,Je);d(this,Je,e(Jk()))}putDatabase(e){return p(this,Eo,Jh).call(this,{...e,lastOpenedTimestampMS:Date.now()})}putDatabaseForTesting(e){return p(this,Eo,Jh).call(this,e)}clearDatabases(){return Z(r(this,Je),e=>e.del(Rc))}deleteDatabases(e){return Z(r(this,Je),async t=>{const s={...await ch(t)};for(const i of e)delete s[i];await t.put(Rc,s)})}getDatabases(){return pe(r(this,Je),ch)}close(){return r(this,Je).close()}getProfileID(){return Z(r(this,Je),async e=>{let t=await e.get(ef);return t===void 0&&(t=`p${ud()}`,await e.put(ef,t)),j(t),t})}},Je=new WeakMap,Eo=new WeakSet,Jh=function(e){return Z(r(this,Je),async t=>{const s={...await ch(t),[e.name]:e};return await t.put(Rc,s),s})},vp);async function ch(e){let t=await e.get(Rc);return t||(t={}),Wk(t),t}var _o,xo,gp,vw=(gp=class{constructor(e){h(this,_o,new Set);h(this,xo);d(this,xo,e)}async visit(e){if(r(this,_o).has(e))return;r(this,_o).add(e);const t=await r(this,xo).mustGetChunk(e);await this.visitChunk(t)}async visitChunk(e){await Promise.all(e.meta.map(t=>this.visit(t)))}},_o=new WeakMap,xo=new WeakMap,gp),Mo,No,Sp,Yk=(Sp=class extends vw{constructor(t){super(t);h(this,Mo,new Map);h(this,No);d(this,No,t)}get gatheredChunks(){return r(this,Mo)}visit(t){return r(this,No).isMemOnlyChunkHash(t)?super.visit(t):ie}visitChunk(t){return r(this,Mo).set(t.hash,t),super.visitChunk(t)}},Mo=new WeakMap,No=new WeakMap,Sp);async function Zk(e,t,n,s,i,o,a,c=()=>Promise.resolve()){if(o())return;const[u,l,m]=await pe(s,async k=>{await Ok(t,k);const S=await pw(t,k);g(S,`No main client group for clientID: ${t}`);const[,I]=await tf(k,S),D=await I.getMutationID(t,k),N=await Tr(I,k);return as(N),[D,N,S]});if(o())return;const[y,w,b]=await pe(n,async k=>{const S=await ed(fe,k),I=await fy(S,{[t]:u||0},k),D=await Tr(S,k);as(D);let N;if(Hh(D,l)>0){await c();const x=D.chunk.hash,T=new Yk(k);await T.visit(x),N=T.gatheredChunks}return[I,D,N]});if(o())return;let C=!1;await Z(s,async k=>{const[S,I]=await tf(k,m);let D=I.chunk.hash,N={...S.mutationIDs},{lastServerAckdMutationIDs:x}=S;if(b){const E=await qh(t,k);uw(E);const O=await Tr(I,k);if(as(O),Hh(w,O)>0){C=!0,await Promise.all(Array.from(b.values(),P=>k.putChunk(P))),await Qh(t,{...E,persistHash:w.chunk.hash},k),D=w.chunk.hash;const H=await dy(S.headHash,k);x=w.meta.lastMutationIDs,N={...x},D=await nf(H,D,k,i,N,e,a)}}D=await nf(y,D,k,i,N,e,a);const T={...S,headHash:D,mutationIDs:N,lastServerAckdMutationIDs:x};await id(m,T,k)}),b&&C&&await Z(n,k=>k.chunksPersisted([...b.keys()]))}async function tf(e,t){const n=await ju(t,e);return g(n,`No client group for clientGroupID: ${t}`),[n,await J(n.headHash,e)]}async function nf(e,t,n,s,i,o,a){for(let c=e.length-1;c>=0;c--){const u=e[c],{meta:l}=u,m=await J(t,n);await u.getMutationID(l.clientID,n)>await m.getMutationID(l.clientID,n)&&(i[l.clientID]=l.mutationID,t=(await Qy(u,n,t,s,o,l.clientID,a)).chunk.hash)}return t}var Ro,si,Oo,ii,To,bp,eI=(bp=class extends vw{constructor(t,n,s,i=os){super(t);h(this,Ro,new Map);h(this,si,0);h(this,Oo);h(this,ii);h(this,To);d(this,Oo,n),d(this,ii,s),d(this,To,i)}get gatheredChunks(){return r(this,Ro)}visit(t){return r(this,si)>=r(this,ii)||r(this,Oo).isCached(t)?ie:super.visit(t)}visitChunk(t){if(r(this,si)<r(this,ii)){const n=r(this,To).call(this,t);r(this,Ro).set(t.hash,{chunk:t,size:n}),d(this,si,r(this,si)+n)}return super.visitChunk(t)}},Ro=new WeakMap,si=new WeakMap,Oo=new WeakMap,ii=new WeakMap,To=new WeakMap,bp),tI=5*2**20,nI=300;async function sI(e,t,n,s,i,o,a,c){if(a())return;const u=await pe(t,y=>r0(fe,y));as(u);const l=await t.withSuspendedSourceCacheEvictsAndDeletes(async()=>{const y=await Z(n,async I=>{const D=await Ak(s,I);if(!D)throw new hn(s);const N=D.headHash,T=await(await J(N,I)).getMutationID(s,I),E=await qh(s,I);uw(E);const O=await xt(N,I);if(as(O),sf(u,O,N))return;const H=new eI(I,t,tI);await H.visit(N);const{gatheredChunks:P}=H,xe=new Set(E.refreshHashes);xe.add(N);const Ju={...E,refreshHashes:[...xe]};return await Qh(s,Ju,I),[N,O,T,P,E.refreshHashes]});if(a()||!y)return{type:"aborted"};if(await un(nI),a())return{type:"aborted"};const[w,b,C,k,S]=y;return Z(t,async I=>{const D=await ed(fe,I),N=await Tr(D,I);if(as(N),sf(N,b,w))return{type:"aborted",refreshHashesForRevert:S};const x=await fy(D,{[s]:C},I),T=[];for(const{chunk:P,size:xe}of k.values())T.push(I.putChunk(P,xe));await Promise.all(T);let E=w;for(let P=x.length-1;P>=0;P--)E=(await Qy(x[P],I,E,i,e,x[P].meta.clientID,c)).chunk.hash;const O=await J(E,I),H=await G0(D,O,I,o,c);return await I.setHead(fe,E),{type:"complete",diffs:H,newPerdagClientHeadHash:w}})});if(a())return;const m=y=>Z(n,async w=>{const C={...await qh(s,w),refreshHashes:y};await Qh(s,C,w)});if(l.type==="aborted"){l.refreshHashesForRevert&&await m(l.refreshHashesForRevert);return}return await m([l.newPerdagClientHeadHash]),l.diffs}function sf(e,t,n){const s=Hh(e,t);return s>0||s===0&&n===t.chunk.hash}function iI(e){return new Promise(t=>{typeof requestIdleCallback=="function"?requestIdleCallback(()=>t(),{timeout:e}):setTimeout(()=>t(),e)})}var Po,Ho,Lo,Pn,Ao,Ie,mt,ri,Fo,Su,gw,kp,rf=(kp=class{constructor(e,t,n,s,i=iI){h(this,Su);h(this,Po);h(this,Ho);h(this,Lo);h(this,Pn);h(this,Ao);h(this,Ie);h(this,mt);h(this,ri,Promise.resolve());h(this,Fo,Promise.resolve());d(this,Po,e),d(this,Ho,t),d(this,Lo,n),d(this,Pn,s),d(this,Ao,i),r(this,Pn).addEventListener("abort",()=>{var a,c;const o=new hr("Aborted");(a=r(this,mt))==null||a.reject(o),(c=r(this,Ie))==null||c.reject(o),d(this,mt,void 0),d(this,Ie,void 0)},{once:!0})}schedule(){return r(this,Pn).aborted?Promise.reject(new hr("Aborted")):r(this,Ie)?r(this,Ie).promise:(d(this,Ie,A()),p(this,Su,gw).call(this),r(this,Ie).promise)}},Po=new WeakMap,Ho=new WeakMap,Lo=new WeakMap,Pn=new WeakMap,Ao=new WeakMap,Ie=new WeakMap,mt=new WeakMap,ri=new WeakMap,Fo=new WeakMap,Su=new WeakSet,gw=async function(){var e,t;try{await r(this,ri)}catch{}if(await r(this,Fo),!!r(this,Ie)&&(await r(this,Ao).call(this,r(this,Ho)),!!r(this,Ie))){d(this,Fo,rI(r(this,Lo),r(this,Pn))),d(this,mt,r(this,Ie)),d(this,Ie,void 0);try{d(this,ri,r(this,Po).call(this)),await r(this,ri),(e=r(this,mt))==null||e.resolve()}catch(n){(t=r(this,mt))==null||t.reject(n)}d(this,mt,void 0)}},kp);async function rI(e,t){try{await un(e,t)}catch(n){g(n instanceof hr)}}function oI(e,t,n){if(!n.aborted){const s=setInterval(e,t);n.addEventListener("abort",()=>{clearInterval(s)})}}var Wh=0,aI=1,cI=new Set,of=Symbol(),$o,Vo,oi,Go,ai,jo,Ip,uI=(Ip=class{constructor(e,t,n,s,i=ds){h(this,$o);h(this,Vo);h(this,oi,of);h(this,Go,cI);h(this,ai,[]);v(this,"onError");v(this,"onDone");h(this,jo);d(this,$o,e),d(this,Vo,t),this.onError=n,this.onDone=s,d(this,jo,i)}hasIndexSubscription(e){for(const t of r(this,ai))if(t.options.indexName===e)return!0;return!1}invoke(e,t,n){return r(this,$o).call(this,e)}matches(e){for(const[t,n]of e)if(dI(r(this,Go),r(this,ai),t,n))return!0;return!1}updateDeps(e,t){d(this,Go,e),d(this,ai,t)}onData(e){(r(this,oi)===of||!r(this,jo).call(this,r(this,oi),e))&&(d(this,oi,e),r(this,Vo).call(this,e))}},$o=new WeakMap,Vo=new WeakMap,oi=new WeakMap,Go=new WeakMap,ai=new WeakMap,jo=new WeakMap,Ip),zo,Hn,yt,Bo,Cp,hI=(Cp=class{constructor(e,t){h(this,zo);h(this,Hn);h(this,yt);h(this,Bo);v(this,"onError");v(this,"onDone");d(this,zo,e),d(this,Hn,(t==null?void 0:t.prefix)??""),d(this,yt,t==null?void 0:t.indexName),d(this,Bo,(t==null?void 0:t.initialValuesInFirstDiff)??!1)}hasIndexSubscription(e){return r(this,yt)===e}onData(e){e!==void 0&&r(this,zo).call(this,e)}invoke(e,t,n){const s=async(i,o,a,c)=>{let u;if(t===Wh){if(!r(this,Bo))return;g(n===void 0);const y=[];for await(const w of e.scan({prefix:o,indexName:i}).entries())y.push({op:"add",key:w[0],newValue:w[1]});u=y}else{g(n);const y=n.get(i??"")??[];u=c(y)}const l=[],{length:m}=u;for(let y=bw(u,o,a);y<m&&a(u[y]).startsWith(o);y++)l.push(u[y]);return t===Wh||l.length>0?l:void 0};return r(this,yt)?s(r(this,yt),r(this,Hn),i=>i.key[0],i=>af(i,Vu)):s(void 0,r(this,Hn),i=>i.key,i=>af(i,o=>o))}matches(e){const t=e.get(r(this,yt)??"");return t===void 0?!1:yI(t,r(this,Hn),r(this,yt))}updateDeps(e,t){}},zo=new WeakMap,Hn=new WeakMap,yt=new WeakMap,Bo=new WeakMap,Cp);function af(e,t){return e.map(n=>{const s=t(n.key);switch(n.op){case"add":return{op:"add",key:s,newValue:n.newValue};case"change":return{op:"change",key:s,oldValue:n.oldValue,newValue:n.newValue};case"del":return{op:"del",key:s,oldValue:n.oldValue}}})}var We,ci,Ko,Uo,qo,fs,Xh,Sw,Dp,lI=(Dp=class{constructor(e,t,n){h(this,fs);h(this,We,new Set);h(this,ci,new Set);h(this,Ko);h(this,Uo);v(this,"hasPendingSubscriptionRuns",!1);h(this,qo);d(this,Ko,e),d(this,Uo,t),d(this,qo,n)}add(e){return r(this,We).add(e),p(this,fs,Sw).call(this,e),()=>r(this,We).delete(e)}clear(){var e;for(const t of r(this,We))(e=t.onDone)==null||e.call(t);r(this,We).clear()}fire(e){const t=mI(r(this,We),e);return p(this,fs,Xh).call(this,t,aI,e)}callCallbacks(e,t){var n,s;for(let i=0;i<e.length;i++){const o=e[i],a=t[i];a.status==="fulfilled"?o.onData(a.value):o.onError?o.onError(a.reason):(s=(n=r(this,Uo)).error)==null||s.call(n,"Error in subscription body:",a.reason)}}shouldComputeDiffs(){return r(this,We).size>0}shouldComputeDiffsForIndex(e){for(const t of r(this,We))if(t.hasIndexSubscription(e))return!0;return!1}},We=new WeakMap,ci=new WeakMap,Ko=new WeakMap,Uo=new WeakMap,qo=new WeakMap,fs=new WeakSet,Xh=async function(e,t,n){if(r(this,qo).aborted)return;const s=[...e];if(s.length===0)return;const i=await r(this,Ko).call(this,o=>Promise.allSettled(s.map(async a=>{const c=new L0(o);try{return await a.invoke(c,t,n)}finally{a.updateDeps(c.keys,c.scans)}})));this.callCallbacks(s,i)},Sw=async function(e){if(r(this,ci).add(e),!this.hasPendingSubscriptionRuns){this.hasPendingSubscriptionRuns=!0,await Promise.resolve(),this.hasPendingSubscriptionRuns=!1;const t=[...r(this,ci)];r(this,ci).clear(),await p(this,fs,Xh).call(this,t,Wh,void 0)}},Dp);function dI(e,t,n,s){if(n===""){for(const i of s)if(e.has(i.key))return!0}for(const i of t)if(fI(i,n,s))return!0;return!1}function fI(e,t,n){for(const s of n)if(pI(e,t,s.key))return!0;return!1}function pI(e,t,n){const{indexName:s="",limit:i,prefix:o,startKey:a,startExclusive:c,startSecondaryKey:u}=e.options;if(t!==s)return!1;if(!s)return i!==void 0&&i<=0?!1:!o&&!a?!0:!(o&&(!n.startsWith(o)||cf(e,n))||a&&(c&&eh(n,a)||Zu(n,a)||cf(e,n)));if(!o&&!a&&!u)return!0;const[l,m]=Vu(n);return!(o&&!l.startsWith(o)||u&&(c&&eh(l,u)||Zu(l,u))||a&&(c&&eh(m,a)||Zu(m,a)))}function cf(e,t){const{inclusiveLimitKey:n}=e;return e.options.limit!==void 0&&n!==void 0&&Gl(t,n)}function*mI(e,t){for(const n of e)n.matches(t)&&(yield n)}function yI(e,t,n){if(t==="")return!0;const s=n?o=>Vu(o.key)[0]:o=>o.key,i=bw(e,t,s);return i<e.length&&s(e[i]).startsWith(t)}function bw(e,t,n){return Sy(e.length,s=>Pe(t,n(e[s])))}function kw(e){if(e===null)throw new TypeError("array cannot be null");for(let t=0;t<e.length;t++)e[t]=Math.floor(Math.random()*256);return e}var uh="";function wI(){if(uh===""){const e=new Uint8Array(4);kw(e),uh=Array.from(e,t=>t.toString(16)).join("")}return uh}var uf=new Map;function hf(e){const t=uf.get(e)??0;return uf.set(e,t+1),`${e}-${wI()}-${t}`}var vI="15.2.1",gI=8,SI=1e3,bI=1e3,kI=500,II=500,CI=100*2**20,DI=5*60*1e3,fc=()=>{},EI={type:"NewClientGroup"},ce,Vl,Qo,_,Iw,Ne,ui,bu,we,hi,Ve,jt,Jo,Wo,li,Ln,Xo,zt,L,Xe,ku,Yo,Zo,ea,Iu,ta,Cu,Cw,na,Yh,Dw,Ew,Zh,el,_w,xw,Oc,tl,Dr,Tc,nl,sl,Mw,Nw,il,vn,sa,Rw,Ow,Tw,Pc,Ep,_I=(Ep=class{constructor(e,t={}){h(this,_);v(this,"pullURL");v(this,"pushURL");v(this,"auth");v(this,"name");h(this,ce);h(this,Vl);v(this,"isClientGroupDisabled",!1);h(this,Qo);v(this,"lastMutationID",0);v(this,"schemaVersion");h(this,Ne,!1);h(this,ui,!0);h(this,bu,ud());h(this,we);h(this,hi);h(this,Ve);h(this,jt,{});v(this,"mutate");h(this,Jo,0);h(this,Wo,0);h(this,li);h(this,Ln);v(this,"pullInterval");v(this,"pushDelay");h(this,Xo);v(this,"puller");v(this,"pusher");v(this,"memdag");v(this,"perdag");h(this,zt);h(this,L);h(this,Xe,new AbortController);h(this,ku,new tc);h(this,Yo);h(this,Zo);h(this,ea);h(this,Iu,new rf(()=>this.persist(),SI,kI,r(this,Xe).signal));h(this,ta);h(this,Cu,new rf(()=>this.refresh(),bI,II,r(this,Xe).signal));v(this,"onSync",null);v(this,"onClientStateNotFound",df);v(this,"onUpdateNeeded",df);v(this,"getAuth",null);v(this,"onPushInvoked",()=>{});v(this,"onBeginPull",()=>{});v(this,"onRecoverMutations",e=>e);h(this,na,async()=>{var e;r(this,Ne)||((e=Dt("document"))==null?void 0:e.visibilityState)==="visible"&&await p(this,_,Yh).call(this)});v(this,"onOnlineChange",null);h(this,sa,async e=>{await r(this,we);const{clientID:t}=this;return pe(this.memdag,async n=>{try{const s=await D0(n,Se),i=new Fy(t,s,r(this,L));return await e(i)}catch(s){throw await p(this,_,Pc).call(this,s)}})});var Dd,Ed;xI(e);const{name:n,logLevel:s="info",logSinks:i=[cn],pullURL:o="",auth:a,pushDelay:c=10,pushURL:u="",schemaVersion:l="",pullInterval:m=6e4,mutators:y={},requestOptions:w={},puller:b,pusher:C,indexes:k={},clientMaxAgeMs:S=Fk}=e,{enableMutationRecovery:I=!0,enableScheduledPersist:D=!0,enableScheduledRefresh:N=!0,enablePullAndPushInOpen:x=!0,enableClientGroupForking:T=!0,onClientsDeleted:E=()=>{}}=t;this.auth=a??"",this.pullURL=o,this.pushURL=u,this.name=n,this.schemaVersion=l,this.pullInterval=m,this.pushDelay=c,this.puller=b??XS(this),this.pusher=C??K0(this),d(this,Yo,D),d(this,Zo,N),d(this,ea,x),d(this,L,Ym(s,i,{name:n})),(Ed=(Dd=r(this,L)).debug)==null||Ed.call(Dd,"Constructing Replicache",{name:n,"replicache version":vI}),d(this,ce,new lI(r(this,sa),r(this,L),r(this,Xe).signal));const O=Pw(r(this,L),e.kvStore);d(this,Qo,O);const H=O.create(this.idbName);d(this,zt,new ww(O.create)),this.perdag=new Km(H,ut,lr),this.memdag=new t0(this.perdag,CI,ut,lr);const P=A();d(this,we,P.promise);const{minDelayMs:xe=Vb,maxDelayMs:Ju=Gb}=w;d(this,Xo,{maxDelayMs:Ju,minDelayMs:xe});const Eg=sy(Dt("document"),0,r(this,Xe).signal);d(this,li,new Vd(r(this,L).withContext("PULL"),new Fb(this,()=>p(this,_,Dw).call(this)),Eg)),d(this,Ln,new Vd(r(this,L).withContext("PUSH"),new $b(this,()=>p(this,_,xw).call(this)))),this.mutate=p(this,_,Ow).call(this,y);const Id=A();d(this,hi,Id.promise);const Cd=A();d(this,Ve,Cd.promise),d(this,ta,Ck(this.name,r(this,Xe).signal,_g=>{p(this,_,Mw).call(this,_g)})),p(this,_,Cw).call(this,k,T,I,S,Id.resolve,Cd.resolve,P.resolve,E)}get idbName(){return NI(this.name,this.schemaVersion)}get requestOptions(){return r(this,Xo)}get profileID(){return r(this,hi)}get clientID(){return r(this,bu)}get clientGroupID(){return r(this,Ve)}get online(){return r(this,ui)}get closed(){return r(this,Ne)}async close(){var s;d(this,Ne,!0);const{promise:e,resolve:t}=A();hh.set(this.name,e),r(this,Xe).abort(),(s=Dt("document"))==null||s.removeEventListener("visibilitychange",r(this,na)),await r(this,we);const n=[this.memdag.close(),this.perdag.close(),r(this,zt).close()];r(this,li).close(),r(this,Ln).close(),r(this,ce).clear(),await Promise.all(n),hh.delete(this.name),t()}async maybeEndPull(e,t){for(;;){if(r(this,Ne))return;await r(this,we);const{clientID:n}=this,s=r(this,L).withContext("maybeEndPull").withContext("requestID",t),{replayMutations:i,diffs:o}=await ck(this.memdag,s,e,n,r(this,ce),Se);if(!i||i.length===0){await r(this,ce).fire(o),p(this,_,sl).call(this);return}for(const a of i){r(this,ce).hasPendingSubscriptionRuns&&await Promise.resolve();const{meta:c}=a;e=await uu(this.memdag,u=>B0(a,u,e,hu,r(this,jt),s,Fu(c)?c.clientID:n,Se))}}}push({now:e=!1}={}){return lf(r(this,Ln).send(e))}pull({now:e=!1}={}){return lf(r(this,li).send(e))}async poke(e,t){await r(this,we);const{clientID:n}=this,s=hf(n),i=r(this,L).withContext("handlePullResponse").withContext("requestID",s),{pullResponse:o}=e;if(xs(o)){p(this,_,Oc).call(this,o);return}if(_s(o)){await p(this,_,Tc).call(this);return}const a=await iw(i,this.memdag,e.baseCookie,o,n,Se);switch(a.type){case od:await t(this.memdag,a.syncHead,a.diffs),await this.maybeEndPull(a.syncHead,s);break;case nw:throw new Error("unexpected base cookie for poke: "+JSON.stringify(e))}}async beginPull(){await r(this,we);const e=await this.profileID,{clientID:t}=this,n=await r(this,Ve),{result:{beginPullResponse:s,requestID:i}}=await p(this,_,el).call(this,async(u,l)=>{const m=await ok(e,t,n,this.schemaVersion,this.puller,u,this.memdag,Se,l);return{result:{beginPullResponse:m,requestID:u},httpRequestInfo:m.httpRequestInfo}},"pull",r(this,L),()=>p(this,_,vn).call(this,0,-1),()=>p(this,_,vn).call(this,0,1)),{pullResponse:o}=s;xs(o)?p(this,_,Oc).call(this,o):_s(s.pullResponse)&&await p(this,_,Tc).call(this);const{syncHead:a,httpRequestInfo:c}=s;return{requestID:i,syncHead:a,ok:c.httpStatusCode===200}}persist(){return r(this,ku).withLock(async()=>{var n,s;const{clientID:e}=this;if(await r(this,we),r(this,Ne))return;try{await Zk(r(this,L),e,this.memdag,this.perdag,r(this,jt),()=>r(this,Ne),Se)}catch(i){if(i instanceof hn)p(this,_,Dr).call(this,e);else if(r(this,Ne))(s=(n=r(this,L)).debug)==null||s.call(n,"Exception persisting during close",i);else throw i}const t=await r(this,Ve);g(t),r(this,ta).call(this,{clientID:e,clientGroupID:t})})}async refresh(){var n,s;await r(this,we);const{clientID:e}=this;if(r(this,Ne))return;let t;try{t=await sI(r(this,L),this.memdag,this.perdag,e,r(this,jt),r(this,ce),()=>this.closed,Se)}catch(i){if(i instanceof hn)p(this,_,Dr).call(this,e);else if(r(this,Ne))(s=(n=r(this,L)).debug)==null||s.call(n,"Exception refreshing during close",i);else throw i}t!==void 0&&await r(this,ce).fire(t)}async disableClientGroup(){const e=await r(this,Ve);g(e),this.isClientGroupDisabled=!0,await Z(this.perdag,t=>nk(e,t))}subscribe(e,t){typeof t=="function"&&(t={onData:t});const{onData:n,onError:s,onDone:i,isEqual:o}=t;return r(this,ce).add(new uI(e,n,s,i,o))}experimentalWatch(e,t){return r(this,ce).add(new hI(e,t))}query(e){return r(this,sa).call(this,e)}get cookie(){return r(this,we).then(()=>pe(this.memdag,async e=>{const t=await e.getHead(fe);if(!t)throw new Error("Internal no main head found");const i=(await xt(t,e)).meta.cookieJSON;return Mm(i),i}))}recoverMutations(){}experimentalPendingMutations(){return pe(this.memdag,Dk)}},ce=new WeakMap,Vl=new WeakMap,Qo=new WeakMap,_=new WeakSet,Iw=function(){return{name:this.idbName,replicacheName:this.name,replicacheFormatVersion:Se,schemaVersion:this.schemaVersion}},Ne=new WeakMap,ui=new WeakMap,bu=new WeakMap,we=new WeakMap,hi=new WeakMap,Ve=new WeakMap,jt=new WeakMap,Jo=new WeakMap,Wo=new WeakMap,li=new WeakMap,Ln=new WeakMap,Xo=new WeakMap,zt=new WeakMap,L=new WeakMap,Xe=new WeakMap,ku=new WeakMap,Yo=new WeakMap,Zo=new WeakMap,ea=new WeakMap,Iu=new WeakMap,ta=new WeakMap,Cu=new WeakMap,Cw=async function(e,t,n,s,i,o,a,c){var b;const{clientID:u}=this;await hh.get(this.name),await r(this,zt).getProfileID().then(i),await r(this,zt).putDatabase(r(this,_,Iw));const[l,m,,y]=await Tk(u,r(this,L),this.perdag,Object.keys(r(this,jt)),e,Se,t);o(l.clientGroupID),await Z(this.memdag,C=>C.setHead(fe,m)),a(),r(this,ea)&&(this.pull().catch(fc),this.push().catch(fc));const{signal:w}=r(this,Xe);Bk(u,this.perdag,()=>{p(this,_,Dr).call(this,u)},yw,r(this,L),w),$k(u,this.perdag,s,mw,c,r(this,L),w),HI(r(this,zt),r(this,Qo).drop,TI,PI,2*s,n,c,r(this,L),w),jk(this.perdag,n,c,r(this,L),w),bk(this.name,this.idbName,w,l.clientGroupID,y,()=>{p(this,_,nl).call(this,EI)},this.perdag),oI(()=>this.recoverMutations(),DI,w),this.recoverMutations(),(b=Dt("document"))==null||b.addEventListener("visibilitychange",r(this,na))},na=new WeakMap,Yh=async function(){const{clientID:e}=this,t=await pe(this.perdag,n=>hw(e,n));return t||p(this,_,Dr).call(this,e),!t},Dw=function(){return p(this,_,Ew).call(this)?Promise.resolve(!0):p(this,_,Zh).call(this,async()=>{try{p(this,_,vn).call(this,0,1);const{syncHead:e,requestID:t,ok:n}=await this.beginPull();if(!n)return!1;e!==Ee&&await this.maybeEndPull(e,t)}catch(e){throw await p(this,_,Pc).call(this,e)}finally{p(this,_,vn).call(this,0,-1)}return!0},"Pull")},Ew=function(){return this.isClientGroupDisabled||this.pullURL===""&&YS(this.puller)},Zh=async function(e,t){var s,i,o,a,c,u,l;let n=!0;try{return await e()}catch(m){return m instanceof rw||m instanceof sw?(n=!1,(i=(s=r(this,L)).debug)==null||i.call(s,`${t} threw:
`,m,`
with cause:
`,m.causedBy)):m instanceof ld?(a=(o=r(this,L)).error)==null||a.call(o,m):(u=(c=r(this,L)).info)==null||u.call(c,`${t} threw:
`,m),!1}finally{r(this,ui)!==n&&(d(this,ui,n),(l=this.onOnlineChange)==null||l.call(this,n),n&&this.recoverMutations())}},el=async function(e,t,n,s=fc,i=fc){var u,l;const{clientID:o}=this;let a=0,c;n=n.withContext(t);do{const m=hf(o),y=n.withContext("requestID",m),{httpRequestInfo:w,result:b}=await e(m,y);if(c=b,!w)return{result:b,authFailure:!1};const{errorMessage:C,httpStatusCode:k}=w;if((C||k!==200)&&((u=y.error)==null||u.call(y,`Got a non 200 response doing ${t}: ${k}`+(C?`: ${C}`:""))),k!==MI)return{result:b,authFailure:!1};if(!this.getAuth)return{result:b,authFailure:!0};let S;try{await s(),S=await this.getAuth()}finally{await i()}if(S==null)return{result:b,authFailure:!0};this.auth=S,a++}while(a<gI);return(l=n.info)==null||l.call(n,"Tried to reauthenticate too many times"),{result:c,authFailure:!0}},_w=function(){return this.isClientGroupDisabled||this.pushURL===""&&U0(this.pusher)},xw=async function(){if(p(this,_,_w).call(this))return!0;await r(this,we);const e=await r(this,hi),{clientID:t}=this,n=await r(this,Ve);return p(this,_,Zh).call(this,async()=>{const{result:s}=await p(this,_,el).call(this,async(a,c)=>{try{p(this,_,vn).call(this,1,0);const u=await mk(a,this.memdag,c,e,n,t,this.pusher,this.schemaVersion,Kh);return{result:u,httpRequestInfo:u==null?void 0:u.httpRequestInfo}}finally{p(this,_,vn).call(this,-1,0)}},"push",r(this,L));if(s===void 0)return!0;const{response:i,httpRequestInfo:o}=s;return xs(i)?p(this,_,Oc).call(this,i):_s(i)&&await p(this,_,Tc).call(this),o.httpStatusCode===200},"Push")},Oc=function(e){const t={type:e.error};e.versionType&&(t.versionType=e.versionType),p(this,_,nl).call(this,t)},tl=function(){var e;(e=this.onClientStateNotFound)==null||e.call(this)},Dr=function(e){var t,n;(n=(t=r(this,L)).error)==null||n.call(t,`Client state not found on client, clientID: ${e}`),p(this,_,tl).call(this)},Tc=async function(){var t,n;const e=await r(this,Ve);(n=(t=r(this,L)).error)==null||n.call(t,`Client state not found on server, clientGroupID: ${e}`),await this.disableClientGroup(),p(this,_,tl).call(this)},nl=function(e){var t,n,s;(n=(t=r(this,L)).debug)==null||n.call(t,`Update needed, reason: ${e}`),(s=this.onUpdateNeeded)==null||s.call(this,e)},sl=async function(){r(this,Yo)&&await p(this,_,il).call(this,"persist",r(this,Iu))},Mw=async function(e){var n,s;(s=(n=r(this,L)).debug)==null||s.call(n,"Handling persist",e);const t=await r(this,Ve);e.clientGroupID===t&&p(this,_,Nw).call(this)},Nw=async function(){r(this,Zo)&&await p(this,_,il).call(this,"refresh from storage",r(this,Cu))},il=async function(e,t){var n,s,i,o;try{await t.schedule()}catch(a){a instanceof hr?(s=(n=r(this,L)).debug)==null||s.call(n,`Scheduled ${e} did not complete before close.`):(o=(i=r(this,L)).error)==null||o.call(i,`Error during ${e}`,a)}},vn=function(e,t){d(this,Jo,r(this,Jo)+e),d(this,Wo,r(this,Wo)+t);const n=e+t,s=r(this,Jo)+r(this,Wo);if(n===1&&s===1||s===0){const i=s>0;Promise.resolve().then(()=>{var o;return(o=this.onSync)==null?void 0:o.call(this,i)})}},sa=new WeakMap,Rw=function(e,t){return r(this,jt)[e]=t,n=>p(this,_,Tw).call(this,e,t,n,performance.now())},Ow=function(e){const t=Object.create(null);for(const n in e)t[n]=p(this,_,Rw).call(this,n,e[n]);return t},Tw=async function(e,t,n,s){const i=n??null;r(this,ce).hasPendingSubscriptionRuns&&await Promise.resolve(),await r(this,we);const{clientID:o}=this;return uu(this.memdag,async a=>{try{const c=await Wl(fe,a),l=await Ky(c,e,i,null,a,s,o,Se),m=new Vy(o,await l.getMutationID(),"initial",l,r(this,L)),y=await t(m,n);zr(l);const w=await l.getMutationID(),b=await l.commitWithDiffs(fe,r(this,ce));return this.lastMutationID=w,r(this,Ln).send(!1).catch(()=>{}),await r(this,ce).fire(b),p(this,_,sl).call(this),y}catch(c){throw await p(this,_,Pc).call(this,c)}})},Pc=async function(e){return e instanceof zm&&await p(this,_,Yh).call(this)?new hn(this.clientID):e},Ep),hh=new Map;async function lf(e){const t=await e;if(t)throw t.error}function df(){typeof location<"u"&&location.reload()}function xI(e){const{name:t,clientMaxAgeMs:n}=e;if(typeof t!="string"||!t)throw new TypeError("name is required and must be non-empty");if(n!==void 0){const s=Math.max(mw,yw);if(typeof n!="number"||n<=s)throw new TypeError(`clientAgeMaxMs must be a number larger than ${s}ms`)}}var MI=401;function NI(e,t){return RI(e,t,Se)}function RI(e,t,n){const s=`rep:${e}:${n}`;return t?`${s}:${t}`:s}var ld=class extends Error{};function OI(e){return new ty(e)}function Pw(e,t){switch(t){case"idb":case void 0:return{create:n=>Ob(e,n),drop:Tb};case"mem":return{create:OI,drop:n=>ey(n)};default:return t}}var TI=12*60*60*1e3,PI=5*60*1e3;function HI(e,t,n,s,i,o,a,c,u){let l=!0;Hu("CollectIDBDatabases",async()=>{await LI(e,Date.now(),i,t,o,a)},()=>l?(l=!1,s):n,c,u)}async function LI(e,t,n,s,i,o,a=FI){const c=await e.getDatabases(),u=Object.values(c),l=await Promise.all(u.map(async k=>[k.name,await $I(k,t,n,i,a)])),m=[],y=[],w=[],b=[];for(const[k,[S,I,D]]of l)S?(m.push(k),w.push(...I),b.push(...D)):y.push(k);const{errors:C}=await AI(e,m,s);if(C.length)throw C[0];if(w.length||b.length){const k=w,S=b;for(const I of y)await Z(a(I),async D=>{const{clientIDs:N,clientGroupIDs:x}=await Xm(D,w,b);k.push(...N),S.push(...x)});o(tu(k),tu(S))}}async function Hw(e,t,n){await n(e),await t.deleteDatabases([e])}async function AI(e,t,n){const s=await Promise.allSettled(t.map(async a=>(await Hw(a,e,n),a))),i=[],o=[];for(const a of s)a.status==="fulfilled"?i.push(a.value):o.push(a.reason);return{dropped:i,errors:o}}function FI(e){const t=new Zc(e);return new Km(t,ut,lr)}function $I(e,t,n,s,i){return e.replicacheFormatVersion>Se?[!1]:(g(e.lastOpenedTimestampMS!==void 0),t-e.lastOpenedTimestampMS<n?[!1]:(g(e.replicacheFormatVersion===nu||e.replicacheFormatVersion===Mb||e.replicacheFormatVersion===jr),GI(s,i(e.name))))}async function VI(e,t){const n=Ym(t==null?void 0:t.logLevel,t==null?void 0:t.logSinks,{dropDatabase:void 0}),s=Pw(n,t==null?void 0:t.kvStore);await Hw(e,new ww(s.create),s.drop)}function GI(e,t){return pe(t,async n=>{if(e){const u=await yr(n);for(const l of u.values())if(tw(l))return[!1]}const s=await ys(n),{clientIDs:i,clientGroupIDs:o}=await Gr(n),a=[...i],c=[...o];for(const[u,l]of s)a.push(u),c.push(l.clientGroupID);return[!0,a,c]})}function rc(e,t){const n=t({many:jI,one:zI});return{name:e.schema.name,relationships:n}}function jI(...e){return e.map(t=>({sourceField:t.sourceField,destField:t.destField,destSchema:t.destSchema.schema.name,cardinality:"many"}))}function zI(...e){return e.map(t=>({sourceField:t.sourceField,destField:t.destField,destSchema:t.destSchema.schema.name,cardinality:"one"}))}function oc(e){return new KI({name:e,columns:{},primaryKey:[]})}function re(){return new zu({type:"string",optional:!1,customType:null})}function lu(){return new zu({type:"number",optional:!1,customType:null})}function rl(){return new zu({type:"boolean",optional:!1,customType:null})}function BI(){return new zu({type:"string",optional:!1,customType:null})}var di,fi,KI=(fi=class{constructor(t){h(this,di);d(this,di,t)}from(t){return new fi({...r(this,di),serverName:t})}columns(t){const n=Object.fromEntries(Object.entries(t).map(([s,i])=>[s,i.schema]));return new UI({...r(this,di),columns:n})}},di=new WeakMap,fi),Ge,pi,UI=(pi=class{constructor(t){h(this,Ge);d(this,Ge,t)}primaryKey(...t){return new pi({...r(this,Ge),primaryKey:t})}get schema(){return r(this,Ge)}build(){if(r(this,Ge).primaryKey.length===0)throw new Error(`Table "${r(this,Ge).name}" is missing a primary key`);const t=new Set;for(const[n,{serverName:s}]of Object.entries(r(this,Ge).columns)){const i=s??n;if(t.has(i))throw new Error(`Table "${r(this,Ge).name}" has multiple columns referencing "${i}"`);t.add(i)}return r(this,Ge)}},Ge=new WeakMap,pi),An,hs,zu=(hs=class{constructor(t){h(this,An);d(this,An,t)}from(t){return new hs({...r(this,An),serverName:t})}optional(){return new hs({...r(this,An),optional:!0})}get schema(){return r(this,An)}},An=new WeakMap,hs);function qI(e,t){var o;const n={},s={},i=new Set;return t.tables.forEach(a=>{const{serverName:c=a.schema.name}=a.schema;if(i.has(c))throw new Error(`Multiple tables reference the name "${c}"`);if(i.add(c),n[a.schema.name])throw new Error(`Table "${a.schema.name}" is defined more than once in the schema`);n[a.schema.name]=a.build()}),(o=t.relationships)==null||o.forEach(a=>{if(s[a.name])throw new Error(`Relationships for table "${a.name}" are defined more than once in the schema`);s[a.name]=a.relationships,QI(a.relationships,a.name,n)}),{version:e,tables:n,relationships:s}}function QI(e,t,n){Object.entries(e).forEach(([s,i])=>{let o=n[t];i.forEach(a=>{if(!n[a.destSchema])throw new Error(`For relationship "${t}"."${s}", destination table "${a.destSchema}" is missing in the schema`);if(!o.columns[a.sourceField[0]])throw new Error(`For relationship "${t}"."${s}", the source field "${a.sourceField[0]}" is missing in the table schema "${o.name}"`);o=n[a.destSchema]})})}function JI(e){let t=e.findIndex(s=>s===void 0);if(t<0)return e;const n=e.slice(0,t);for(t++;t<e.length;t++){const s=e[t];s!==void 0&&n.push(s)}return n}function WI(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}var XI=f.union(ad,f.undefined()),ac=sc(XI),YI=f.string(),ln=Symbol(),ZI=f.tuple([YI,f.union(f.literal("asc"),f.literal("desc"))]),eC=_e(ZI);f.union(f.string(),f.number(),f.boolean(),f.null());var tC=f.union(f.literal("="),f.literal("!="),f.literal("IS"),f.literal("IS NOT")),nC=f.union(f.literal("<"),f.literal(">"),f.literal("<="),f.literal(">=")),sC=f.union(f.literal("LIKE"),f.literal("NOT LIKE"),f.literal("ILIKE"),f.literal("NOT ILIKE")),iC=f.union(f.literal("IN"),f.literal("NOT IN")),rC=f.union(tC,nC,sC,iC),Lw=W({type:f.literal("literal"),value:f.union(f.string(),f.number(),f.boolean(),f.null(),_e(f.union(f.string(),f.number(),f.boolean())))}),oC=W({type:f.literal("column"),name:f.string()}),Aw=W({type:f.literal("static"),anchor:f.union(f.literal("authData"),f.literal("preMutationRow")),field:f.union(f.string(),f.array(f.string()))}),aC=f.union(Lw,oC,Aw),cC=W({type:f.literal("simple"),op:rC,left:aC,right:f.union(Aw,Lw)}),uC=f.union(f.literal("EXISTS"),f.literal("NOT EXISTS")),hC=W({type:f.literal("correlatedSubquery"),related:f.lazy(()=>$w),op:uC}),dd=f.union(cC,f.lazy(()=>lC),f.lazy(()=>dC),hC),lC=W({type:f.literal("and"),conditions:_e(dd)}),dC=W({type:f.literal("or"),conditions:_e(dd)});function Fw(e){return g(Array.isArray(e)&&e.length>=1),e}var ff=f.tuple([f.string()]).concat(f.array(f.string())),fC=W({parentField:ff,childField:ff}),pC=W({correlation:fC,hidden:f.boolean().optional(),system:f.union(f.literal("permissions"),f.literal("client")).optional()}),$w=pC.extend({subquery:f.lazy(()=>Vw)}),Vw=W({schema:f.string().optional(),table:f.string(),alias:f.string().optional(),where:dd.optional(),related:_e($w).optional(),limit:f.number().optional(),orderBy:eC.optional(),start:f.object({row:ac,exclusive:f.boolean()}).optional()});function Bu(e,t){var u;const{tableName:n,columnName:s}=t,i=l=>s(e.table,l),o=(l,m)=>{const y=m.map(w=>s(l,w));return Fw(y)},a=e.where?t.where(e.where):void 0;return{schema:e.schema,table:n(e.table),alias:e.alias,where:a?fd(a,e.table,t):void 0,related:e.related?t.related(e.related.map(l=>({correlation:{parentField:o(e.table,l.correlation.parentField),childField:o(l.subquery.table,l.correlation.childField)},hidden:l.hidden,subquery:Bu(l.subquery,t),system:l.system}))):void 0,start:e.start?{...e.start,row:Object.fromEntries(Object.entries(e.start.row).map(([l,m])=>[i(l),m]))}:void 0,limit:e.limit,orderBy:(u=e.orderBy)==null?void 0:u.map(([l,m])=>[i(l),m])}}function fd(e,t,n){const{columnName:s}=n,i=a=>a.type!=="column"?a:{...a,name:s(t,a.name)},o=(a,c)=>{const u=c.map(l=>s(a,l));return Fw(u)};if(e.type==="simple")return{...e,left:i(e.left)};if(e.type==="correlatedSubquery"){const{correlation:a,subquery:c}=e.related;return{...e,related:{...e.related,correlation:{parentField:o(t,a.parentField),childField:o(c.table,a.childField)},subquery:Bu(c,n)}}}return{type:e.type,conditions:n.conditions(e.conditions.map(a=>fd(a,t,n)))}}var pf=new WeakMap,mC={tableName:e=>e,columnName:(e,t)=>t,related:wC,where:ol,conditions:e=>e.sort(zw)};function Gw(e){let t=pf.get(e);return t||(t=Bu(e,mC),pf.set(e,t)),t}function jw(e,t){return Bu(e,{tableName:n=>t.tableName(n),columnName:(n,s)=>t.columnName(n,s),related:n=>n,where:n=>n,conditions:n=>n})}function yC(e,t,n){return fd(e,t,{tableName:s=>n.tableName(s),columnName:(s,i)=>n.columnName(s,i),related:s=>s,where:s=>s,conditions:s=>s})}function wC(e){return e.sort(Bw)}function zw(e,t){if(e.type==="simple")return t.type!=="simple"?-1:mf(e.left,t.left)||lh(e.op,t.op)||mf(e.right,t.right);if(t.type==="simple")return 1;if(e.type==="correlatedSubquery")return t.type!=="correlatedSubquery"?-1:Bw(e.related,t.related)||lh(e.op,t.op);if(t.type==="correlatedSubquery")return-1;const n=lh(e.type,t.type);if(n!==0)return n;for(let s=0,i=0;s<e.conditions.length&&i<t.conditions.length;s++,i++){const o=zw(e.conditions[s],t.conditions[i]);if(o!==0)return o}return e.conditions.length-t.conditions.length}function mf(e,t){if(e.type!==t.type)return Pe(e.type,t.type);switch(e.type){case"literal":return g(t.type==="literal"),Pe(String(e.value),String(t.value));case"column":return g(t.type==="column"),Pe(e.name,t.name);case"static":throw new Error("Static parameters should be resolved before normalization")}}function Bw(e,t){return Pe($(e.subquery.alias),$(t.subquery.alias))}function ol(e){if(e.type==="simple"||e.type==="correlatedSubquery")return e;const t=JI(e.conditions.flatMap(n=>n.type===e.type?n.conditions.map(s=>ol(s)):ol(n)));switch(t.length){case 0:return;case 1:return t[0];default:return{type:e.type,conditions:t}}}function lh(e,t){return e!==null&&t!==null?Pe(e,t):t!==null?-1:e!==null?1:0}var vC=e=>Kw(e,2),gC=e=>Kw(e,4);function Kw(e,t){let n=0n;for(let s=0;s<t;s++)n=(n<<32n)+BigInt(BS(e,s));return n}var yf=new WeakMap;function Uw(e){const t=Gw(e),n=yf.get(t);if(n)return n;const s=vC(JSON.stringify(t)).toString(36);return yf.set(t,s),s}function wf(e){return e.length===1}function vf(e){return e.length===2}var wr={push(e){throw new Error("Output not set")}};function*Hc(e,t){if(t<1)return;let n=0;for(const s of e)if(yield s,++n===t)break}function Er(e){var s;const t=e[Symbol.iterator](),{value:n}=t.next();return(s=t.return)==null||s.call(t),n}var Re,mi,je,Fn,yi,Bt,wt,R,Lc,bs,_r,xr,Ac,qw,al,Qw,Fc,$c,Vc,Gc,_p,SC=(_p=class{constructor(e,t,n,s,i){h(this,R);h(this,Re);h(this,mi);h(this,je);h(this,Fn);h(this,yi);h(this,Bt);h(this,wt,wr);d(this,Re,e),d(this,mi,n),r(this,Re).setOutput(this),d(this,je,t),g(r(this,Re).getSchema().relationships[n]),d(this,Fn,i==="NOT EXISTS"),d(this,yi,s),d(this,Bt,WI(s,r(this,Re).getSchema().primaryKey))}setOutput(e){d(this,wt,e)}destroy(){r(this,Re).destroy()}getSchema(){return r(this,Re).getSchema()}*fetch(e){for(const t of r(this,Re).fetch(e))p(this,R,Lc).call(this,t)&&(yield t)}*cleanup(e){for(const t of r(this,Re).cleanup(e))p(this,R,Lc).call(this,t)?yield t:Ru(t),p(this,R,al).call(this,t)}push(e){switch(e.type){case"add":case"edit":{p(this,R,bs).call(this,e);return}case"remove":{const t=p(this,R,_r).call(this,e.node);if(t===void 0)return;p(this,R,bs).call(this,e,t),p(this,R,al).call(this,e.node);return}case"child":if(e.child.relationshipName!==r(this,mi)||e.child.change.type==="edit"||e.child.change.type==="child"){p(this,R,bs).call(this,e);return}switch(e.child.change.type){case"add":{let t=p(this,R,_r).call(this,e.node);if(t!==void 0?(t++,p(this,R,Ac).call(this,e.node,t),p(this,R,xr).call(this,e.node,t)):t=p(this,R,Fc).call(this,e.node),t===1){const n=r(this,Fn)?"remove":"add";n==="remove"&&r(this,wt).push(e),r(this,wt).push({type:n,node:e.node})}else p(this,R,bs).call(this,e,t);return}case"remove":{let t=p(this,R,_r).call(this,e.node);if(t!==void 0){if(t===0)return;t--,p(this,R,Ac).call(this,e.node,t),p(this,R,xr).call(this,e.node,t)}else t=p(this,R,Fc).call(this,e.node);if(t===0){const n=r(this,Fn)?"add":"remove";n==="remove"&&r(this,wt).push(e),r(this,wt).push({type:n,node:e.node})}else p(this,R,bs).call(this,e,t);return}}return;default:me()}}},Re=new WeakMap,mi=new WeakMap,je=new WeakMap,Fn=new WeakMap,yi=new WeakMap,Bt=new WeakMap,wt=new WeakMap,R=new WeakSet,Lc=function(e,t){const n=(t??p(this,R,Qw).call(this,e))>0;return r(this,Fn)?!n:n},bs=function(e,t){p(this,R,Lc).call(this,e.node,t)&&r(this,wt).push(e)},_r=function(e){return r(this,je).get(p(this,R,Vc).call(this,e))},xr=function(e,t){r(this,je).set(p(this,R,Vc).call(this,e),t)},Ac=function(e,t){r(this,Bt)||r(this,je).set(p(this,R,$c).call(this,e),t)},qw=function(e){if(!r(this,Bt))return r(this,je).get(p(this,R,$c).call(this,e))},al=function(e){if(r(this,je).del(p(this,R,Vc).call(this,e)),!r(this,Bt)){const t=p(this,R,$c).call(this,e);Er(r(this,je).scan({prefix:`${t}/`}))===void 0&&r(this,je).del(t)}},Qw=function(e){const t=p(this,R,_r).call(this,e);return t!==void 0?t:p(this,R,Fc).call(this,e)},Fc=function(e){const t=p(this,R,qw).call(this,e);if(t!==void 0)return p(this,R,xr).call(this,e,t),t;const n=e.relationships[r(this,mi)];g(n);let s=0;for(const i of n())s++;return p(this,R,Ac).call(this,e,s),p(this,R,xr).call(this,e,s),s},$c=function(e){return`row/${JSON.stringify(p(this,R,Gc).call(this,e,r(this,yi)))}`},Vc=function(e){return`row/${r(this,Bt)?"":JSON.stringify(p(this,R,Gc).call(this,e,r(this,yi)))}/${JSON.stringify(p(this,R,Gc).call(this,e,r(this,Re).getSchema().primaryKey))}`},Gc=function(e,t){const n=[];for(const s of t)n.push(vh(e.row[s]));return n},_p),wi,ia,$n,ra,oa,cl,xp,bC=(xp=class{constructor(e,t){h(this,oa);h(this,wi);h(this,ia);h(this,$n);h(this,ra,wr);d(this,wi,t),d(this,$n,e.getSchema()),d(this,ia,e);for(const n of t)n.setOutput(this),g(r(this,$n)===n.getSchema(),"Schema mismatch in fan-in")}setOutput(e){d(this,ra,e)}destroy(){for(const e of r(this,wi))e.destroy()}getSchema(){return r(this,$n)}fetch(e){return p(this,oa,cl).call(this,t=>t.fetch(e))}cleanup(e){return p(this,oa,cl).call(this,t=>t.cleanup(e))}push(e){r(this,ia).onFanInReceivedPush(),r(this,ra).push(e)}},wi=new WeakMap,ia=new WeakMap,$n=new WeakMap,ra=new WeakMap,oa=new WeakSet,cl=function*(e){const t=r(this,wi).map(n=>e(n));yield*Wb(t,(n,s)=>$(r(this,$n)).compareRows(n.row,s.row),!0)},xp),Kt,vi,gi,Si,Mp,kC=(Mp=class{constructor(e){h(this,Kt);h(this,vi,[]);h(this,gi,!1);h(this,Si,0);d(this,Kt,e),e.setOutput(this)}setOutput(e){r(this,vi).push(e)}destroy(){if(r(this,Si)<r(this,vi).length)r(this,Si)===0&&r(this,Kt).destroy(),++yn(this,Si)._;else throw new Error("FanOut already destroyed once for each output")}getSchema(){return r(this,Kt).getSchema()}fetch(e){return r(this,Kt).fetch(e)}cleanup(e){return r(this,Kt).cleanup(e)}onFanInReceivedPush(){d(this,gi,!0)}push(e){d(this,gi,!1);for(const t of r(this,vi))if(t.push(e),r(this,gi))return}},Kt=new WeakMap,vi=new WeakMap,gi=new WeakMap,Si=new WeakMap,Mp);function Jw(e,t,n){const s=t(e.oldNode.row),i=t(e.node.row);s&&i?n.push(e):s&&!i?n.push({type:"remove",node:e.oldNode}):!s&&i&&n.push({type:"add",node:e.node})}function Ww(e,t,n){if(!n){t.push(e);return}switch(e.type){case"add":case"remove":n(e.node.row)&&t.push(e);break;case"child":n(e.node.row)&&t.push(e);break;case"edit":Jw(e,n,t);break;default:me()}}var Ut,Vn,aa,Np,ul=(Np=class{constructor(e,t){h(this,Ut);h(this,Vn);h(this,aa,wr);d(this,Ut,e),d(this,Vn,t),e.setOutput(this)}setOutput(e){d(this,aa,e)}destroy(){r(this,Ut).destroy()}getSchema(){return r(this,Ut).getSchema()}*fetch(e){for(const t of r(this,Ut).fetch(e))r(this,Vn).call(this,t.row)&&(yield t)}*cleanup(e){for(const t of r(this,Ut).cleanup(e))r(this,Vn).call(this,t.row)?yield t:Ru(t)}push(e){Ww(e,r(this,aa),r(this,Vn))}},Ut=new WeakMap,Vn=new WeakMap,aa=new WeakMap,Np),Ye,bi,Gn,Ze,jn,ki,ca,vt,Y,jc,Xw,dt,Rp,IC=(Rp=class{constructor({parent:e,child:t,storage:n,parentKey:s,childKey:i,relationshipName:o,hidden:a,system:c}){h(this,Y);h(this,Ye);h(this,bi);h(this,Gn);h(this,Ze);h(this,jn);h(this,ki);h(this,ca);h(this,vt,wr);g(e!==t,"Parent and child must be different operators"),g(s.length===i.length,"The parentKey and childKey keys must have same length"),d(this,Ye,e),d(this,bi,t),d(this,Gn,n),d(this,Ze,s),d(this,jn,i),d(this,ki,o);const u=e.getSchema(),l=t.getSchema();d(this,ca,{...u,relationships:{...u.relationships,[o]:{...l,isHidden:a,system:c}}}),e.setOutput({push:m=>p(this,Y,jc).call(this,m)}),t.setOutput({push:m=>p(this,Y,Xw).call(this,m)})}destroy(){r(this,Ye).destroy(),r(this,bi).destroy()}setOutput(e){d(this,vt,e)}getSchema(){return r(this,ca)}*fetch(e){for(const t of r(this,Ye).fetch(e))yield p(this,Y,dt).call(this,t.row,t.relationships,"fetch")}*cleanup(e){for(const t of r(this,Ye).cleanup(e))yield p(this,Y,dt).call(this,t.row,t.relationships,"cleanup")}},Ye=new WeakMap,bi=new WeakMap,Gn=new WeakMap,Ze=new WeakMap,jn=new WeakMap,ki=new WeakMap,ca=new WeakMap,vt=new WeakMap,Y=new WeakSet,jc=function(e){switch(e.type){case"add":r(this,vt).push({type:"add",node:p(this,Y,dt).call(this,e.node.row,e.node.relationships,"fetch")});break;case"remove":r(this,vt).push({type:"remove",node:p(this,Y,dt).call(this,e.node.row,e.node.relationships,"cleanup")});break;case"child":r(this,vt).push({type:"child",node:p(this,Y,dt).call(this,e.node.row,e.node.relationships,"fetch"),child:e.child});break;case"edit":{Sf(e.oldNode.row,e.node.row,r(this,Ze))?r(this,vt).push({type:"edit",oldNode:p(this,Y,dt).call(this,e.oldNode.row,e.oldNode.relationships,"cleanup"),node:p(this,Y,dt).call(this,e.node.row,e.node.relationships,"fetch")}):(p(this,Y,jc).call(this,{type:"remove",node:e.oldNode}),p(this,Y,jc).call(this,{type:"add",node:e.node}));break}default:me()}},Xw=function(e){const t=(n,s)=>{const i=r(this,Ye).fetch({constraint:Object.fromEntries(r(this,Ze).map((o,a)=>[o,n[r(this,jn)[a]]]))});for(const o of i){const a={type:"child",node:p(this,Y,dt).call(this,o.row,o.relationships,"fetch"),child:{relationshipName:r(this,ki),change:s}};r(this,vt).push(a)}};switch(e.type){case"add":case"remove":t(e.node.row,e);break;case"child":t(e.node.row,e);break;case"edit":{const n=e.node.row,s=e.oldNode.row;Sf(s,n,r(this,jn))?t(n,e):(t(s,{type:"remove",node:e.oldNode}),t(n,{type:"add",node:e.node}));break}default:me()}},dt=function(e,t,n){let s=n,i=!1;const o=()=>(i||(n==="cleanup"&&(r(this,Gn).del(gf(r(this,Ze),r(this,Ye).getSchema().primaryKey,e)),s=[...Hc(r(this,Gn).scan({prefix:CC(e,r(this,Ze))}),1)].length===0?"cleanup":"fetch"),i=!0,n==="fetch"&&r(this,Gn).set(gf(r(this,Ze),r(this,Ye).getSchema().primaryKey,e),!0)),r(this,bi)[s]({constraint:Object.fromEntries(r(this,jn).map((a,c)=>[a,e[r(this,Ze)[c]]]))}));return{row:e,relationships:{...t,[r(this,ki)]:o}}},Rp);function Yw(e){const t=JSON.stringify(["pKeySet",...e]);return t.substring(1,t.length-1)+","}function CC(e,t){return Yw(t.map(n=>e[n]))}function gf(e,t,n){const s=e.map(i=>n[i]);for(const i of t)s.push(n[i]);return Yw(s)}function Sf(e,t,n){for(let s=0;s<n.length;s++)if(!um(e[n[s]],t[n[s]]))return!1;return!0}var zn,Oe,Ii,Ci,ht,hl,ll,Zw,Op,DC=(Op=class{constructor(e,t){h(this,ht);h(this,zn);h(this,Oe);h(this,Ii);h(this,Ci,wr);d(this,zn,e),d(this,Oe,t),d(this,Ii,e.getSchema().compareRows),e.setOutput(this)}getSchema(){return r(this,zn).getSchema()}fetch(e){return p(this,ht,hl).call(this,"fetch",e)}cleanup(e){return p(this,ht,hl).call(this,"fetch",e)}setOutput(e){d(this,Ci,e)}destroy(){r(this,zn).destroy()}push(e){const t=n=>p(this,ht,ll).call(this,n);if(e.type==="edit"){Jw(e,t,r(this,Ci));return}t(e.node.row)&&r(this,Ci).push(e)}},zn=new WeakMap,Oe=new WeakMap,Ii=new WeakMap,Ci=new WeakMap,ht=new WeakSet,hl=function*(e,t){const n=p(this,ht,Zw).call(this,t);if(n==="empty")return;const s=r(this,zn)[e]({...t,start:n});if(!t.reverse){yield*s;return}for(const i of s){if(!p(this,ht,ll).call(this,i.row))return;yield i}},ll=function(e){const t=r(this,Ii).call(this,r(this,Oe).row,e);return t<0||t===0&&!r(this,Oe).exclusive},Zw=function(e){const t={row:r(this,Oe).row,basis:r(this,Oe).exclusive?"after":"at"};if(!e.start)return e.reverse?void 0:t;const n=r(this,Ii).call(this,r(this,Oe).row,e.start.row);return e.reverse?(e.reverse,n>0?"empty":n===0?!r(this,Oe).exclusive&&e.start.basis==="at"?t:"empty":e.start):n>0?t:n===0?r(this,Oe).exclusive||e.start.basis==="after"?{row:r(this,Oe).row,basis:"after"}:t:e.start},Op),pc="maxBound",Q,ve,et,ue,Di,z,q,ev,dl,tv,Le,Tp,EC=(Tp=class{constructor(e,t,n,s){h(this,q);h(this,Q);h(this,ve);h(this,et);h(this,ue);h(this,Di);h(this,z,wr);g(n>=0),fl(e.getSchema().sort,e.getSchema().primaryKey),e.setOutput(this),d(this,Q,e),d(this,ve,t),d(this,et,n),d(this,ue,s),d(this,Di,s&&_C(s))}setOutput(e){d(this,z,e)}getSchema(){return r(this,Q).getSchema()}*fetch(e){if(!r(this,ue)||e.constraint&&dh(e.constraint,r(this,ue))){const n=Sr(r(this,ue),e.constraint),s=r(this,ve).get(n);if(!s){yield*p(this,q,ev).call(this,e);return}if(s.bound===void 0)return;for(const i of r(this,Q).fetch(e)){if(this.getSchema().compareRows(s.bound,i.row)<0)return;yield i}return}const t=r(this,ve).get(pc);if(t!==void 0)for(const n of r(this,Q).fetch(e)){if(this.getSchema().compareRows(n.row,t)>0)return;const s=Sr(r(this,ue),n.row),i=r(this,ve).get(s);(i==null?void 0:i.bound)!==void 0&&this.getSchema().compareRows(i.bound,n.row)>=0&&(yield n)}}*cleanup(e){g(e.start===void 0),g(dh(e.constraint,r(this,ue)));const t=Sr(r(this,ue),e.constraint);r(this,ve).del(t);let n=0;for(const s of r(this,Q).cleanup(e)){if(n===r(this,et))return;n++,yield s}}push(e){if(e.type==="edit"){p(this,q,tv).call(this,e);return}const{takeState:t,takeStateKey:n,maxBound:s,constraint:i}=p(this,q,dl).call(this,e.node.row);if(!t)return;const{compareRows:o}=this.getSchema();if(e.type==="add"){if(t.size<r(this,et)){p(this,q,Le).call(this,n,t.size+1,t.bound===void 0||o(t.bound,e.node.row)<0?e.node.row:t.bound,s),r(this,z).push(e);return}if(t.bound===void 0||o(e.node.row,t.bound)>=0)return;let a,c;r(this,et)===1?c=$(Er(r(this,Q).fetch({start:{row:t.bound,basis:"at"},constraint:i}))):[c,a]=Hc(r(this,Q).fetch({start:{row:t.bound,basis:"at"},constraint:i,reverse:!0}),2);const u={type:"remove",node:c};p(this,q,Le).call(this,n,t.size,a===void 0||o(e.node.row,a.row)>0?e.node.row:a.row,s),r(this,z).push(u),r(this,z).push(e)}else if(e.type==="remove"){if(t.bound===void 0||o(e.node.row,t.bound)>0)return;const[c]=Hc(r(this,Q).fetch({start:{row:t.bound,basis:"after"},constraint:i,reverse:!0}),1);let u;if(c){const l=o(c.row,t.bound)>0;u={node:c,push:l}}if(!(u!=null&&u.push))for(const l of r(this,Q).fetch({start:{row:t.bound,basis:"at"},constraint:i})){const m=o(l.row,t.bound)>0;if(u={node:l,push:m},m)break}if(u!=null&&u.push){p(this,q,Le).call(this,n,t.size,u.node.row,s),r(this,z).push(e),r(this,z).push({type:"add",node:u.node});return}p(this,q,Le).call(this,n,t.size-1,u==null?void 0:u.node.row,s),r(this,z).push(e)}else e.type==="child"&&t.bound&&o(e.node.row,t.bound)<=0&&r(this,z).push(e)}destroy(){r(this,Q).destroy()}},Q=new WeakMap,ve=new WeakMap,et=new WeakMap,ue=new WeakMap,Di=new WeakMap,z=new WeakMap,q=new WeakSet,ev=function*(e){if(g(e.start===void 0),g(!e.reverse),g(dh(e.constraint,r(this,ue))),r(this,et)===0)return;const t=Sr(r(this,ue),e.constraint);g(r(this,ve).get(t)===void 0);let n=0,s,i=!0,o=!1;try{for(const a of r(this,Q).fetch(e))if(yield a,s=a.row,n++,n===r(this,et))break;i=!1}catch(a){throw o=!0,a}finally{o||(p(this,q,Le).call(this,t,n,s,r(this,ve).get(pc)),g(!i,"Unexpected early return prevented full hydration"))}},dl=function(e){const t=Sr(r(this,ue),e),n=r(this,ve).get(t);let s,i;return n&&(s=r(this,ve).get(pc),i=r(this,ue)&&Object.fromEntries(r(this,ue).map(o=>[o,e[o]]))),{takeState:n,takeStateKey:t,maxBound:s,constraint:i}},tv=function(e){if(r(this,Di)&&r(this,Di).call(this,e.oldNode.row,e.node.row)!==0){this.push({type:"remove",node:e.oldNode}),this.push({type:"add",node:e.node});return}const{takeState:t,takeStateKey:n,maxBound:s,constraint:i}=p(this,q,dl).call(this,e.oldNode.row);if(!t)return;g(t.bound,"Bound should be set");const{compareRows:o}=this.getSchema(),a=o(e.oldNode.row,t.bound),c=o(e.node.row,t.bound),u=()=>{p(this,q,Le).call(this,n,t.size,e.node.row,s),r(this,z).push(e)};if(a===0){if(c===0){r(this,z).push(e);return}if(c<0){if(r(this,et)===1){u();return}const m=$(Er(r(this,Q).fetch({start:{row:t.bound,basis:"after"},constraint:i,reverse:!0})));p(this,q,Le).call(this,n,t.size,m.row,s),r(this,z).push(e);return}g(c>0);const l=$(Er(r(this,Q).fetch({start:{row:t.bound,basis:"at"},constraint:i})));if(o(l.row,e.node.row)===0){u();return}p(this,q,Le).call(this,n,t.size,l.row,s),r(this,z).push({type:"remove",node:e.oldNode}),r(this,z).push({type:"add",node:l});return}if(a>0){if(g(c!==0,"Invalid state. Row has duplicate primary key"),c>0)return;g(c<0);const[l,m]=Hc(r(this,Q).fetch({start:{row:t.bound,basis:"at"},constraint:i,reverse:!0}),2);p(this,q,Le).call(this,n,t.size,m.row,s),r(this,z).push({type:"remove",node:l}),r(this,z).push({type:"add",node:e.node});return}if(a<0){if(g(c!==0,"Invalid state. Row has duplicate primary key"),c<0){r(this,z).push(e);return}g(c>0);const l=$(Er(r(this,Q).fetch({start:{row:t.bound,basis:"after"},constraint:i})));if(o(l.row,e.node.row)===0){u();return}p(this,q,Le).call(this,n,t.size,l.row,s),r(this,z).push({type:"remove",node:e.oldNode}),r(this,z).push({type:"add",node:l});return}me()},Le=function(e,t,n,s){r(this,ve).set(e,{size:t,bound:n}),n!==void 0&&(s===void 0||this.getSchema().compareRows(n,s)>0)&&r(this,ve).set(pc,n)},Tp);function Sr(e,t){const n=[];if(e&&t)for(const s of e)n.push(t[s]);return JSON.stringify(["take",...n])}function dh(e,t){if(e===void 0||t===void 0)return e===t;if(t.length!==Object.keys(e).length)return!1;for(const n of t)if(!ls(e,n))return!1;return!0}function _C(e){return(t,n)=>{for(const s of e){const i=zl(t[s],n[s]);if(i!==0)return i}return 0}}function mc(e,t){const n=xC(String(e),t);return s=>(j(s),n(String(s)))}function xC(e,t){if(!/_|%|\\/.test(e)){if(t==="i"){const s=e.toLowerCase();return i=>i.toLowerCase()===s}return s=>s===e}const n=NC(e,t);return s=>n.test(s)}var MC=/[$()*+.?[\]\\^{|}]/;function NC(e,t=""){let n="^";for(let s=0;s<e.length;s++){let i=e[s];switch(i){case"%":n+=".*";break;case"_":n+=".";break;case"\\":if(s===e.length-1)throw new Error("LIKE pattern must not end with escape character");s++,i=e[s];default:MC.test(i)&&(n+="\\"),n+=i;break}}return new RegExp(n+"$",t+"m")}function Ur(e){if(e.type!=="simple"){const i=e.conditions.map(o=>Ur(o));return e.type==="and"?o=>{for(const a of i)if(!a(o))return!1;return!0}:o=>{for(const a of i)if(a(o))return!0;return!1}}const{left:t}=e,{right:n}=e;switch(g(n.type!=="static","static values should be resolved before creating predicates"),g(t.type!=="static","static values should be resolved before creating predicates"),e.op){case"IS":case"IS NOT":{const i=RC(n.value,e.op);if(t.type==="literal"){const o=i(t.value);return()=>o}return o=>i(o[t.name])}}if(n.value===null||n.value===void 0)return i=>!1;const s=OC(n.value,e.op);if(t.type==="literal"){if(t.value===null||t.value===void 0)return o=>!1;const i=s(t.value);return()=>i}return i=>{const o=i[t.name];return o==null?!1:s(o)}}function RC(e,t){switch(t){case"IS":return n=>n===e;case"IS NOT":return n=>n!==e}}function OC(e,t){switch(t){case"=":return n=>n===e;case"!=":return n=>n!==e;case"<":return n=>n<e;case"<=":return n=>n<=e;case">":return n=>n>e;case">=":return n=>n>=e;case"LIKE":return mc(e,"");case"NOT LIKE":return bf(mc(e,""));case"ILIKE":return mc(e,"i");case"NOT ILIKE":return bf(mc(e,"i"));case"IN":{g(Array.isArray(e));const n=new Set(e);return s=>n.has(s)}case"NOT IN":{g(Array.isArray(e));const n=new Set(e);return s=>!n.has(s)}default:throw new Error(`Unexpected operator: ${t}`)}}function bf(e){return t=>!e(t)}function nv(e){if(!e)return{filters:void 0,conditionsRemoved:!1};switch(e.type){case"simple":return{filters:e,conditionsRemoved:!1};case"correlatedSubquery":return{filters:void 0,conditionsRemoved:!0};case"and":{const t=[];for(const s of e.conditions)g(s.type==="simple"||s.type==="correlatedSubquery"),s.type==="simple"&&t.push(s);const n=t.length!==e.conditions.length;return t.length===0?{filters:void 0,conditionsRemoved:n}:t.length===1?{filters:t[0],conditionsRemoved:n}:{filters:{type:"and",conditions:t},conditionsRemoved:n}}case"or":{const t=[];let n=!1;for(const s of e.conditions){g(s.type!=="or");const i=nv(s);if(i.filters===void 0)return{filters:void 0,conditionsRemoved:!0};n=n||i.conditionsRemoved,t.push(i.filters)}return{filters:{type:"or",conditions:t},conditionsRemoved:n}}default:me()}}function TC(e,t){return sv(e,t)}function sv(e,t,n){const s=t.getSource(e.table);if(!s)throw new Error(`Source not found: ${e.table}`);const i=s.connect($(e.orderBy),e.where);let o=i;const{fullyAppliedFilters:a}=i;e=jC(e),e.start&&(o=new DC(o,e.start));for(const c of $C(e.where))o=kf(c,t,o);if(e.where&&!a&&(o=pd(o,e.where,t)),e.limit&&(o=new EC(o,t.createStorage(),e.limit,n)),e.related)for(const c of e.related)o=kf(c,t,o);return o}function pd(e,t,n){switch(t.type){case"and":return PC(e,t,n);case"or":return HC(e,t,n);case"correlatedSubquery":return FC(e,t,n);case"simple":return AC(e,t)}}function PC(e,t,n){for(const s of t.conditions)e=pd(e,s,n);return e}function HC(e,t,n){const[s,i]=LC(t);if(s.length===0)return new ul(e,Ur({type:"or",conditions:i}));const o=new kC(e),a=s.map(c=>pd(o,c,n));return i.length>0&&a.push(new ul(o,Ur({type:"or",conditions:i}))),new bC(o,a)}function LC(e){const t=[[],[]];for(const n of e.conditions)iv(n)?t[1].push(n):t[0].push(n);return t}function iv(e){return e.type==="correlatedSubquery"?!1:e.type==="and"?e.conditions.every(iv):(g(e.type!=="or","where conditions are expected to be in DNF"),!0)}function AC(e,t){return new ul(e,Ur(t))}function kf(e,t,n){g(e.subquery.alias,"Subquery must have an alias");const s=sv(e.subquery,t,e.correlation.childField);return n=new IC({parent:n,child:s,storage:t.createStorage(),parentKey:e.correlation.parentField,childKey:e.correlation.childField,relationshipName:e.subquery.alias,hidden:e.hidden??!1,system:e.system??"client"}),n}function FC(e,t,n){return g(t.op==="EXISTS"||t.op==="NOT EXISTS"),new SC(e,n.createStorage(),$(t.related.subquery.alias),t.related.correlation.parentField,t.op)}function $C(e){const t=[],n=s=>{if(s.type==="correlatedSubquery"){g(s.op==="EXISTS"||s.op==="NOT EXISTS"),t.push({...s.related,subquery:{...s.related.subquery,limit:s.related.system==="permissions"?GC:VC}});return}if(s.type==="and"||s.type==="or"){for(const i of s.conditions)n(i);return}};return e&&n(e),t}var VC=3,GC=1;function fl(e,t){const n=e.map(([i])=>i),s=t.filter(i=>!n.includes(i));if(s.length>0)throw new Error(`Ordering must include all primary key fields. Missing: ${s.join(", ")}. ZQL automatically appends primary key fields to the ordering if they are missing 
      so a common cause of this error is a casing mismatch between Postgres and ZQL.
      E.g., "userid" vs "userID".
      You may want to add double-quotes around your Postgres column names to prevent Postgres from lower-casing them:
      https://www.postgresql.org/docs/current/sql-syntax-lexical.htm`)}function jC(e){if(!e.where)return e;const{where:t}=e;if(t.type!=="and"&&t.type!=="or")return e;let n=0;const s=a=>({...a,related:{...a.related,subquery:{...a.related.subquery,alias:(a.related.subquery.alias??"")+"_"+n++}}}),i=a=>{const c=[];for(const u of a.conditions)u.type==="correlatedSubquery"?c.push(s(u)):c.push(u);return{...a,conditions:c}};if(t.type==="and")return{...e,where:i(t)};const o=[];for(const a of t.conditions)a.type==="simple"?o.push(a):a.type==="correlatedSubquery"?o.push(s(a)):a.type==="and"&&o.push(i(a));return{...e,where:{...t,conditions:o}}}var ua,Bn,Ei,_i,Kn,Un,xi,lt,pl,ml,rv,Pp,zC=(Pp=class{constructor(e,t={singular:!1,relationships:{}},n=!0){h(this,lt);h(this,ua);h(this,Bn,new Set);h(this,Ei);h(this,_i);h(this,Kn);v(this,"onDestroy");h(this,Un,!1);h(this,xi,!1);d(this,ua,e),d(this,Ei,e.getSchema()),d(this,_i,t),d(this,Kn,{"":t.singular?void 0:[]}),e.setOutput(this),n===!0?d(this,xi,!0):n.then(()=>{d(this,xi,!0),p(this,lt,pl).call(this)}),p(this,lt,rv).call(this)}get data(){return r(this,Kn)[""]}addListener(e){return g(!r(this,Bn).has(e),"Listener already registered"),r(this,Bn).add(e),p(this,lt,ml).call(this,e),()=>{r(this,Bn).delete(e)}}destroy(){var e;(e=this.onDestroy)==null||e.call(this)}push(e){d(this,Un,!0),ks(r(this,Kn),e,r(this,Ei),"",r(this,_i))}flush(){r(this,Un)&&(d(this,Un,!1),p(this,lt,pl).call(this))}},ua=new WeakMap,Bn=new WeakMap,Ei=new WeakMap,_i=new WeakMap,Kn=new WeakMap,Un=new WeakMap,xi=new WeakMap,lt=new WeakSet,pl=function(){for(const e of r(this,Bn))p(this,lt,ml).call(this,e)},ml=function(e){e(this.data,r(this,xi)?"complete":"unknown")},rv=function(){d(this,Un,!0);for(const e of r(this,ua).fetch({}))ks(r(this,Kn),{type:"add",node:e},r(this,Ei),"",r(this,_i));this.flush()},Pp),ha,Hp,ov=(Hp=class{constructor(e){h(this,ha);v(this,"and",av);v(this,"or",BC);v(this,"not",yl);d(this,ha,e),this.exists=this.exists.bind(this)}get eb(){return this}cmp(e,t,n){return cv(e,t,n)}cmpLit(e,t,n){return{type:"simple",left:wl(e)?e[ln]():{type:"literal",value:e},right:wl(n)?n[ln]():{type:"literal",value:n},op:t}}exists(e,t){return r(this,ha).call(this,e,t)}},ha=new WeakMap,Hp);function av(...e){const t=QC(dv(e));return t.length===1?t[0]:t.some(lv)?KC:{type:"and",conditions:t}}function BC(...e){const t=JC(dv(e));return t.length===1?t[0]:t.some(hv)?uv:{type:"or",conditions:t}}function yl(e){switch(e.type){case"and":return{type:"or",conditions:e.conditions.map(yl)};case"or":return{type:"and",conditions:e.conditions.map(yl)};case"correlatedSubquery":return{type:"correlatedSubquery",related:e.related,op:If(e.op)};case"simple":return{type:"simple",op:If(e.op),left:e.left,right:e.right}}}function cv(e,t,n){let s;return n===void 0?(n=t,s="="):s=t,{type:"simple",left:{type:"column",name:e},right:wl(n)?n[ln]():{type:"literal",value:n},op:s}}function wl(e){return e!==null&&typeof e=="object"&&e[ln]}var uv={type:"and",conditions:[]},KC={type:"or",conditions:[]};function hv(e){return e.type==="and"&&e.conditions.length===0}function lv(e){return e.type==="or"&&e.conditions.length===0}function md(e,t){const n=[];for(const s of t)s.type===e?n.push(...s.conditions):n.push(s);return n}var UC={"=":"!=","!=":"=","<":">=",">":"<=",">=":"<","<=":">",IN:"NOT IN","NOT IN":"IN",LIKE:"NOT LIKE","NOT LIKE":"LIKE",ILIKE:"NOT ILIKE","NOT ILIKE":"ILIKE",IS:"IS NOT","IS NOT":"IS"},qC={...UC,EXISTS:"NOT EXISTS","NOT EXISTS":"EXISTS"};function If(e){return $(qC[e])}function dv(e){return e.filter(t=>t!==void 0)}function QC(e){return e.filter(t=>!hv(t))}function JC(e){return e.filter(t=>!lv(t))}function WC(e){return gl(vl(e))}function vl(e){switch(e.type){case"simple":case"correlatedSubquery":return{type:"or",conditions:[e]};case"and":return XC(e.conditions.map(vl));case"or":return{type:"or",conditions:md("or",e.conditions.map(vl).flatMap(t=>t.conditions))};default:me()}}function XC(e){return e.length===0?{type:"or",conditions:[uv]}:e.reduce((t,n)=>{const s=[];for(const i of t.conditions)for(const o of n.conditions)s.push({type:"and",conditions:[i,o]});return{type:"or",conditions:md("or",s)}})}function gl(e){return e.type==="simple"||e.type==="correlatedSubquery"?e:e.conditions.length===1?gl(e.conditions[0]):{type:e.type,conditions:md(e.type,e.conditions.map(gl))}}var YC=Symbol();function fv(e,t,n){return new mv(e,t,n)}function ZC(e,t,n,s,i,o){return new mv(e,t,n,s,i,o)}function eD(e,t){return{type:"static",anchor:e,field:t.length===1?t[0]:t}}var br="zsubq_",V,he,F,le,se,Mi,qn,Lp,pv=(Lp=class{constructor(e,t,n={table:t},s,i){h(this,V);h(this,he);h(this,F);h(this,le);h(this,se);h(this,Mi,"");v(this,"_exists",(e,t=n=>n)=>{const n=r(this,V).relationships[r(this,he)][e];if(g(n,"Invalid relationship"),wf(n)){const{destSchema:s,sourceField:i,destField:o}=n[0];g(Me(i),"Invalid relationship"),g(Me(o),"Invalid relationship");const a=t(this._newQuery(r(this,V),s,{table:s,alias:`${br}${e}`},r(this,le),void 0));return{type:"correlatedSubquery",related:{system:this._system,correlation:{parentField:i,childField:o},subquery:yc(r(this,V).tables[s],r(a,F))},op:"EXISTS"}}if(vf(n)){g(n.length===2,"Invalid relationship");const[s,i]=n;g(Me(s.sourceField),"Invalid relationship"),g(Me(s.destField),"Invalid relationship"),g(Me(i.sourceField),"Invalid relationship"),g(Me(i.destField),"Invalid relationship");const{destSchema:o}=i,a=s.destSchema,c=t(this._newQuery(r(this,V),o,{table:o,alias:`${br}${e}`},r(this,le),void 0));return{type:"correlatedSubquery",related:{system:this._system,correlation:{parentField:s.sourceField,childField:s.destField},subquery:{table:a,alias:`${br}${e}`,orderBy:Mr(r(this,V).tables[a],void 0),where:{type:"correlatedSubquery",related:{system:this._system,correlation:{parentField:i.sourceField,childField:i.destField},subquery:yc(r(this,V).tables[o],r(c,F))},op:"EXISTS"}}},op:"EXISTS"}}throw new Error(`Invalid relationship ${e}`)});h(this,qn);d(this,V,e),d(this,he,t),d(this,F,n),d(this,le,s),d(this,se,i??{singular:!1,relationships:{}})}get format(){return r(this,se)}get[YC](){return r(this,F)}hash(){if(!r(this,Mi)){const e=this._completeAst(),t=Uw(e);d(this,Mi,t)}return r(this,Mi)}one(){return this._newQuery(r(this,V),r(this,he),{...r(this,F),limit:1},r(this,le),{...r(this,se),singular:!0})}whereExists(e,t){return this.where(({exists:n})=>n(e,t))}related(e,t){if(e.startsWith(br))throw new Error(`Relationship names may not start with "${br}". That is a reserved prefix.`);t=t??(s=>s);const n=r(this,V).relationships[r(this,he)][e];if(g(n,"Invalid relationship"),wf(n)){const{destSchema:s,destField:i,sourceField:o,cardinality:a}=n[0],c=t(this._newQuery(r(this,V),s,{table:s,alias:e},r(this,le),{relationships:{},singular:a==="one"}));return g(Me(o),"The source of a relationship must specify at last 1 field"),g(Me(i),"The destination of a relationship must specify at last 1 field"),g(o.length===i.length,"The source and destination of a relationship must have the same number of fields"),this._newQuery(r(this,V),r(this,he),{...r(this,F),related:[...r(this,F).related??[],{system:this._system,correlation:{parentField:o,childField:i},subquery:yc(r(this,V).tables[s],r(c,F))}]},r(this,le),{...r(this,se),relationships:{...r(this,se).relationships,[e]:r(c,se)}})}if(vf(n)){g(n.length===2,"Invalid relationship");const[s,i]=n,{destSchema:o}=i,a=s.destSchema,c=t(this._newQuery(r(this,V),o,{table:o,alias:e},r(this,le),{relationships:{},singular:i.cardinality==="one"}));return g(Me(s.sourceField),"Invalid relationship"),g(Me(s.destField),"Invalid relationship"),g(Me(i.sourceField),"Invalid relationship"),g(Me(i.destField),"Invalid relationship"),this._newQuery(r(this,V),r(this,he),{...r(this,F),related:[...r(this,F).related??[],{system:this._system,correlation:{parentField:s.sourceField,childField:s.destField},hidden:!0,subquery:{table:a,alias:e,orderBy:Mr(r(this,V).tables[a],void 0),related:[{system:this._system,correlation:{parentField:i.sourceField,childField:i.destField},subquery:yc(r(this,V).tables[o],r(c,F))}]}}]},r(this,le),{...r(this,se),relationships:{...r(this,se).relationships,[e]:r(c,se)}})}throw new Error(`Invalid relationship ${e}`)}where(e,t,n){let s;typeof e=="function"?s=e(new ov(this._exists)):(g(t!==void 0,"Invalid condition"),s=cv(e,t,n));const i=r(this,F).where;return i&&(s=av(i,s)),this._newQuery(r(this,V),r(this,he),{...r(this,F),where:WC(s)},r(this,le),r(this,se))}start(e,t){return this._newQuery(r(this,V),r(this,he),{...r(this,F),start:{row:e,exclusive:!(t!=null&&t.inclusive)}},r(this,le),r(this,se))}limit(e){if(e<0)throw new Error("Limit must be non-negative");if((e|0)!==e)throw new Error("Limit must be an integer");return this._newQuery(r(this,V),r(this,he),{...r(this,F),limit:e},r(this,le),r(this,se))}orderBy(e,t){return this._newQuery(r(this,V),r(this,he),{...r(this,F),orderBy:[...r(this,F).orderBy??[],[e,t]]},r(this,le),r(this,se))}_completeAst(){if(!r(this,qn)){const e=Mr(r(this,V).tables[r(this,he)],r(this,F).orderBy);if(r(this,F).start){const{row:t}=r(this,F).start,n={};for(const[s]of e)n[s]=t[s];d(this,qn,{...r(this,F),start:{...r(this,F).start,row:n},orderBy:e})}else d(this,qn,{...r(this,F),orderBy:Mr(r(this,V).tables[r(this,he)],r(this,F).orderBy)})}return r(this,qn)}},V=new WeakMap,he=new WeakMap,F=new WeakMap,le=new WeakMap,se=new WeakMap,Mi=new WeakMap,qn=new WeakMap,Lp),tD=Symbol(),tt,Ap,mv=(Ap=class extends pv{constructor(t,n,s,i,o,a){super(n,s,i,o,a);h(this,tt);v(this,"_system","client");d(this,tt,t)}get[tD](){return this._completeAst()}_newQuery(t,n,s,i,o){return ZC(r(this,tt),t,n,s,i,o)}materialize(t){const n=this._completeAst(),s=A();let i=!1;const a=r(this,tt).addServerQuery(n,void 0,y=>{y&&(i=!0,s.resolve(!0))}),c=TC(n,r(this,tt));let u;const l=()=>{c.destroy(),u==null||u(),a()};return r(this,tt).batchViewUpdates(()=>(t??nD)(this,c,this.format,l,y=>{u=r(this,tt).onTransactionCommit(y)},i||s.promise))}run(){const t=this.materialize(),n=t.data;return t.destroy(),n}preload(){const{resolve:t,promise:n}=A(),s=this._completeAst();return{cleanup:r(this,tt).addServerQuery(s,void 0,a=>{a&&t()}),complete:n}}},tt=new WeakMap,Ap);function Mr(e,t){t=t??[];const{primaryKey:n}=e,s=new Set(n);for(const[i]of t)s.delete(i);return s.size===0?t:[...t,...[...s].map(i=>[i,"asc"])]}function yc(e,t){return{...t,orderBy:Mr(e,t.orderBy)}}function nD(e,t,n,s,i,o){const a=new zC(t,n,o);return a.onDestroy=s,i(()=>{a.flush()}),a}function Me(e){return Array.isArray(e)&&e.length>=1}var sD=class yv extends pv{constructor(){super(...arguments);v(this,"_system","permissions")}expressionBuilder(){return new ov(this._exists)}_newQuery(n,s,i,o,a){return new yv(n,s,i,o,a)}get ast(){return this._completeAst()}materialize(){throw new Error("AuthQuery cannot be materialized")}run(){throw new Error("AuthQuery cannot be run")}preload(){throw new Error("AuthQuery cannot be preloaded")}};function yd(e){return wv("client",e)}function iD(e){return wv("server",e)}function wv(e,t){const n=new Map(Object.entries(t).map(([s,{serverName:i,columns:o}])=>{let a=!0;const c={};for(const[u,{serverName:l}]of Object.entries(o))l&&l!==u&&(a=!1),e==="client"?c[u]=l??u:c[l??u]=u;return[e==="client"?s:i??s,{tableName:e==="client"?i??s:s,columns:c,allColumnsSame:a}]}));return new rD(n)}var la,Qn,Nr,Fp,rD=(Fp=class{constructor(e){h(this,Qn);h(this,la,new Map);d(this,la,e)}tableName(e,t){return p(this,Qn,Nr).call(this,e,t).tableName}columnName(e,t,n){const s=p(this,Qn,Nr).call(this,e,n).columns[t];if(!s)throw new Error(`unknown column "${t}" of "${e}" table ${n?`in ${JSON.stringify(n)}`:""}`);return s}row(e,t){const n=p(this,Qn,Nr).call(this,e),{allColumnsSame:s,columns:i}=n;if(s)return t;const o={};for(const a in t)o[i[a]??a]=t[a];return o}columns(e,t){const n=p(this,Qn,Nr).call(this,e),{allColumnsSame:s,columns:i}=n;return t===void 0||s?t:t.map(o=>i[o]??o)}},la=new WeakMap,Qn=new WeakSet,Nr=function(e,t){const n=r(this,la).get(e);if(!n)throw new Error(`unknown table "${e}" ${t?`in ${JSON.stringify(t)}`:""}`);return n},Fp),Cf=[(e,t)=>t.and()],Ss=[];async function oD(e,t){const n={};for(const i of Object.keys(e.tables))n[i]=new sD(e,i).expressionBuilder();const s=await t();return aD(e,s,n)}function aD(e,t,n){if(!t)return;const s=yd(e.tables),i={tables:{}};for(const[o,a]of Object.entries(t)){const c=e.tables[o].serverName??o;i.tables[c]={row:cD(s,o,a.row,n[o]),cell:uD(s,o,a.cell,n[o])}}return i}function cD(e,t,n,s){var i,o;if(n)return{select:ct(e,t,n.select,s),insert:ct(e,t,n.insert,s),update:{preMutation:ct(e,t,(i=n.update)==null?void 0:i.preMutation,s),postMutation:ct(e,t,(o=n.update)==null?void 0:o.postMutation,s)},delete:ct(e,t,n.delete,s)}}function ct(e,t,n,s){if(n)return n.map(i=>{const o=i(lD,s);return["allow",yC(o,t,e)]})}function uD(e,t,n,s){var o,a;if(!n)return;const i={};for(const[c,u]of Object.entries(n))i[c]={select:ct(e,t,u.select,s),insert:ct(e,t,u.insert,s),update:{preMutation:ct(e,t,(o=u.update)==null?void 0:o.preMutation,s),postMutation:ct(e,t,(a=u.update)==null?void 0:a.postMutation,s)},delete:ct(e,t,u.delete,s)};return i}var Ni,da,Ri,hD=(Ri=class{constructor(t,n){h(this,Ni);h(this,da);d(this,Ni,t),d(this,da,n)}get(t,n){if(n===ln)return t[ln];g(typeof n=="string");const s=[...r(this,da),n];return new Proxy({[ln]:()=>eD(r(this,Ni),s)},new Ri(r(this,Ni),s))}},Ni=new WeakMap,da=new WeakMap,Ri);function vv(e){return new Proxy({[ln]:()=>{throw new Error("no JWT field specified")}},new hD(e,[]))}var lD=vv("authData");vv("preMutationRow");var gv=f.union(W({clientIDs:_e(f.string()).optional(),clientGroupIDs:_e(f.string()).optional()})),dD=f.tuple([f.literal("deleteClients"),gv]),fD=f.object({op:f.literal("put"),hash:f.string(),ast:Vw,ttl:f.number().optional()}),pD=f.object({op:f.literal("del"),hash:f.string()}),mD=f.object({op:f.literal("clear")}),yD=f.union(fD,pD,mD),Sl=f.array(yD),wD=f.object({wsid:f.string(),timestamp:f.number().optional()}),vD=f.tuple([f.literal("connected"),wD]),gD=f.object({desiredQueriesPatch:Sl,deleted:gv.optional()});f.tuple([f.literal("initConnection"),gD]);function Df(e,t){return encodeURIComponent(btoa(JSON.stringify({initConnectionMessage:e,authToken:t})))}var Sv="AuthInvalidated",bv="ClientNotFound",SD="InvalidConnectionRequest",kv="InvalidConnectionRequestBaseCookie",Iv="InvalidConnectionRequestLastMutationID",bD="InvalidConnectionRequestClientDeleted",kD="InvalidMessage",ID="InvalidPush",CD="MutationFailed",Cv="MutationRateLimited",Dv="Rebalance",Ev="Rehome",_v="Unauthorized",xv="VersionNotSupported",Mv="SchemaVersionNotSupported",Nv="ServerOverloaded",DD="Internal",ED=f.union(f.literal(Sv),f.literal(bv),f.literal(SD),f.literal(kv),f.literal(Iv),f.literal(bD),f.literal(kD),f.literal(ID),f.literal(Cv),f.literal(CD),f.literal(_v),f.literal(xv),f.literal(Mv),f.literal(DD)),_D=f.object({kind:ED,message:f.string()}),xD=f.union(f.literal(Dv),f.literal(Ev),f.literal(Nv)),MD=f.object({kind:xD,message:f.string(),minBackoffMs:f.number().optional(),maxBackoffMs:f.number().optional(),reconnectParams:f.record(f.string()).optional()}),ND=f.union(_D,MD),RD=f.tuple([f.literal("error"),ND]),Ku=f.tuple([f.string()]).concat(f.array(f.string())),bl=f.union(f.string(),f.number(),f.boolean()),wd=sc(bl),OD=f.object({op:f.literal("put"),tableName:f.string(),value:ac}),TD=f.object({op:f.literal("update"),tableName:f.string(),id:wd,merge:uk.optional(),constrain:f.array(f.string()).optional()}),PD=f.object({op:f.literal("del"),tableName:f.string(),id:wd}),HD=f.object({op:f.literal("clear")}),LD=f.union(OD,TD,PD,HD),AD=f.array(LD),Uu=f.string(),du=f.union(Uu,f.null()),FD=f.object({pokeID:f.string(),baseCookie:du,cookie:Uu.optional(),schemaVersions:f.object({minSupportedVersion:f.number(),maxSupportedVersion:f.number()}).optional(),timestamp:f.number().optional()}),$D=f.object({pokeID:f.string(),lastMutationIDChanges:f.record(f.number()).optional(),desiredQueriesPatches:f.record(Sl).optional(),gotQueriesPatch:Sl.optional(),rowsPatch:AD.optional()}),VD=f.object({pokeID:f.string(),cookie:Uu,cancel:f.boolean().optional()}),GD=f.tuple([f.literal("pokeStart"),FD]),jD=f.tuple([f.literal("pokePart"),$D]),zD=f.tuple([f.literal("pokeEnd"),VD]),BD=f.object({}),KD=f.tuple([f.literal("pong"),BD]),UD=f.object({clientGroupID:f.string(),cookie:du,requestID:f.string()}),qD=f.object({cookie:Uu,requestID:f.string(),lastMutationIDChanges:f.record(f.number())});f.tuple([f.literal("pull"),UD]);var QD=f.tuple([f.literal("pull"),qD]),JD=f.object({payload:f.string()}),WD=f.tuple([f.literal("warm"),JD]),XD=f.union(vD,WD,RD,KD,GD,jD,zD,QD,dD),Rv="crud",Ov="custom",qu=6,YD=2;g(YD<qu);var ZD=4;g(ZD<qu);var fu="_zero_crud",eE=f.object({op:f.literal("insert"),tableName:f.string(),primaryKey:Ku,value:ac}),tE=f.object({op:f.literal("upsert"),tableName:f.string(),primaryKey:Ku,value:ac}),nE=f.object({op:f.literal("update"),tableName:f.string(),primaryKey:Ku,value:ac}),sE=f.object({op:f.literal("delete"),tableName:f.string(),primaryKey:Ku,value:wd}),iE=f.union(eE,tE,nE,sE),rE=f.object({ops:f.array(iE)}),oE=f.tuple([rE]),aE=f.object({type:f.literal(Rv),id:f.number(),clientID:f.string(),name:f.literal(fu),args:oE,timestamp:f.number()}),cE=f.object({type:f.literal(Ov),id:f.number(),clientID:f.string(),name:f.string(),args:f.array(ad),timestamp:f.number()}),uE=f.union(aE,cE),hE=f.object({clientGroupID:f.string(),mutations:f.array(uE),pushVersion:f.number(),schemaVersion:f.number(),timestamp:f.number(),requestID:f.string()});f.tuple([f.literal("push"),hE]);var lE=f.object({id:f.number(),clientID:f.string()}),dE=f.object({error:f.literal("app"),details:f.string()}),fE=f.object({error:f.literal("ooo-mutation")}),pE=f.object({}),mE=f.union(dE,fE),yE=f.union(pE,mE),wE=f.object({id:lE,result:yE}),vE=f.object({mutations:f.array(wE)}),gE=f.object({error:f.literal("unsupported-push-version")}),SE=f.object({error:f.literal("unsupported-schema-version")}),bE=f.union(gE,SE);f.union(vE,bE);function kE(e,t){return{ops:e.ops.map(({op:n,tableName:s,primaryKey:i,value:o})=>({op:n,tableName:t.tableName(s),primaryKey:t.columns(s,i),value:t.row(s,o)}))}}function Ef(e,t){return g(!e.includes("|"),"mutator namespaces must not include a |"),g(!t.includes("|"),"mutator names must not include a |"),`${e}|${t}`}function Tv(e=21){return kw(new Uint8Array(e)).reduce((n,s)=>(s&=63,s<36?n+=s.toString(36):s<62?n+=(s-26).toString(36).toUpperCase():s>62?n+="-":n+="_",n),"")}function wn(e,t){e.send(JSON.stringify(t))}var Rt=0,wc=1,kr=2,gn=32,G,ps,Pv,Il,Oi,kl=(Oi=class{constructor(t,n){h(this,ps);h(this,G,zc);v(this,"size",0);v(this,"comparator");if(this.comparator=t,n)for(const s of n)this.add(s)}clear(){d(this,G,zc),this.size=0}clone(){r(this,G).isShared=!0;const t=new Oi(this.comparator);return d(t,G,r(this,G)),t.size=this.size,t}get(t){return r(this,G).get(t,this)}add(t){r(this,G).isShared&&d(this,G,r(this,G).clone());const n=r(this,G).set(t,this);return n===null?this:(d(this,G,new IE([r(this,G),n])),this)}has(t){return r(this,G).has(t,this)}delete(t){return p(this,ps,Pv).call(this,t)}keys(){return fh(r(this,G),this.comparator,void 0,!0)}values(){return fh(r(this,G),this.comparator,void 0,!0)}valuesFrom(t,n=!0){return fh(r(this,G),this.comparator,t,n)}valuesReversed(){return _f(p(this,ps,Il).call(this),r(this,G),this.comparator,void 0,!0)}valuesFromReversed(t,n=!0){return _f(p(this,ps,Il).call(this),r(this,G),this.comparator,t,n)}[Symbol.iterator](){return this.keys()}},G=new WeakMap,ps=new WeakSet,Pv=function(t){let n=r(this,G);n.isShared&&d(this,G,n=n.clone());try{return n.delete(t,this)}finally{let s;for(;n.keys.length<=1&&n.isInternal();)s||(s=n.isShared),d(this,G,n=n.keys.length===0?zc:n.children[0]);s&&(n.isShared=!0)}},Il=function(){return r(this,G).maxKey()},Oi);function fh(e,t,n,s){const i=Cl(n,e,t);if(i===void 0)return pu(()=>({done:!0,value:void 0}));let[o,a,c]=i,u=n===void 0?-1:Ue(n,c.keys,0,t)-1;return!s&&u<c.keys.length&&t(c.keys[u+1],n)===0&&u++,pu(()=>{for(;;){if(++u<c.keys.length)return{done:!1,value:c.keys[u]};let l=-1;for(;;){if(++l>=o.length)return{done:!0,value:void 0};if(++a[l]<o[l].length)break}for(;l>0;l--)o[l-1]=o[l][a[l]].children,a[l-1]=0;c=o[0][a[0]],u=-1}})}function _f(e,t,n,s,i){if(s===void 0&&(s=e,s===void 0))return pu(()=>({done:!0,value:void 0}));let[o,a,c]=Cl(s,t,n)||Cl(e,t,n);g(!o[0]||c===o[0][a[0]]);let u=Ue(s,c.keys,0,n);return i&&u<c.keys.length&&n(c.keys[u],s)<=0&&u++,pu(()=>{for(;;){if(--u>=0)return{done:!1,value:c.keys[u]};let l;for(l=-1;;){if(++l>=o.length)return{done:!0,value:void 0};if(--a[l]>=0)break}for(;l>0;l--)o[l-1]=o[l][a[l]].children,a[l-1]=o[l-1].length-1;c=o[0][a[0]],u=c.keys.length}})}function Cl(e,t,n){let s=t;const i=[],o=[];if(s.isInternal()){for(let a=0;s.isInternal();a++){if(i[a]=s.children,o[a]=e===void 0?0:Ue(e,s.keys,0,n),o[a]>=i[a].length)return;s=i[a][o[a]]}i.reverse(),o.reverse()}return[i,o,s]}function pu(e){return{next:e,[Symbol.iterator](){return this}}}var Hv=class Dl{constructor(t){v(this,"keys");v(this,"isShared");this.keys=t,this.isShared=void 0}isInternal(){return!1}maxKey(){return this.keys[this.keys.length-1]}minKey(){return this.keys[0]}clone(){return new Dl(this.keys.slice(0))}get(t,n){const s=Ue(t,this.keys,-1,n.comparator);return s<0?void 0:this.keys[s]}has(t,n){const s=Ue(t,this.keys,-1,n.comparator);return s>=0&&s<this.keys.length}set(t,n){let s=Ue(t,this.keys,-1,n.comparator);if(s<0){if(s=~s,n.size++,this.keys.length<gn)return this.keys.splice(s,0,t),null;const i=this.splitOffRightSide();let o=this;return s>this.keys.length&&(s-=this.keys.length,o=i),o.keys.splice(s,0,t),i}return this.keys[s]=t,null}takeFromRight(t){this.keys.push(t.keys.shift())}takeFromLeft(t){this.keys.unshift(t.keys.pop())}splitOffRightSide(){const t=this.keys.length>>1,n=this.keys.splice(t);return new Dl(n)}delete(t,n){const s=n.comparator,i=Ue(t,this.keys,-1,s),o=i+1;if(i<0)return!1;const{keys:a}=this;for(let c=i;c<o;c++){if(a[c]!==a[c]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in delete");return this.keys.splice(c,1),n.size--,!0}return!1}mergeSibling(t,n){this.keys.push(...t.keys)}},IE=class El extends Hv{constructor(n,s){if(!s){s=[];for(let i=0;i<n.length;i++)s[i]=n[i].maxKey()}super(s);v(this,"children");this.children=n}isInternal(){return!0}clone(){const n=this.children.slice(0);for(let s=0;s<n.length;s++)n[s].isShared=!0;return new El(n,this.keys.slice(0))}minKey(){return this.children[0].minKey()}get(n,s){const i=Ue(n,this.keys,0,s.comparator),{children:o}=this;return i<o.length?o[i].get(n,s):void 0}has(n,s){const i=Ue(n,this.keys,0,s.comparator),{children:o}=this;return i<o.length?o[i].has(n,s):!1}set(n,s){const i=this.children,o=s.comparator;let a=Math.min(Ue(n,this.keys,0,o),i.length-1),c=i[a];if(c.isShared&&(i[a]=c=c.clone()),c.keys.length>=gn){let y;a>0&&(y=i[a-1]).keys.length<gn&&o(c.keys[0],n)<0?(y.isShared&&(i[a-1]=y=y.clone()),y.takeFromRight(c),this.keys[a-1]=y.maxKey()):(y=i[a+1])!==void 0&&y.keys.length<gn&&o(c.maxKey(),n)<0&&(y.isShared&&(i[a+1]=y=y.clone()),y.takeFromLeft(c),this.keys[a]=i[a].maxKey())}const u=c.set(n,s);if(this.keys[a]=c.maxKey(),u===null)return null;if(this.keys.length<gn)return this.insert(a+1,u),null;const l=this.splitOffRightSide();let m=this;return o(u.maxKey(),this.maxKey())>0&&(m=l,a-=this.keys.length),m.insert(a+1,u),l}insert(n,s){this.children.splice(n,0,s),this.keys.splice(n,0,s.maxKey())}splitOffRightSide(){const n=this.children.length>>1;return new El(this.children.splice(n),this.keys.splice(n))}takeFromRight(n){this.keys.push(n.keys.shift()),this.children.push(n.children.shift())}takeFromLeft(n){this.keys.unshift(n.keys.pop()),this.children.unshift(n.children.pop())}delete(n,s){const i=s.comparator,{keys:o}=this,{children:a}=this;let c=Ue(n,this.keys,0,i),u=c;const l=Math.min(c,o.length-1);if(u<=l)try{a[u].isShared&&(a[u]=a[u].clone());const m=a[u].delete(n,s);return o[u]=a[u].maxKey(),m}finally{const m=gn>>1;for(c>0&&c--,u=l;u>=c;u--)a[u].keys.length<=m&&(a[u].keys.length!==0?this.tryMerge(u,gn):(o.splice(u,1),a.splice(u,1)))}return!1}tryMerge(n,s){const{children:i}=this;return n>=0&&n+1<i.length&&i[n].keys.length+i[n+1].keys.length<=s?(i[n].isShared&&(i[n]=i[n].clone()),i[n].mergeSibling(i[n+1],s),i.splice(n+1,1),this.keys.splice(n+1,1),this.keys[n]=i[n].maxKey(),!0):!1}mergeSibling(n,s){const i=this.keys.length;this.keys.push(...n.keys);const o=n.children;if(this.children.push(...o),n.isShared&&!this.isShared)for(let a=0;a<o.length;a++)o[a].isShared=!0;this.tryMerge(i-1,s)}};function Ue(e,t,n,s){let i=0,o=t.length,a=o>>1;for(;i<o;){const c=s(t[a],e);if(c<0)i=a+1;else if(c>0)o=a;else{if(c===0)return a;if(e===e)return t.length;throw new Error("NaN was used as a key")}a=i+o>>1}return a^n}var zc=new Hv([]);zc.isShared=!0;function CE(e,t){return Pe(e[0],t[0])}var qt,$p,DE=($p=class{constructor(){h(this,qt,new kl(CE))}set(e,t){r(this,qt).add([e,t])}get(e,t){const n=r(this,qt).get([e,null]);return n!==void 0?n[1]:t}del(e){r(this,qt).delete([e,null])}*scan(e){for(const t of r(this,qt).valuesFrom(e&&[e.prefix,null])){if(e&&!t[0].startsWith(e.prefix))return;yield t}}cloneData(){return structuredClone(Object.fromEntries(r(this,qt).values()))}},qt=new WeakMap,$p);function Lv(e,t){for(const n in e)if(!um(t[n],e[n]))return!1;return!0}function EE(e,t){const n=Object.keys(e);if(n.length!==t.length)return!1;n.sort(xm);for(let s=0;s<n.length;s++)if(n[s][0]!==t[s])return!1;return!0}var Jn,Wn,ze,gt,Be,nt,Qt,te,Av,Fv,Bc,$v,_l,Vv,Ti,_E=(Ti=class{constructor(t,n,s,i){h(this,te);h(this,Jn);h(this,Wn);h(this,ze);h(this,gt);h(this,Be,new Map);h(this,nt,[]);h(this,Qt);d(this,Jn,t),d(this,Wn,n),d(this,ze,s),d(this,gt,s.map(a=>[a,"asc"]));const o=xf(r(this,gt));r(this,Be).set(JSON.stringify(r(this,gt)),{comparator:o,data:i??new kl(o),usedBy:new Set}),fl(r(this,gt),r(this,ze))}getSchemaInfo(){return{tableName:r(this,Jn),columns:r(this,Wn),primaryKey:r(this,ze)}}fork(){const t=p(this,te,Bc).call(this);return new Ti(r(this,Jn),r(this,Wn),r(this,ze),t.data.clone())}connect(t,n){const s=nv(n),i={getSchema:()=>a,fetch:c=>p(this,te,_l).call(this,c,o),cleanup:c=>p(this,te,Vv).call(this,c,o),setOutput:c=>{o.output=c},destroy:()=>{p(this,te,Fv).call(this,i)},fullyAppliedFilters:!s.conditionsRemoved},o={input:i,output:void 0,sort:t,compareRows:qg(t),filters:s.filters?{condition:s.filters,predicate:Ur(s.filters)}:void 0},a=p(this,te,Av).call(this,o);return fl(t,r(this,ze)),r(this,nt).push(o),i}getIndexKeys(){return[...r(this,Be).keys()]}push(t){for(const n of this.genPush(t));}*genPush(t){const n=p(this,te,Bc).call(this),{data:s}=n;switch(t.type){case"add":g(!s.has(t.row),()=>`Row already exists ${JSON.stringify(t)}`);break;case"remove":g(s.has(t.row),()=>`Row not found ${JSON.stringify(t)}`);break;case"edit":g(s.has(t.oldRow),()=>`Row not found ${JSON.stringify(t)}`);break;default:me()}const i=t.type==="edit"?{type:t.type,oldNode:{row:t.oldRow,relationships:{}},node:{row:t.row,relationships:{}}}:{type:t.type,node:{row:t.row,relationships:{}}};for(const[o,{output:a,filters:c}]of r(this,nt).entries())a&&(d(this,Qt,{outputIndex:o,change:t}),Ww(i,a,c==null?void 0:c.predicate),yield);d(this,Qt,void 0);for(const{data:o}of r(this,Be).values())switch(t.type){case"add":{const a=o.add(t.row);g(a);break}case"remove":{const a=o.delete(t.row);g(a);break}case"edit":{const a=o.delete(t.oldRow);g(a),o.add(t.row);break}default:me()}}},Jn=new WeakMap,Wn=new WeakMap,ze=new WeakMap,gt=new WeakMap,Be=new WeakMap,nt=new WeakMap,Qt=new WeakMap,te=new WeakSet,Av=function(t){return{tableName:r(this,Jn),columns:r(this,Wn),primaryKey:r(this,ze),sort:t.sort,system:"client",relationships:{},isHidden:!1,compareRows:t.compareRows}},Fv=function(t){const n=r(this,nt).findIndex(o=>o.input===t);g(n!==-1,"Connection not found");const s=r(this,nt)[n];r(this,nt).splice(n,1);const i=JSON.stringify(r(this,gt));for(const[o,a]of r(this,Be))o!==i&&(a.usedBy.delete(s),a.usedBy.size===0&&r(this,Be).delete(o))},Bc=function(){const t=r(this,Be).get(JSON.stringify(r(this,gt)));return g(t,"Primary index not found"),t},$v=function(t,n){const s=JSON.stringify(t),i=r(this,Be).get(s);if(i)return i.usedBy.add(n),i;const o=xf(t),a=new kl(o);for(const u of p(this,te,Bc).call(this).data)a.add(u);const c={comparator:o,data:a,usedBy:new Set([n])};return r(this,Be).set(s,c),c},_l=function*(t,n){var S,I;let s;const i=r(this,nt).indexOf(n);g(i!==-1,"Output not found");const o=r(this,nt)[i],{sort:a}=o,c=[];if(t.constraint)for(const D of Object.keys(t.constraint))c.push([D,"asc"]);(r(this,ze).length>1||!t.constraint||!EE(t.constraint,r(this,ze)))&&c.push(...a);const u=p(this,te,$v).call(this,c,n),{data:l,comparator:m}=u,y=(D,N)=>m(D,N)*(t.reverse?-1:1);r(this,Qt)&&i<=r(this,Qt).outputIndex&&(s=r(this,Qt));const w=(S=t.start)==null?void 0:S.row;let b;if(t.constraint){b={};for(const[D,N]of c)ls(t.constraint,D)?b[D]=t.constraint[D]:t.reverse?b[D]=N==="asc"?yu:mu:b[D]=N==="asc"?mu:yu}else b=w;const C=RE(w,FE(l,b,t.reverse),t.constraint,s,y,(I=o.filters)==null?void 0:I.predicate),k=xE(NE(C,t.start,y),t.constraint);yield*o.filters?ME(k,o.filters.predicate):k},Vv=function(t,n){return p(this,te,_l).call(this,t,n)},Ti);function*xE(e,t){for(const n of e){if(t&&!Lv(t,n.row))break;yield n}}function*ME(e,t){for(const n of e)t(n.row)&&(yield n)}function*NE(e,t,n){if(!t){yield*e;return}let s=!1;for(const i of e)s||(t.basis==="at"?n(i.row,t.row)>=0&&(s=!0):t.basis==="after"&&n(i.row,t.row)>0&&(s=!0)),s&&(yield i)}function*RE(e,t,n,s,i,o){const a=OE(e,n,s,i,o);yield*LE(t,a,i)}function OE(e,t,n,s,i){let o={add:void 0,remove:void 0};switch(n==null?void 0:n.change.type){case"add":o={add:n.change.row,remove:void 0};break;case"remove":o={add:void 0,remove:n.change.row};break;case"edit":o={add:n.change.row,remove:n.change.oldRow};break}return e&&(o=TE(o,e,s)),t&&(o=PE(o,t)),i&&(o=HE(o,i)),o}function TE({add:e,remove:t},n,s){const i=o=>o===void 0||s(o,n)<0?void 0:o;return{add:i(e),remove:i(t)}}function PE({add:e,remove:t},n){const s=i=>i===void 0||!Lv(n,i)?void 0:i;return{add:s(e),remove:s(t)}}function HE({add:e,remove:t},n){const s=i=>i===void 0||!n(i)?void 0:i;return{add:s(e),remove:s(t)}}function*LE(e,t,n){let s=!1,i=!1;for(const o of e){if(!s&&t.add&&n(t.add,o)<0&&(s=!0,yield{row:t.add,relationships:{}}),!i&&t.remove&&n(t.remove,o)===0){i=!0;continue}yield{row:o,relationships:{}}}!s&&t.add&&(yield{row:t.add,relationships:{}})}var mu=Symbol("min-value"),yu=Symbol("max-value");function xf(e){return(t,n)=>{for(const s of e){const i=s[0],o=AE(t[i],n[i]);if(o!==0)return s[1]==="asc"?o:-o}return 0}}function AE(e,t){return e===t?0:e===mu?-1:t===mu||e===yu?1:t===yu?-1:zl(e,t)}function*FE(e,t,n){yield*e[n?"valuesFromReversed":"valuesFrom"](t)}var Gv="d/",xl="g/",_t="e/";function $E(e,t){return Gv+e+"/"+t}function VE(e){return Gv+e+"/"}function GE(e){return xl+e}function cs(e,t,n){if(t.length===1)return _t+e+"/"+Et(n[t[0]],bl);const s=t.map(a=>Et(n[a],bl)),i=JSON.stringify(s),o=gC(i);return _t+e+"/"+o}function Ml(e){const t=e.indexOf("/",_t.length);return e.slice(_t.length,t)}var fa,pa,Jt,ma,Vp,jE=(Vp=class{constructor(e){h(this,fa);h(this,pa);h(this,Jt);h(this,ma);v(this,"advanceSyncHead",async(e,t,n)=>{if(r(this,Jt)===void 0)await pe(e,async s=>{const i=new Mf(r(this,pa)),o=await _0(t,s,Se);for await(const a of o.map.scan(_t)){if(!a[0].startsWith(_t))break;const c=Ml(a[0]);$(i.getSource(c)).push({type:"add",row:a[1]})}d(this,Jt,i)});else for(const s of n){if(s.op==="clear"){r(this,Jt).clear();continue}const{key:i}=s;if(!i.startsWith(_t))continue;const o=Ml(i),a=$(r(this,Jt).getSource(o));switch(s.op){case"del":a.push({type:"remove",row:s.oldValue});break;case"add":a.push({type:"add",row:s.newValue});break;case"change":a.push({type:"edit",row:s.newValue,oldRow:s.oldValue});break}}d(this,ma,$(r(this,Jt)).fork())});d(this,fa,new Mf(e)),d(this,pa,e)}get main(){return r(this,fa)}get rebase(){return $(r(this,ma),"rebase branch does not exist!")}},fa=new WeakMap,pa=new WeakMap,Jt=new WeakMap,ma=new WeakMap,Vp),St,Pi,Hi,Mf=(Hi=class{constructor(t,n=new Map){h(this,St);h(this,Pi);d(this,Pi,t),d(this,St,n)}getSource(t){if(r(this,St).has(t))return r(this,St).get(t);const n=r(this,Pi)[t],s=n?new _E(t,n.columns,n.primaryKey):void 0;return r(this,St).set(t,s),s}clear(){r(this,St).clear()}fork(){return new Hi(r(this,Pi),new Map(Jb(r(this,St).entries()).map(([t,n])=>[t,n==null?void 0:n.fork()])))}},St=new WeakMap,Pi=new WeakMap,Hi),ya,wa,va,Li,Du,zv,Gp,jv=(Gp=class{constructor(e,t,n){h(this,Du);h(this,ya);h(this,wa);h(this,va);h(this,Li,new Set);v(this,"staticQueryParameters");d(this,ya,e),d(this,wa,t),d(this,va,n)}getSource(e){return r(this,ya).getSource(e)}addServerQuery(e,t,n){return r(this,wa).call(this,e,t,n)}createStorage(){return new DE}onTransactionCommit(e){return r(this,Li).add(e),()=>{r(this,Li).delete(e)}}batchViewUpdates(e){let t,n=!1;return r(this,va).call(this,()=>{t=e(),n=!0}),g(n,"batchViewUpdates must call applyViewUpdates synchronously."),t}processChanges(e){this.batchViewUpdates(()=>{try{for(const t of e){const{key:n}=t;g(n.startsWith(_t));const s=Ml(n),i=this.getSource(s);if(i)switch(t.op){case"del":g(typeof t.oldValue=="object"),i.push({type:"remove",row:t.oldValue});break;case"add":g(typeof t.newValue=="object"),i.push({type:"add",row:t.newValue});break;case"change":g(typeof t.newValue=="object"),g(typeof t.oldValue=="object"),i.push({type:"edit",row:t.newValue,oldRow:t.oldValue});break;default:me(t)}}}finally{p(this,Du,zv).call(this)}})}},ya=new WeakMap,wa=new WeakMap,va=new WeakMap,Li=new WeakMap,Du=new WeakSet,zv=function(){for(const e of r(this,Li))e()},Gp);function zE(e,t){const{[fu]:n}=t,s=async o=>{const a=[],c={};for(const l of Object.keys(e.tables))c[l]=KE(l,e,a);const u=await o(c);return await n({ops:a}),u},i={};for(const[o,a]of Object.entries(e.tables))i[o]=BE(o,a.primaryKey,n);return{mutate:i,mutateBatch:s}}function BE(e,t,n){return{insert:s=>n({ops:[{op:"insert",tableName:e,primaryKey:t,value:s}]}),upsert:s=>n({ops:[{op:"upsert",tableName:e,primaryKey:t,value:s}]}),update:s=>n({ops:[{op:"update",tableName:e,primaryKey:t,value:s}]}),delete:s=>n({ops:[{op:"delete",tableName:e,primaryKey:t,value:s}]})}}function KE(e,t,n){const{primaryKey:s}=t.tables[e];return{insert:i=>{const o={op:"insert",tableName:e,primaryKey:s,value:i};return n.push(o),ie},upsert:i=>{const o={op:"upsert",tableName:e,primaryKey:s,value:i};return n.push(o),ie},update:i=>{const o={op:"update",tableName:e,primaryKey:s,value:i};return n.push(o),ie},delete:i=>{const o={op:"delete",tableName:e,primaryKey:s,value:i};return n.push(o),ie}}}function UE(e){return async function(n,s){for(const i of s.ops)switch(i.op){case"insert":await Kv(n,i,e,void 0);break;case"upsert":await Uv(n,i,e,void 0);break;case"update":await qv(n,i,e,void 0);break;case"delete":await Qv(n,i,e,void 0);break}}}function Bv(e,t){let n=t;for(const s in e.columns)n[s]===void 0&&(n={...n,[s]:null});return n}async function Kv(e,t,n,s){const i=cs(t.tableName,n.tables[t.tableName].primaryKey,t.value);if(!await e.has(i)){const o=Bv(n.tables[t.tableName],t.value);await e.set(i,o),s&&$(s.getSource(t.tableName)).push({type:"add",row:t.value})}}async function Uv(e,t,n,s){const i=cs(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=Bv(n.tables[t.tableName],t.value);await e.set(i,o),s&&$(s.getSource(t.tableName)).push({type:"add",row:t.value})}async function qv(e,t,n,s){const i=cs(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=await e.get(i);if(o===void 0)return;const a=t.value,c={...o};for(const u in a)a[u]!==void 0&&(c[u]=a[u]);await e.set(i,c),s&&$(s.getSource(t.tableName)).push({type:"edit",oldRow:o,row:c})}async function Qv(e,t,n,s){const i=cs(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=await e.get(i);o!==void 0&&(await e.del(i),s&&$(s.getSource(t.tableName)).push({type:"remove",row:o}))}var qE=class{constructor(e,t,n){v(this,"clientID");v(this,"mutationID");v(this,"reason");v(this,"location","client");v(this,"mutate");v(this,"query");$(e.reason==="initial"||e.reason==="rebase"),this.clientID=e.clientID,this.mutationID=e.mutationID,this.reason=e.reason==="initial"?"optimistic":"rebase",this.mutate=WE(t,e,this.reason==="optimistic"?void 0:n.rebase),this.query=JE(t,this.reason==="optimistic"?n.main:n.rebase)}};function QE(e,t,n){return(s,i)=>{const o=new qE(s,t,n);return e(o,i)}}function JE(e,t){const n={},s=new jv(t,()=>()=>{},i=>i());for(const i of Object.keys(e.tables))n[i]=fv(s,e,i);return n}function WE(e,t,n){const s={};for(const[i]of Object.entries(e.tables))s[i]=XE(e,i,t,n);return s}function XE(e,t,n,s){const i=$(e.tables[t]),{primaryKey:o}=i;return{insert:a=>Kv(n,{tableName:t,value:a},e,s),upsert:a=>Uv(n,{tableName:t,value:a},e,s),update:a=>qv(n,{tableName:t,value:a},e,s),delete:a=>Qv(n,{tableName:t,value:a},e,s)}}var Ai,Xn,Yn,jp,YE=(jp=class{constructor(e,t,n){h(this,Ai);h(this,Xn);h(this,Yn);d(this,Ai,e),d(this,Yn,t),d(this,Xn,n)}onClientsDeleted(e,t){var n,s;(s=(n=r(this,Xn)).debug)==null||s.call(n,"DeletedClientsManager, send:",e),r(this,Ai).call(this,["deleteClients",{clientIDs:e,clientGroupIDs:t}])}async sendDeletedClientsToServer(){var t,n;const e=await pe(r(this,Yn),s=>Gr(s));(e.clientIDs.length>0||e.clientGroupIDs.length>0)&&(r(this,Ai).call(this,["deleteClients",e]),(n=(t=r(this,Xn)).debug)==null||n.call(t,"DeletedClientsManager, send:",e))}clientsDeletedOnServer(e){const{clientIDs:t=[],clientGroupIDs:n=[]}=e;return t.length>0||n.length>0?Z(r(this,Yn),async s=>{var i,o;(o=(i=r(this,Xn)).debug)==null||o.call(i,"clientsDeletedOnServer:",t,n),await xb(s,t,n)}):ie}getDeletedClients(){return pe(r(this,Yn),Gr)}},Ai=new WeakMap,Xn=new WeakMap,Yn=new WeakMap,jp),ZE=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,e_=/^\[[a-fA-F0-9:]*:[a-fA-F0-9:]*\]$/,t_=new RegExp(`(${ZE.source}|${e_.source})`);function n_(e,t=!0){if(!t)return!1;const n=e===null?null:new URL(e),s=n==null?void 0:n.hostname;return e!==null&&s!==void 0&&s!=="localhost"&&!t_.test(s)}function s_(e){return"ws"+e.slice(4)}function Jv(e,t){return e+(e.endsWith("/")?t.substring(1):t)}var i_=new URL("https://http-intake.logs.datadoghq.com/api/v2/logs"),r_=1e3,Nf=250,o_=5*1024*1024,Rf=2,Of=o_/4,Te,Fi,Zn,$i,Vi,Gi,ga,Sa,ji,Eu,ba,Nl,zp,a_=(zp=class{constructor(e){h(this,ba);h(this,Te,[]);h(this,Fi);h(this,Zn);h(this,$i);h(this,Vi);h(this,Gi);h(this,ga);h(this,Sa);h(this,ji,0);h(this,Eu,new tc);const{apiKey:t,source:n,service:s,host:i,version:o,interval:a=5e3,baseURL:c=i_}=e;d(this,Fi,t),d(this,Zn,n),d(this,$i,s),d(this,Vi,i),d(this,Gi,o),d(this,ga,a),d(this,Sa,c.toString())}log(e,t,...n){r(this,Te).push(f_(n,t,e)),e==="error"||r(this,Te).length===Nf?this.flush():p(this,ba,Nl).call(this)}flush(){return r(this,Eu).withLock(async()=>{const{length:e}=r(this,Te);if(e!==0){do{const t=Date.now(),n=[];let s=0;for(const c of r(this,Te)){c.flushDelayMs=t-c.date;let u=JSON.stringify(c);if(u.length>Of&&(c.message=`[Dropped message of length ${u.length}]`,u=JSON.stringify(c)),u.length+s+n.length>Of||(s+=u.length,n.push(u),n.length===r_))break}const i=n.join(`
`),o=new URL(r(this,Sa));r(this,Fi)!==void 0&&o.searchParams.set("dd-api-key",r(this,Fi)),r(this,Zn)&&(o.searchParams.set("ddsource",r(this,Zn)),o.searchParams.set("dd-evp-origin",r(this,Zn))),r(this,$i)&&o.searchParams.set("service",r(this,$i)),r(this,Vi)&&o.searchParams.set("host",r(this,Vi)),r(this,Gi)&&o.searchParams.set("ddtags",`version:${r(this,Gi)}`);let a=!1;try{const c=await fetch(o.toString(),{method:"POST",body:i,keepalive:!0});a=c.ok,a||console.error("response",c.status,c.statusText,await c.text)}catch(c){console.error("Log flush to datadog failed",c)}if(a)r(this,Te).splice(0,n.length);else{let c=0;for(let u=0;u<n.length;u++){const l=r(this,Te)[u];l.flushRetryCount=(l.flushRetryCount??0)+1,l.flushRetryCount>Rf&&c++}c>0&&(console.error(`Dropping ${c} datadog log messages which failed to send ${Rf+1} times.`),r(this,Te).splice(0,c))}}while(r(this,Te).length>=Nf);r(this,Te).length&&p(this,ba,Nl).call(this)}})}},Te=new WeakMap,Fi=new WeakMap,Zn=new WeakMap,$i=new WeakMap,Vi=new WeakMap,Gi=new WeakMap,ga=new WeakMap,Sa=new WeakMap,ji=new WeakMap,Eu=new WeakMap,ba=new WeakSet,Nl=function(){r(this,ji)||d(this,ji,setTimeout(()=>{d(this,ji,0),this.flush()},r(this,ga)))},zp);function Wv(e){return Array.isArray(e)&&e.length===1?Wv(e[0]):e}function Tf(e){return{name:e.name,message:e.message,stack:e.stack}}function c_(e){if(e instanceof Error)return Tf(e);if(e instanceof Array){const t=[];for(const n of e)n instanceof Error?t.push(Tf(n)):t.push(n);return t}return e}var u_="flushRetryCount",h_="flushDelayMs",l_="@DATADOG_RESERVED_",d_=["host","source","status","service","version","trace_id","message","msg","date",h_,u_];function f_(e,t,n){let s;if(t!==void 0)for(const o of d_)Object.hasOwn(t,o)&&(s===void 0&&(s={...t}),s[l_+o]=s[o],delete s[o]);const i={...s??t,date:Date.now(),message:c_(Wv(e)),status:n};return n==="error"&&(i.error={origin:"logger"}),i}var Xv="0.16.2025022800",ka,zi,Bp,Pf=(Bp=class{constructor(e,t){h(this,ka);h(this,zi);d(this,ka,e),d(this,zi,t)}log(e,t,...n){r(this,zi)==="error"&&e!=="error"||r(this,zi)==="info"&&e==="debug"||r(this,ka).log(e,t,...n)}async flush(){var e;await((e=cn.flush)==null?void 0:e.call(cn))}},ka=new WeakMap,zi=new WeakMap,Bp),p_="info",Hf=".reflect-server.net";function m_(e,t=n=>new a_(n)){const{consoleLogLevel:n,server:s,enableAnalytics:i}=e;if(!i||s===null)return{logLevel:n,logSink:cn};const o=new URL(s),{hostname:a}=o,c=a.endsWith(Hf)?a.substring(0,a.length-Hf.length).toLowerCase():a,u=new URL(Jv(s,"/logs/v0/log")),l=n==="debug"?"debug":"info",m=new Cm([new Pf(cn,n),new Pf(t({service:c,host:location.host,version:Xv,baseURL:u}),p_)]);return{logLevel:l,logSink:m}}var y_="time_to_connect_ms",w_="last_connect_error",v_="time_to_connect_ms_v2",g_="last_connect_error_v2",S_="total_time_to_connect_ms",b_="not_connected",Yv=100*1e3,k_=5e3;function Zv(e){return"server"in e?`server_${Lf(e.server)}`:`client_${Lf(e.client)}`}function Lf(e){return e.split(/\.?(?=[A-Z])/).join("_").toLowerCase()}var Ia,Ca,Da,Bi,Wt,Ea,Ki,Ui,qi,Qi,De,Kc,Sn,Kp,I_=(Kp=class{constructor(e){h(this,De);h(this,Ia);h(this,Ca);h(this,Da);h(this,Bi);h(this,Wt);h(this,Ea,[]);v(this,"timeToConnectMs",p(this,De,Sn).call(this,new Uc(y_)));v(this,"lastConnectError",p(this,De,Sn).call(this,new ph(w_,!0)));h(this,Ki,p(this,De,Sn).call(this,new ph(b_)));h(this,Ui,p(this,De,Sn).call(this,new Uc(v_)));h(this,qi,p(this,De,Sn).call(this,new ph(g_)));h(this,Qi,p(this,De,Sn).call(this,new Uc(S_)));v(this,"tags",[]);d(this,Ia,e.reportIntervalMs),d(this,Ca,e.host),d(this,Da,e.reporter),d(this,Bi,e.lc),this.tags.push(`source:${e.source}`),this.timeToConnectMs.set(Yv),p(this,De,Kc).call(this,"init"),d(this,Wt,setInterval(()=>{this.flush()},r(this,Ia)))}setConnected(e,t){r(this,Ki).clear(),r(this,qi).clear(),r(this,Ui).set(e),r(this,Qi).set(t)}setDisconnectedWaitingForVisible(){r(this,Ui).clear(),r(this,Qi).clear(),r(this,qi).clear();let e;switch(r(this,Ki).get()){case"init":e="hidden_was_init";break;case"error":e="hidden_was_error";break;default:e="hidden";break}p(this,De,Kc).call(this,e)}setConnectError(e){r(this,Ui).clear(),r(this,Qi).clear(),p(this,De,Kc).call(this,"error"),r(this,qi).set(Zv(e))}async flush(){var n,s,i;const e=r(this,Bi);if(r(this,Wt)===null){(n=e.error)==null||n.call(e,"MetricManager.flush() called but already stopped");return}const t=[];for(const o of r(this,Ea)){const a=o.flush();a!==void 0&&t.push({...a,host:r(this,Ca),tags:this.tags})}if(t.length===0){(s=e==null?void 0:e.debug)==null||s.call(e,"No metrics to report");return}try{await r(this,Da).call(this,t)}catch(o){(i=e==null?void 0:e.error)==null||i.call(e,`Error reporting metrics: ${o}`)}}stop(){var e,t;if(r(this,Wt)===null){(t=(e=r(this,Bi)).error)==null||t.call(e,"MetricManager.stop() called but already stopped");return}clearInterval(r(this,Wt)),d(this,Wt,null)}},Ia=new WeakMap,Ca=new WeakMap,Da=new WeakMap,Bi=new WeakMap,Wt=new WeakMap,Ea=new WeakMap,Ki=new WeakMap,Ui=new WeakMap,qi=new WeakMap,Qi=new WeakMap,De=new WeakSet,Kc=function(e){r(this,Ki).set(e)},Sn=function(e){return r(this,Ea).push(e),e},Kp);function C_(e,t){return[e,[t]]}var _a,Xt,Up,Uc=(Up=class{constructor(e){h(this,_a);h(this,Xt);d(this,_a,e)}set(e){d(this,Xt,e)}get(){return r(this,Xt)}clear(){d(this,Xt,void 0)}flush(){if(r(this,Xt)===void 0)return;const e=[C_(D_(),r(this,Xt))];return{metric:r(this,_a),points:e}}},_a=new WeakMap,Xt=new WeakMap,Up);function D_(){return Math.round(Date.now()/1e3)}var xa,Ma,Yt,qp,ph=(qp=class{constructor(e,t=!1){h(this,xa);h(this,Ma);h(this,Yt);d(this,xa,e),d(this,Ma,t)}set(e){d(this,Yt,e)}get(){return r(this,Yt)}clear(){d(this,Yt,void 0)}flush(){if(r(this,Yt)===void 0)return;const e=new Uc([r(this,xa),r(this,Yt)].join("_"));e.set(1);const t=e.flush();return r(this,Ma)&&this.clear(),t}},xa=new WeakMap,Ma=new WeakMap,Yt=new WeakMap,qp),Af=0,E_=1,Na,Ra,es,st,Oa,Zt,Ji,ms,Rl,eg,Qp,__=(Qp=class{constructor(e,t,n,s,i){h(this,ms);h(this,Na);h(this,Ra);h(this,es);h(this,st,new Map);h(this,Oa);h(this,Zt,new Set);h(this,Ji,new Set);d(this,Na,e),d(this,Ra,yd(t)),d(this,Oa,i),d(this,es,n),s(o=>{for(const a of o){const c=a.key.substring(xl.length);switch(a.op){case"add":r(this,Ji).add(c),p(this,ms,Rl).call(this,c,!0);break;case"del":r(this,Ji).delete(c),p(this,ms,Rl).call(this,c,!1);break}}},{prefix:xl,initialValuesInFirstDiff:!0})}async getQueriesPatch(e,t){const n=new Set,s=VE(r(this,Na));for await(const o of e.scan({prefix:s}).keys())n.add(o.substring(s.length,o.length));const i=new Map;for(const o of n)r(this,st).has(o)||i.set(o,{op:"del",hash:o});for(const[o,{normalized:a,ttl:c}]of r(this,st))n.has(o)||i.set(o,{op:"put",hash:o,ast:a,ttl:c});if(t){for(const[o,{op:a}]of t)a==="put"&&!i.has(o)&&i.set(o,{op:"del",hash:o});for(const[o,{op:a}]of i){const c=t.get(o);c&&c.op===a&&i.delete(o)}}return i}add(e,t,n){const s=Gw(e),i=Uw(s);let o=r(this,st).get(i);if(r(this,Zt).delete(i),o)++o.count,t!==void 0&&(o.ttl===void 0||t>o.ttl)&&(o.ttl=t,r(this,es).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"put",hash:i,ast:o.normalized,ttl:t}]}])),n&&o.gotCallbacks.push(n);else{const c=jw(s,r(this,Ra));o={normalized:c,count:1,gotCallbacks:n===void 0?[]:[n],ttl:t},r(this,st).set(i,o),r(this,es).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"put",hash:i,ast:c,ttl:t}]}])}n&&n(r(this,Ji).has(i));let a=!1;return()=>{a||(a=!0,p(this,ms,eg).call(this,i,n))}}},Na=new WeakMap,Ra=new WeakMap,es=new WeakMap,st=new WeakMap,Oa=new WeakMap,Zt=new WeakMap,Ji=new WeakMap,ms=new WeakSet,Rl=function(e,t){var s;const n=((s=r(this,st).get(e))==null?void 0:s.gotCallbacks)??[];for(const i of n)i(t)},eg=function(e,t){const n=$(r(this,st).get(e));if(t){const s=n.gotCallbacks.indexOf(t);n.gotCallbacks.splice(s,1)}if(--n.count,n.count===0&&(r(this,Zt).add(e),r(this,Zt).size>r(this,Oa))){const s=r(this,Zt).values().next().value;g(s),r(this,st).delete(s),r(this,Zt).delete(s),r(this,es).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"del",hash:s}]}])}},Qp),Ol="_zeroReloadReason",vd="_zeroReloadBackoffState",x_=f.object({lastReloadTime:f.number().default(0),nextIntervalMs:f.number().default(0)}),vc=500,Ff=6e4,$f=1e4,qc=null;function mh(e,t,n){var a,c;if(qc){(a=e.warn)==null||a.call(e,"reload timer already scheduled");return}const s=Date.now(),i=O_(e,s);typeof sessionStorage<"u"&&(sessionStorage.setItem(vd,JSON.stringify(i)),sessionStorage.setItem(Ol,n));const o=i.lastReloadTime-s;(c=e.error)==null||c.call(e,n,`
`,"reloading",o>0?`in ${o/1e3} seconds`:""),qc=setTimeout(()=>{qc=null,t()},o)}function M_(e){var t;if(typeof sessionStorage<"u"){const n=sessionStorage.getItem(Ol);n&&(sessionStorage.removeItem(Ol),(t=e.error)==null||t.call(e,"Zero reloaded the page.",n))}}function N_(){return qc!==null}function R_(){typeof sessionStorage<"u"&&sessionStorage.removeItem(vd)}function O_(e,t){var c,u;if(typeof sessionStorage>"u")return(c=e.warn)==null||c.call(e,`sessionStorage not supported. backing off in ${$f/1e3} seconds`),{lastReloadTime:t+$f,nextIntervalMs:vc};const n=sessionStorage.getItem(vd);if(!n)return{lastReloadTime:t,nextIntervalMs:vc};let s;try{s=Et(JSON.parse(n),x_,"passthrough")}catch(l){return(u=e.warn)==null||u.call(e,"ignoring unparsable backoff state",n,l),{lastReloadTime:t,nextIntervalMs:vc}}const{lastReloadTime:i,nextIntervalMs:o}=s;return t-i>Ff*2?{lastReloadTime:t,nextIntervalMs:vc}:t<i?s:{lastReloadTime:Math.max(t,i+o),nextIntervalMs:Math.min(o*2,Ff)}}var tg=class extends Error{constructor(t){super(t.kind+": "+t.message);v(this,"name","ServerError");v(this,"errorBody");this.errorBody=t}get kind(){return this.errorBody.kind}};function gd(e){return e instanceof tg}function T_(e){return gd(e)&&P_(e.kind)}function P_(e){return e===Sv||e===_v}function H_(e){if(gd(e))switch(e.errorBody.kind){case Dv:case Ev:case Nv:return e.errorBody}}function L_(e,t){const n="http",s=(c="")=>` For example: "${n}s://myapp-myteam.zero.ms/${c}".`;if(!t.startsWith(`${n}://`)&&!t.startsWith(`${n}s://`))throw new Error(`ZeroOptions.${e} must use the "${n}" or "${n}s" scheme.`);let i;try{i=new URL(t)}catch{throw new Error(`ZeroOptions.${e} must be a valid URL.${s()}`)}const o=i.toString(),a=i.pathname.split("/");if(a[0]===""&&a.shift(),a[a.length-1]===""&&a.pop(),a.length>1)throw new Error(`ZeroOptions.${e} may have at most one path component.${s("zero")}`);for(const[c,u]of[["search","?"],["hash","#"]])if(i[c]||o.endsWith(u))throw new Error(`ZeroOptions.${e} must not contain a ${c} component.${s()}`);return o}function A_(e){return Dt("WebSocket")?e==null?(console.warn("Zero starting up with no server URL. This is supported for unit testing and prototyping, but no data will be synced."),null):L_("server",e):(console.warn("Zero started in an unsupported environment, no data will be synced."),null)}var Ta,Pa,Ha,bt,de,kt,Wi,La,_u,Aa,Fa,$a,be,ng,Va,sg,Rr,Tl,Jp,F_=(Jp=class{constructor(e,t,n,s,i){h(this,be);h(this,Ta);h(this,Pa);h(this,Ha);h(this,bt);h(this,de);h(this,kt,[]);h(this,Wi,!1);h(this,La,0);h(this,_u,new tc);h(this,Aa);h(this,Fa);h(this,$a,nb("requestAnimationFrame")??G_);h(this,Va,async()=>{var n,s,i;const e=r(this,bt).withContext("rafAt",Math.floor(performance.now()));if(r(this,kt).length===0){(n=e.debug)==null||n.call(e,"stopping playback loop"),d(this,Wi,!1);return}r(this,$a).call(this,r(this,Va));const t=performance.now();(s=e.debug)==null||s.call(e,"raf fired, processing pokes.  Since last raf",t-r(this,La)),d(this,La,t),await p(this,be,sg).call(this,e),(i=e.debug)==null||i.call(e,"processing pokes took",performance.now()-t)});d(this,Ta,e),d(this,Pa,t),d(this,Ha,n),d(this,Aa,s),d(this,Fa,iD(s.tables)),d(this,bt,i.withContext("PokeHandler"))}handlePokeStart(e){if(r(this,de)){p(this,be,Rr).call(this,`pokeStart ${JSON.stringify(e)} while still receiving  ${JSON.stringify(r(this,de).pokeStart)} `);return}d(this,de,{pokeStart:e,parts:[]})}handlePokePart(e){var t,n,s;if(e.pokeID!==((t=r(this,de))==null?void 0:t.pokeStart.pokeID)){p(this,be,Rr).call(this,`pokePart for ${e.pokeID}, when receiving ${(n=r(this,de))==null?void 0:n.pokeStart.pokeID}`);return}return r(this,de).parts.push(e),(s=e.lastMutationIDChanges)==null?void 0:s[r(this,Ha)]}handlePokeEnd(e){var t,n;if(e.pokeID!==((t=r(this,de))==null?void 0:t.pokeStart.pokeID)){p(this,be,Rr).call(this,`pokeEnd for ${e.pokeID}, when receiving ${(n=r(this,de))==null?void 0:n.pokeStart.pokeID}`);return}if(e.cancel){d(this,de,void 0);return}r(this,kt).push({...r(this,de),pokeEnd:e}),d(this,de,void 0),r(this,Wi)||p(this,be,ng).call(this)}handleDisconnect(){var e,t;(t=(e=r(this,bt)).debug)==null||t.call(e,"clearing due to disconnect"),p(this,be,Tl).call(this)}},Ta=new WeakMap,Pa=new WeakMap,Ha=new WeakMap,bt=new WeakMap,de=new WeakMap,kt=new WeakMap,Wi=new WeakMap,La=new WeakMap,_u=new WeakMap,Aa=new WeakMap,Fa=new WeakMap,$a=new WeakMap,be=new WeakSet,ng=function(){var e,t;(t=(e=r(this,bt)).debug)==null||t.call(e,"starting playback loop"),d(this,Wi,!0),r(this,$a).call(this,r(this,Va))},Va=new WeakMap,sg=function(e){return r(this,_u).withLock(async()=>{var n,s,i,o,a;const t=Date.now();(n=e.debug)==null||n.call(e,"got poke lock at",t),(s=e.debug)==null||s.call(e,"merging",r(this,kt).length);try{const c=$_(r(this,kt),r(this,Aa),r(this,Fa));if(r(this,kt).length=0,c===void 0){(i=e.debug)==null||i.call(e,"frame is empty");return}const u=performance.now();(o=e.debug)==null||o.call(e,"poking replicache"),await r(this,Ta).call(this,c),(a=e.debug)==null||a.call(e,"poking replicache took",performance.now()-u)}catch(c){p(this,be,Rr).call(this,c)}})},Rr=function(e){var t,n,s,i;String(e).includes("unexpected base cookie for poke")?(n=(t=r(this,bt)).debug)==null||n.call(t,"clearing due to",e):(i=(s=r(this,bt)).error)==null||i.call(s,"clearing due to unexpected poke error",e),p(this,be,Tl).call(this),r(this,Pa).call(this)},Tl=function(){d(this,de,void 0),r(this,kt).length=0},Jp);function $_(e,t,n){if(e.length===0)return;const{baseCookie:s}=e[0].pokeStart,i=e[e.length-1],{cookie:o}=i.pokeEnd,a=[],c={};let u;for(const l of e){if(u&&l.pokeStart.baseCookie&&l.pokeStart.baseCookie>u.cookie)throw Error(`unexpected cookie gap ${JSON.stringify(u)} ${JSON.stringify(l.pokeStart)}`);u=l.pokeEnd;for(const m of l.parts){if(m.lastMutationIDChanges)for(const[y,w]of Object.entries(m.lastMutationIDChanges))c[y]=w;if(m.desiredQueriesPatches)for(const[y,w]of Object.entries(m.desiredQueriesPatches))a.push(...w.map(b=>Vf(b,C=>$E(y,C),n)));m.gotQueriesPatch&&a.push(...m.gotQueriesPatch.map(y=>Vf(y,GE,n))),m.rowsPatch&&a.push(...m.rowsPatch.map(y=>V_(y,t,n)))}}return{baseCookie:s,pullResponse:{lastMutationIDChanges:c,patch:a,cookie:o}}}function Vf(e,t,n){switch(e.op){case"clear":return e;case"del":return{op:"del",key:t(e.hash)};case"put":default:return{op:"put",key:t(e.hash),value:jw(e.ast,n)}}}function V_(e,t,n){if(e.op==="clear")return e;const s=n.tableName(e.tableName,e);switch(e.op){case"del":return{op:"del",key:cs(s,t.tables[s].primaryKey,n.row(e.tableName,e.id))};case"put":return{op:"put",key:cs(s,t.tables[s].primaryKey,n.row(e.tableName,e.value)),value:n.row(e.tableName,e.value)};case"update":return{op:"update",key:cs(s,t.tables[s].primaryKey,n.row(e.tableName,e.id)),merge:e.merge?n.row(e.tableName,e.merge):void 0,constrain:n.columns(e.tableName,e.constrain)};default:throw new Error("to be implemented")}}function G_(e){setTimeout(e,0)}var Gf=5e3,j_=5e3,z_=5e3,B_=5e3,K_=5e3,U_=1e4,q_=6,gc={clientID:"",id:-1};function Q_(e){return{type:e.type}}function J_(e,t){const{type:n}=e;let s="";switch(n){case"NewClientGroup":s="This client could not sync with a newer client. This is probably due to another tab loading a newer incompatible version of the app's code.";break;case"VersionNotSupported":s="The server no longer supports this client's protocol version.";break;case"SchemaVersionNotSupported":s="The server no longer supports this client's schema version.";break;default:me()}return t&&(s+=" "+t),s}function W_(e){return`Server reported that client is ahead of server (${e}). This probably happened because the server is in development mode and restarted. Currently when this happens, the dev server loses its state and on reconnect sees the client as ahead. If you see this in other cases, it may be a bug in Zero.`}function X_(e){return`Server could not find state needed to synchronize this client. ${e}`}var Y_="The local persistent state needed to synchronize this client has been garbage collected.",B,en,U,Ga,Xi,tn,ts,ns,ja,ss,nn,it,It,za,Yi,Ba,Zi,Ka,er,tr,nr,sn,rt,rn,sr,Ke,ir,rr,K,Ua,or,ot,is,rs,X,M,Qc,ge,at,on,Ce,ar,ig,Pl,rg,qa,Qa,Ja,og,ag,cg,Ot,ug,hg,lg,dg,fg,pg,Hl,mg,yg,Jc,wg,vg,Wc,gg,Sg,Wp,Z_=(Wp=class{constructor(e){h(this,M);v(this,"version",Xv);h(this,B);h(this,en);v(this,"userID");v(this,"storageKey");h(this,U);h(this,Ga);h(this,Xi);h(this,tn);h(this,ts);h(this,ns);h(this,ja);h(this,ss);h(this,nn);h(this,it);h(this,It,gc);h(this,za,()=>{});h(this,Yi,!1);h(this,Ba);h(this,Zi);h(this,Ka);h(this,er,null);h(this,tr,0);h(this,nr,0);h(this,sn,0);h(this,rt,0);h(this,rn,()=>{});h(this,sr);h(this,Ke,A());h(this,ir,new Map);h(this,rr,0);h(this,K);h(this,Ua,A());h(this,or,A());h(this,ot);h(this,is,new AbortController);h(this,rs);h(this,X,Rt);h(this,ge);h(this,at);h(this,on);v(this,"query");h(this,Ce);h(this,ar,()=>{var e;return(e=Dt("location"))==null?void 0:e.reload()});v(this,"mutate");v(this,"mutateBatch");h(this,qa,e=>{var a,c;const t=r(this,U);if((a=t.debug)==null||a.call(t,"received message",e.data),this.closed){(c=t.debug)==null||c.call(t,"ignoring message because already closed");return}const n=u=>{var l;return(l=r(this,ot))==null?void 0:l.reject(new Error(`Invalid message received from server: ${u instanceof Error?u.message+". ":""}${i}`))};let s;const{data:i}=e;try{s=Et(JSON.parse(i),XD)}catch(u){n(u);return}switch(yn(this,nr)._++,s[0]){case"connected":return p(this,M,ag).call(this,t,s);case"error":return p(this,M,og).call(this,t,s);case"pong":return r(this,za).call(this);case"pokeStart":return p(this,M,ug).call(this,t,s);case"pokePart":return p(this,M,hg).call(this,t,s);case"pokeEnd":return p(this,M,lg).call(this,t,s);case"pull":return p(this,M,fg).call(this,t,s);case"warm":break;case"deleteClients":return r(this,ss).clientsDeletedOnServer(s[1]);default:n()}});h(this,Qa,()=>{var t,n;const e=yh(r(this,K),r(this,U));if(r(this,ge)===void 0)(t=e.error)==null||t.call(e,"Got open event but connect start time is undefined. This should not happen.");else{const i=Date.now()-r(this,ge);(n=e.info)==null||n.call(e,"Got socket open event",{navigatorOnline:ae==null?void 0:ae.onLine,timeToOpenMs:i})}});h(this,Ja,e=>{var c;const t=yh(r(this,K),r(this,U)),{code:n,reason:s,wasClean:i}=e,o=n<=1001?"info":"error";(c=t[o])==null||c.call(t,"Got socket close event",{code:n,reason:s,wasClean:i});const a=i?"CleanClose":"AbruptClose";r(this,Ke).reject(new zf(a)),p(this,M,Ot).call(this,t,{client:a})});var T;const{userID:t,storageKey:n,onOnlineChange:s,onUpdateNeeded:i,onClientStateNotFound:o,hiddenTabDisconnectDelay:a=K_,kvStore:c="idb",schema:u,batchViewUpdates:l=E=>E(),maxRecentQueries:m=0}=e;if(!t)throw new Error("ZeroOptions.userID must not be empty.");const y=A_(e.server);if(d(this,Xi,n_(y,!1)),a<0)throw new Error("ZeroOptions.hiddenTabDisconnectDelay must not be negative.");d(this,Ba,s),d(this,on,e),d(this,Ga,p(this,M,rg).call(this,{consoleLogLevel:e.logLevel??"error",server:null,enableAnalytics:r(this,Xi)}));const w=r(this,Ga),b={[fu]:UE(u)};d(this,ns,new jE(u.tables));for(const[E,O]of Object.entries(e.mutators??{}))for(const[H,P]of Object.entries(O))b[Ef(E,H)]=QE(P,u,r(this,ns));this.storageKey=n??"";const C={schemaVersion:`${u.version}.${qu}`,logLevel:w.logLevel,logSinks:[w.logSink],mutators:b,name:`zero-${t}-${this.storageKey}`,pusher:(E,O)=>p(this,M,pg).call(this,E,O),puller:(E,O)=>p(this,M,yg).call(this,E,O),pushDelay:0,requestOptions:{maxDelayMs:0,minDelayMs:0},licenseKey:"zero-client-static-key",kvStore:c},k={enableClientGroupForking:!1,enableMutationRecovery:!1,onClientsDeleted:(E,O)=>r(this,ss).onClientsDeleted(E,O)},S=new _I(C,k);d(this,B,S),d(this,en,y),this.userID=t,d(this,U,new Tu(w.logLevel,{clientID:S.clientID},w.logSink));const I=i??((E,O)=>{mh(r(this,U),r(this,ar),J_(E,O))});d(this,Zi,I),r(this,B).onUpdateNeeded=E=>{I(Q_(E))};const D=o??(E=>{mh(r(this,U),r(this,ar),E??Y_)});d(this,Ka,D),r(this,B).onClientStateNotFound=D;const{mutate:N,mutateBatch:x}=zE(u,S.mutate);for(const[E,O]of Object.entries(e.mutators??{})){let H=N[E];H===void 0&&(H={},N[E]=H);for(const P of Object.keys(O))H[P]=$(S.mutate[Ef(E,P)])}this.mutate=N,this.mutateBatch=x,d(this,ts,new __(S.clientID,u.tables,E=>p(this,M,ig).call(this,E),S.experimentalWatch.bind(S),m)),d(this,ja,yd(u.tables)),d(this,ss,new YE(E=>p(this,M,Pl).call(this,E),S.perdag,r(this,U))),d(this,sr,new jv(r(this,ns).main,(E,O,H)=>r(this,ts).add(E,O,H),l)),S.experimentalWatch(E=>r(this,sr).processChanges(E),{prefix:_t,initialValuesInFirstDiff:!0}),this.query=p(this,M,Sg).call(this,u),M_(r(this,U)),d(this,Ce,new I_({reportIntervalMs:k_,host:((T=Dt("location"))==null?void 0:T.host)??"",source:"client",reporter:r(this,Xi)?E=>p(this,M,vg).call(this,E):()=>Promise.resolve(),lc:r(this,U)})),r(this,Ce).tags.push(`version:${this.version}`),d(this,tn,new F_(E=>r(this,B).poke(E,r(this,ns).advanceSyncHead),()=>p(this,M,dg).call(this),S.clientID,u,r(this,U))),d(this,rs,sy(Dt("document"),a,r(this,is).signal)),p(this,M,mg).call(this)}get server(){return r(this,en)}get idbName(){return r(this,B).idbName}get schemaVersion(){return r(this,B).schemaVersion}get clientID(){return r(this,B).clientID}get clientGroupID(){return r(this,B).clientGroupID}get closed(){return r(this,B).closed}close(){var t;const e=r(this,U).withContext("close");return r(this,X)!==Rt&&p(this,M,Ot).call(this,e,{client:"ClientClosed"}),(t=e.debug)==null||t.call(e,"Aborting closeAbortController due to close()"),r(this,is).abort(),r(this,Ce).stop(),r(this,B).close()}get online(){return r(this,Yi)}},B=new WeakMap,en=new WeakMap,U=new WeakMap,Ga=new WeakMap,Xi=new WeakMap,tn=new WeakMap,ts=new WeakMap,ns=new WeakMap,ja=new WeakMap,ss=new WeakMap,nn=new WeakMap,it=new WeakMap,It=new WeakMap,za=new WeakMap,Yi=new WeakMap,Ba=new WeakMap,Zi=new WeakMap,Ka=new WeakMap,er=new WeakMap,tr=new WeakMap,nr=new WeakMap,sn=new WeakMap,rt=new WeakMap,rn=new WeakMap,sr=new WeakMap,Ke=new WeakMap,ir=new WeakMap,rr=new WeakMap,K=new WeakMap,Ua=new WeakMap,or=new WeakMap,ot=new WeakMap,is=new WeakMap,rs=new WeakMap,X=new WeakMap,M=new WeakSet,Qc=function(e){e!==r(this,X)&&(d(this,X,e),r(this,or).resolve(e),d(this,or,A()))},ge=new WeakMap,at=new WeakMap,on=new WeakMap,Ce=new WeakMap,ar=new WeakMap,ig=function(e){p(this,M,Pl).call(this,e)},Pl=function(e){r(this,K)&&r(this,X)===kr&&wn(r(this,K),e)},rg=function(e){return m_(e)},qa=new WeakMap,Qa=new WeakMap,Ja=new WeakMap,og=async function(e,t){var o,a,c,u,l,m,y;const[,{kind:n,message:s}]=t;if(n===Cv){d(this,It,gc),(o=e.error)==null||o.call(e,"Mutation rate limited",{message:s});return}(a=e.info)==null||a.call(e,`${n}: ${s}}`);const i=new tg(t[1]);(c=r(this,ot))==null||c.reject(i),(u=e.debug)==null||u.call(e,"Rejecting connect resolver due to error",i),r(this,Ke).reject(i),p(this,M,Ot).call(this,e,{server:n}),n===xv?(l=r(this,Zi))==null||l.call(this,{type:n},s):n===Mv?(await r(this,B).disableClientGroup(),(m=r(this,Zi))==null||m.call(this,{type:"SchemaVersionNotSupported"},s)):n===bv?(await r(this,B).disableClientGroup(),(y=r(this,Ka))==null||y.call(this,X_(s))):(n===Iv||n===kv)&&(await VI(r(this,B).idbName),mh(e,r(this,ar),W_(n)))},ag=async function(e,t){var w,b,C,k;const n=Date.now(),[,s]=t;e=Al(s.wsid,e),r(this,tr)===0?p(this,M,Wc).call(this,"firstConnect"):r(this,rt)>0&&p(this,M,Wc).call(this,"connectAfterError"),yn(this,tr)._++,d(this,sn,n),r(this,Ce).lastConnectError.clear();const i=r(this,rt);d(this,rt,0);let o,a;r(this,ge)===void 0?(w=e.error)==null||w.call(e,"Got connected message but connect start time is undefined. This should not happen."):(o=n-r(this,ge),r(this,Ce).timeToConnectMs.set(o),a=s.timestamp!==void 0?n-s.timestamp:void 0,d(this,ge,void 0));let c;r(this,at)===void 0?(b=e.error)==null||b.call(e,"Got connected message but total to connect start time is undefined. This should not happen."):(c=n-r(this,at),d(this,at,void 0)),r(this,Ce).setConnected(o??0,c??0),(C=e.info)==null||C.call(e,"Connected",{navigatorOnline:ae==null?void 0:ae.onLine,timeToConnectMs:o,totalTimeToConnectMs:c,connectMsgLatencyMs:a,connectedCount:r(this,tr),proceedingConnectErrorCount:i}),d(this,It,gc),(k=e.debug)==null||k.call(e,"Resolving connect resolver");const u=$(r(this,K)),l=await r(this,B).query(S=>r(this,ts).getQueriesPatch(S,r(this,nn))),m=()=>{var S,I;return wu((S=r(this,it))==null?void 0:S.clientIDs)||wu((I=r(this,it))==null?void 0:I.clientGroupIDs)},y=()=>{m()&&(wn(u,["deleteClients",r(this,it)]),d(this,it,void 0))};l.size>0&&r(this,nn)!==void 0?(y(),wn(u,["changeDesiredQueries",{desiredQueriesPatch:[...l.values()]}])):r(this,nn)===void 0&&(wn(u,["initConnection",{desiredQueriesPatch:[...l.values()],deleted:Ll(r(this,it))}]),d(this,it,void 0)),d(this,nn,void 0),y(),p(this,M,Qc).call(this,kr),r(this,Ke).resolve()},cg=async function(e,t){var l,m;g(r(this,en)),g(r(this,X)===Rt);const n=Tv();e=Al(n,e),(l=e.info)==null||l.call(e,"Connecting...",{navigatorOnline:ae==null?void 0:ae.onLine}),p(this,M,Qc).call(this,wc),g(r(this,ge)===void 0);const s=Date.now();if(d(this,ge,s),r(this,at)===void 0&&d(this,at,s),this.closed||(d(this,er,Et(await r(this,B).cookie,du)),this.closed))return;const i=setTimeout(()=>{var y;(y=e.debug)==null||y.call(e,"Rejecting connect resolver due to timeout"),r(this,Ke).reject(new jf("Connect")),p(this,M,Ot).call(this,e,{client:"ConnectTimeout"})},U_),o=()=>{clearTimeout(i)};r(this,is).signal.addEventListener("abort",o);const[a,c,u]=await ex(r(this,B),r(this,ts),r(this,ss),s_(r(this,en)),r(this,er),this.clientID,await this.clientGroupID,r(this,on).schema.version,this.userID,r(this,B).auth,r(this,rr),n,r(this,on).logLevel==="debug",e,r(this,on).maxHeaderLength,t);if(!this.closed){d(this,nn,c),d(this,it,u),a.addEventListener("message",r(this,qa)),a.addEventListener("open",r(this,Qa)),a.addEventListener("close",r(this,Ja)),d(this,K,a),r(this,Ua).resolve(a);try{(m=e.debug)==null||m.call(e,"Waiting for connection to be acknowledged"),await r(this,Ke).promise}finally{clearTimeout(i),r(this,is).signal.removeEventListener("abort",o)}}},Ot=function(e,t){var n,s,i,o,a,c,u,l,m;switch(r(this,X)===wc&&yn(this,rt)._++,(n=e.info)==null||n.call(e,"disconnecting",{navigatorOnline:ae==null?void 0:ae.onLine,reason:t,connectStart:r(this,ge),totalToConnectStart:r(this,at),connectedAt:r(this,sn),connectionDuration:r(this,sn)?Date.now()-r(this,sn):0,messageCount:r(this,nr),connectionState:r(this,X),connectErrorCount:r(this,rt)}),r(this,X)){case kr:{r(this,ge)!==void 0&&((s=e.error)==null||s.call(e,"disconnect() called while connected but connect start time is defined. This should not happen."));break}case wc:{r(this,Ce).lastConnectError.set(Zv(t)),r(this,Ce).timeToConnectMs.set(Yv),r(this,Ce).setConnectError(t),r(this,rt)%q_===1&&p(this,M,Wc).call(this,`connectErrorCount=${r(this,rt)}`),r(this,ge)===void 0&&((i=e.error)==null||i.call(e,"disconnect() called while connecting but connect start time is undefined. This should not happen."));break}case Rt:(o=e.error)==null||o.call(e,"disconnect() called while disconnected");break}d(this,Ua,A()),(a=e.debug)==null||a.call(e,"Creating new connect resolver"),d(this,Ke,A()),p(this,M,Qc).call(this,Rt),d(this,nr,0),d(this,ge,void 0),d(this,sn,0),(c=r(this,K))==null||c.removeEventListener("message",r(this,qa)),(u=r(this,K))==null||u.removeEventListener("open",r(this,Qa)),(l=r(this,K))==null||l.removeEventListener("close",r(this,Ja)),(m=r(this,K))==null||m.close(),d(this,K,void 0),d(this,It,gc),r(this,tn).handleDisconnect()},ug=function(e,t){R_(),r(this,rn).call(this),r(this,tn).handlePokeStart(t[1])},hg=function(e,t){r(this,rn).call(this);const n=r(this,tn).handlePokePart(t[1]);n!==void 0&&d(this,rr,n)},lg=function(e,t){r(this,rn).call(this),r(this,tn).handlePokeEnd(t[1])},dg=function(){var t;const e=r(this,U);(t=e.info)==null||t.call(e,"poke error, disconnecting?",r(this,X)!==Rt),r(this,X)!==Rt&&p(this,M,Ot).call(this,e,{client:"UnexpectedBaseCookie"})},fg=function(e,t){var i,o;r(this,rn).call(this);const n=t[1];e=e.withContext("requestID",n.requestID),(i=e.debug)==null||i.call(e,"Handling pull response",n);const s=r(this,ir).get(n.requestID);if(!s){(o=e.debug)==null||o.call(e,"No resolver found");return}s.resolve(t[1])},pg=async function(e,t){var c,u;g(e.pushVersion===1),await r(this,Ke).promise;const n=r(this,U).withContext("requestID",t);(c=n.debug)==null||c.call(n,`pushing ${e.mutations.length} mutations`);const s=r(this,K);g(s);const i=e.clientGroupID!==await this.clientGroupID,o=i?0:e.mutations.findIndex(l=>l.clientID===r(this,It).clientID&&l.id===r(this,It).id)+1;(u=n.debug)==null||u.call(n,i?"pushing for recovery":"pushing",e.mutations.length-o,"mutations of",e.mutations.length,"mutations.");const a=Date.now();for(let l=o;l<e.mutations.length;l++){const m=e.mutations[l],y=a-Math.round(performance.now()-m.timestamp),w=m.name===fu?{type:Rv,timestamp:y,id:m.id,clientID:m.clientID,name:m.name,args:[kE(m.args,r(this,ja))]}:{type:Ov,timestamp:y,id:m.id,clientID:m.clientID,name:m.name,args:[m.args]},b=["push",{timestamp:a,clientGroupID:e.clientGroupID,mutations:[w],pushVersion:e.pushVersion,schemaVersion:parseInt(e.schemaVersion),requestID:t}];wn(s,b),i||d(this,It,{clientID:m.clientID,id:m.id})}return{httpRequestInfo:{errorMessage:"",httpStatusCode:200}}},Hl=async function(e,t){var i;const{auth:n}=r(this,on),s=await(typeof n=="function"?n(t):n);s&&((i=e.debug)==null||i.call(e,"Got auth token"),r(this,B).auth=s)},mg=async function(){var c,u,l,m,y,w,b,C,k;if((u=(c=r(this,U)).info)==null||u.call(c,`Starting Zero version: ${this.version}`),r(this,en)===null){(m=(l=r(this,U)).info)==null||m.call(l,"No socket origin provided, not starting connect loop.");return}let e=0;const t=r(this,U),n=()=>{let S=t;return r(this,K)&&(S=yh(r(this,K),S)),S.withContext("runLoopCounter",e)};await p(this,M,Hl).call(this,t);let s=!1,i=!1,o=Gf,a;for(;!this.closed;){e++;let S=n();o=Gf;try{switch(r(this,X)){case Rt:{if(r(this,rs).visibilityState==="hidden"&&(r(this,Ce).setDisconnectedWaitingForVisible(),d(this,at,void 0)),await r(this,rs).waitForVisible(),s&&await p(this,M,Hl).call(this,S,"invalid-token"),N_()||(await p(this,M,cg).call(this,S,a),a=void 0,this.closed))break;g(r(this,K)),S=n(),(y=S.debug)==null||y.call(S,"Connected successfully"),i=!1,s=!1,p(this,M,Jc).call(this,!0);break}case wc:(w=S.error)==null||w.call(S,"unreachable"),i=!0;break;case kr:{const I=new AbortController;d(this,rn,()=>I.abort());const[D,N]=lb(j_,I.signal);d(this,ot,A());const x=0,T=2,E=await wh([D,N,r(this,rs).waitForHidden(),r(this,or).promise,r(this,ot).promise]);if(this.closed){d(this,ot,void 0);break}switch(E){case x:{await p(this,M,wg).call(this,S,r(this,ot).promise)===Af&&(i=!0);break}case T:p(this,M,Ot).call(this,S,{client:"Hidden"}),p(this,M,Jc).call(this,!1);break}d(this,ot,void 0)}}}catch(I){if(r(this,X)!==kr&&((b=S.error)==null||b.call(S,"Failed to connect",I,{lmid:r(this,rr),baseCookie:r(this,er)})),(C=S.debug)==null||C.call(S,"Got an exception in the run loop","state:",r(this,X),"exception:",I),T_(I)){if(!s){s=!0;continue}s=!0}(gd(I)||I instanceof jf||I instanceof zf)&&(i=!0);const D=H_(I);D&&(D.minBackoffMs!==void 0&&(o=Math.max(o,D.minBackoffMs)),D.maxBackoffMs!==void 0&&(o=Math.min(o,D.maxBackoffMs)),a=D.reconnectParams)}i&&(p(this,M,Jc).call(this,!1),(k=S.debug)==null||k.call(S,"Sleeping",o,"ms before reconnecting due to error, state:",r(this,X)),await un(o))}},yg=async function(e,t){var c,u,l,m;g(e.pullVersion===1);const n=r(this,U).withContext("requestID",t);if((c=n.debug)==null||c.call(n,"Pull",e),e.clientGroupID===await this.clientGroupID)return{httpRequestInfo:{errorMessage:"",httpStatusCode:200}};await r(this,Ke).promise;const s=r(this,K);g(s),(u=n.debug)==null||u.call(n,"Pull is for mutation recovery");const i=Et(e.cookie,du),o=["pull",{clientGroupID:e.clientGroupID,cookie:i,requestID:t}];wn(s,o);const a=A();r(this,ir).set(t,a);try{switch(await wh([un(B_),a.promise])){case 0:throw(l=n.debug)==null||l.call(n,"Mutation recovery pull timed out"),new Error("Pull timed out");case 1:{(m=n.debug)==null||m.call(n,"Returning mutation recovery pull response");const C=await a.promise;return{response:{cookie:C.cookie,lastMutationIDChanges:C.lastMutationIDChanges,patch:[]},httpRequestInfo:{errorMessage:"",httpStatusCode:200}}}default:g(!1,"unreachable")}}finally{a.reject("timed out"),r(this,ir).delete(t)}},Jc=function(e){var t;r(this,Yi)!==e&&(d(this,Yi,e),(t=r(this,Ba))==null||t.call(this,e))},wg=async function(e,t){var u,l,m;(u=e.debug)==null||u.call(e,"pinging");const{promise:n,resolve:s}=A();d(this,za,s);const i=["ping",{}],o=performance.now();g(r(this,K)),wn(r(this,K),i);const a=await wh([n,un(z_),t])===0,c=performance.now()-o;return a?((m=e.debug)==null||m.call(e,"ping succeeded in",c,"ms"),E_):((l=e.info)==null||l.call(e,"ping failed in",c,"ms - disconnecting"),p(this,M,Ot).call(this,e,{client:"PingTimeout"}),Af)},vg=async function(e){},Wc=function(e){p(this,M,gg).call(this,e)},gg=function(e){},Sg=function(e){const t={},n=r(this,sr);for(const s of Object.keys(e.tables))t[s]=fv(n,e,s);return t},Wp);async function ex(e,t,n,s,i,o,a,c,u,l,m,y,w,b,C=1024*8,k){var O,H;const S=new URL(Jv(s,`/sync/v${qu}/connect`)),{searchParams:I}=S;if(I.set("clientID",o),I.set("clientGroupID",a),I.set("schemaVersion",c.toString()),I.set("userID",u),I.set("baseCookie",i===null?"":String(i)),I.set("ts",String(performance.now())),I.set("lmid",String(m)),I.set("wsid",y),w&&I.set("debugPerf","true"),k)for(const P in k)I.has(P)?(O=b.warn)==null||O.call(b,`skipping conflicting parameter ${P}`):I.set(P,k[P]);(H=b.info)==null||H.call(b,"Connecting to",S.toString());const D=Ql("WebSocket"),N=e.query(P=>t.getQueriesPatch(P));let x=await n.getDeletedClients(),T=await N,E=Df(["initConnection",{desiredQueriesPatch:[...T.values()],deleted:Ll(x)}],l);return E.length>C?(E=Df(void 0,l),T=void 0):x=void 0,[new D(S.toString(),E),T,Ll(x)]}function wu(e){return e&&e.length>0?e:void 0}function Ll(e){if(!e)return;const{clientIDs:t,clientGroupIDs:n}=e;if((!t||t.length===0)&&(!n||n.length===0))return;const s={};return s.clientIDs=wu(t),s.clientGroupIDs=wu(n),s}function yh({url:e},t){const n=new URL(e).searchParams.get("wsid")??Tv();return Al(n,t)}function Al(e,t){return t.withContext("wsid",e)}function wh(e){return Promise.race(e.map((t,n)=>t.then(()=>n)))}var jf=class extends Error{constructor(e){super(`${e} timed out`)}},zf=class extends Error{};const cc=oc("users").columns({id:re(),name:re(),username:re(),githubId:re()}).primaryKey("id"),Qu=oc("chat_access").columns({id:re(),chatId:re(),userId:re(),write:rl()}).primaryKey("id"),uc=oc("chats").columns({id:re(),title:re(),description:re().optional(),public:rl(),locked:rl(),userId:re(),createdAt:lu(),updatedAt:lu()}).primaryKey("id"),hc=oc("messages").columns({id:re(),chatId:re(),userId:re().optional(),role:BI(),createdAt:lu()}).primaryKey("id"),Sd=oc("message_chunks").columns({messageId:re(),index:lu(),content:re()}).primaryKey("messageId","index"),tx=rc(cc,({many:e})=>({chats:e({sourceField:["id"],destField:["userId"],destSchema:uc}),messages:e({sourceField:["id"],destField:["userId"],destSchema:hc}),chatAccess:e({sourceField:["id"],destField:["userId"],destSchema:Qu})})),nx=rc(Qu,({one:e})=>({chat:e({sourceField:["chatId"],destField:["id"],destSchema:uc}),user:e({sourceField:["userId"],destField:["id"],destSchema:cc})})),sx=rc(uc,({many:e,one:t})=>({messages:e({sourceField:["id"],destField:["chatId"],destSchema:hc}),chatAccess:e({sourceField:["id"],destField:["chatId"],destSchema:Qu}),user:t({sourceField:["userId"],destField:["id"],destSchema:cc})})),ix=rc(hc,({one:e,many:t})=>({chat:e({sourceField:["chatId"],destField:["id"],destSchema:uc}),user:e({sourceField:["userId"],destField:["id"],destSchema:cc}),chunks:t({sourceField:["id"],destField:["messageId"],destSchema:Sd})})),rx=rc(Sd,({one:e})=>({message:e({sourceField:["messageId"],destField:["id"],destSchema:hc})})),bg=qI(1,{tables:[uc,hc,Qu,cc,Sd],relationships:[sx,ix,nx,tx,rx]});function bd(e,t){return t.cmp("userId",e.sub)}function kd(e,t){return t.or(t.exists("chatAccess",n=>n.where("userId",e.sub)),bd(e,t),t.cmp("public",!0))}function Pr(e,t){return t.and(t.cmp("locked",!1),t.or(t.exists("chatAccess",n=>n.where("userId",e.sub).where("write",!0)),bd(e,t)))}function ox(e,t){return t.exists("chat",n=>n.where(s=>kd(e,s)))}function Sc(e,t){return t.exists("chat",n=>n.where(s=>Pr(e,s)))}function bc(e,t){return t.exists("chat",n=>n.where(s=>Pr(e,s)))}function kg(e,t){return t.exists("chat",n=>n.where(s=>kd(e,s)))}function ax(e,t){return t.exists("message",n=>n.where(s=>kg(e,s)))}function cx(e,t){return t.exists("message",n=>n.where(s=>s.and(s.cmp("userId",e.sub),s.exists("chat",i=>i.where("locked",!1)))))}oD(bg,()=>({users:{row:{select:Cf,insert:Cf,update:{preMutation:Ss,postMutation:Ss},delete:Ss}},chats:{row:{select:[kd],insert:[Pr],update:{preMutation:[Pr],postMutation:[Pr]},delete:[bd]}},chat_access:{row:{select:[ox],insert:[Sc],update:{preMutation:[Sc],postMutation:[Sc]},delete:[Sc]}},messages:{row:{select:[kg],insert:[bc],update:{preMutation:[bc],postMutation:[bc]},delete:[bc]}},message_chunks:{row:{select:[ax],insert:[cx],update:{preMutation:Ss,postMutation:Ss},delete:Ss}}}));var Wa;class ux{constructor(t){h(this,Wa,Xc(null));this.build(t)}get current(){return Lr(r(this,Wa))}set current(t){Hr(r(this,Wa),Ar(t))}build(t){this.current=new Z_(t)}close(){this.current.close()}}Wa=new WeakMap;const hx=Object.prototype.hasOwnProperty,lx=Object.hasOwn||((e,t)=>hx.call(e,t));function dx(e){return Fl(e,[])}function Fl(e,t){switch(typeof e){case"boolean":case"number":case"string":case"undefined":return e;case"object":{if(e===null)return null;if(t.includes(e))throw new Error("Cyclic object");if(t.push(e),Array.isArray(e)){const s=e.map(i=>Fl(i,t));return t.pop(),s}const n={};for(const s in e)if(lx(e,s)){const i=e[s];i!==void 0&&(n[s]=Fl(i,t))}return t.pop(),n}default:throw new Error(`Invalid type: ${typeof e}`)}}const fx=[],Bf={singular:[void 0,{type:"unknown"}],plural:[fx,{type:"unknown"}]};function Ig(e){return e?Bf.singular:Bf.plural}var Ct,cr,Xa,xu,Mu,Cg;class Kf{constructor(t,n,s){h(this,Mu);v(this,"query");v(this,"onMaterialized");v(this,"onDematerialized");h(this,Ct);h(this,cr);h(this,Xa);h(this,xu,(t,n,s)=>{const i=t===void 0?t:dx(t);d(this,cr,[i,{type:n}]),s()});this.query=t,this.onMaterialized=n,this.onDematerialized=s,d(this,cr,Ig(t.format.singular)),d(this,Xa,Fg(i=>(p(this,Mu,Cg).call(this),r(this,Ct)&&r(this,Ct).addListener((o,a)=>r(this,xu).call(this,o,a,i)),()=>{var o;(o=r(this,Ct))==null||o.destroy(),d(this,Ct,void 0),this.onDematerialized()})))}get current(){return r(this,Xa).call(this),r(this,cr)}}Ct=new WeakMap,cr=new WeakMap,Xa=new WeakMap,xu=new WeakMap,Mu=new WeakSet,Cg=function(){r(this,Ct)||(d(this,Ct,this.query.materialize()),this.onMaterialized(this))};var an;class px{constructor(){h(this,an,new Map)}getView(t,n,s=!0){if(!s)return new Kf(n,()=>{},()=>{});const i=n.hash()+t;let o=r(this,an).get(i);return o||(o=new Kf(n,a=>{const c=r(this,an).get(i);if(c&&c!==a)throw new Error("View already exists");r(this,an).set(i,a)},()=>r(this,an).delete(i)),r(this,an).set(i,o)),o}}an=new WeakMap;const mx=new px;var Ya,Za,ur;class Uf{constructor(t,n=!0){h(this,Ya,Xc(null));h(this,Za,Xc(null));h(this,ur);var c;const s=Hg("z"),i=(c=s==null?void 0:s.current)!=null&&c.userID?s==null?void 0:s.current.userID:"anon";d(this,ur,t);const o=Ig(r(this,ur).format.singular);this.current=o[0],this.details=o[1];const a=mx.getView(i,r(this,ur),n);this.current=a.current[0],this.details=a.current[1],tm(()=>{this.current=a.current[0],this.details=a.current[1]})}get current(){return Lr(r(this,Ya))}set current(t){Hr(r(this,Ya),Ar(t))}get details(){return Lr(r(this,Za))}set details(t){Hr(r(this,Za),Ar(t))}}Ya=new WeakMap,Za=new WeakMap,ur=new WeakMap;let Dg="anon";var Xp;const $l=(Xp=document.cookie.split(";").find(e=>e.trim().startsWith("auth=")))==null?void 0:Xp.split("=")[1];if($l)try{Dg=JSON.parse(atob($l.split(".")[1])).sub}catch(e){console.error("Failed to decode JWT token:",e)}const Ex=new ux({userID:Dg,auth:()=>$l,server:$g,schema:bg,kvStore:"idb"});function _x(e){const t=document.createElement("div");t.className="fixed top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white px-4 py-2 rounded-md shadow-lg z-50",t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.classList.add("opacity-0","transition-opacity","duration-300"),setTimeout(()=>document.body.removeChild(t),300)},3e3)}function xx(e,t=!0){let n=Xc(Ar(new Uf(e(),t)));return tm(()=>{Hr(n,Ar(new Uf(e(),t)))}),new Proxy({},{get(s,i){return Lr(n)[i]}})}export{Ix as S,Cx as X,kx as b,_x as s,xx as u,Ex as z};
